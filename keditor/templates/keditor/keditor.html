{% extends 'core/base.html' %}    
{% load static %}    
    
{% block title %}Kids CAD Editor{% endblock %}    
    
{% block extra_css %}    
<link rel="stylesheet" href="{% static 'cad_editor/css/spectrum.css' %}">    
<link rel="stylesheet" href="{% static 'cad_editor/css/style.css' %}">    
<link rel="stylesheet" href="{% static 'cad_editor/css/bootstrap/bootstrap.min.css' %}">  
<link rel="stylesheet" href="{% static 'cad_editor/css/bootstrap/bootstrap-theme.min.css' %}">  
<link rel="stylesheet" href="{% static 'cad_editor/css/blockscad_style.css' %}">
<link rel="stylesheet" href="{% static 'keditor/css/keditor.css' %}">
{% endblock %}    
    
{% block content %}    
  
<!-- Simplified Bootstrap 5 layout without complex flexbox -->  
<div class="container-fluid kids-editor" style="width: none;">  
    <div class="toolbar flex-grow-1 bg-primary p-3 border rounded">  
        <div class="d-flex justify-content-between align-items-center">  
            <h4 class="text-white mb-0">  
                <i class="fas fa-cubes me-2"></i>Kids CAD Editor  
            </h4>  
            <div class="btn-group">  
                <button id="saveBtn" class="btn btn-success">  
                    <i class="fas fa-save me-1"></i>Save  
                </button>  
                <button id="renderBtn" class="btn btn-warning">  
                    <i class="fas fa-play me-1"></i>Build 3D  
                </button>  
                <button id="exportBtn" class="btn btn-info">  
                    <i class="fas fa-download me-1"></i>Download  
                </button>  
            </div>  
        </div>
        <div class="row p-3"> 
            <!-- Left Column: BlocksCAD Workspace Panel -->    
            <div class="col-md-8 d-flex flex-column">    
                <div id="blocklyDiv" style="height: calc(100vh - 200px); width: 100%; min-height: 550px;"></div>    
            </div> 
            <!-- Right Column: 3D Preview + Console -->    
            <div class="col-md-4 d-flex flex-column">  
                <!-- 3D viewport container -->  
                <div class="position-relative border" style="flex: 1; min-height: 400px;">    
                    <div class="resizableDiv" style="height: 100%;">  
                        <div id="renderDiv" style="width: 100%; height: 100%"></div>  
                    </div>  
                      
                    <!-- Controls positioned over 3D viewer -->  
                    <div id="viewerControls" class="position-absolute bottom-0 start-0 p-2 bg-white bg-opacity-75 rounded-end">    
                        <div class="btn-group">      
                            <button id="zInButton" class="btn btn-outline-primary btn-sm">    
                                <i class="fas fa-search-plus"></i><br>Zoom In    
                            </button>    
                            <button id="zOutButton" class="btn btn-outline-primary btn-sm">    
                                <i class="fas fa-search-minus"></i><br>Zoom Out    
                            </button>    
                            <button id="zResetButton" class="btn btn-outline-secondary btn-sm">    
                                <i class="fas fa-home"></i><br>Reset View    
                            </button>    
                            <button id="axesButton" class="btn btn-outline-info btn-sm">    
                                <i class="fas fa-arrows-alt"></i><br>Show Axes    
                            </button>    
                        </div>  
                          
                        <!-- View dropdown menu -->  
                        <select id="viewMenu" class="form-select form-select-sm ms-2" style="width: auto;" title="Change View">      
                            <option value="diagonal">Diagonal</option>      
                            <option value="front">Front</option>      
                            <option value="top">Top</option>      
                            <option value="right">Right</option>      
                            <option value="left">Left</option>      
                            <option value="back">Back</option>      
                            <option value="bottom">Bottom</option>      
                        </select>  
                    </div>          
                </div>  
                  
                <!-- Console Panel - separate from 3D viewer -->    
                <div class="console-panel bg-dark text-light p-3 rounded mt-2" style="height: 150px; flex-shrink: 0;">    
                    <h6 class="text-warning"><i class="fas fa-terminal me-1"></i>Messages</h6>    
                    <div id="consoleOutput" class="overflow-auto" style="height: calc(100% - 30px);">    
                        <div class="text-success">Ready to build! ðŸš€</div>    
                    </div>    
                </div>  
            </div>
        </div>
    </div>
</div>  

  
<!-- Hidden XML storage -->  
<textarea id="blocksXml" style="display: none;">{{ blocks_xml }}</textarea>  
  
<!-- JavaScript Dependencies -->

<!-- Load jQuery FIRST (critical for 'each' method) -->  
<script src="{% static 'cad_editor/js/jquery/jquery-1.11.3.js' %}"></script>  
<script src="{% static 'cad_editor/js/jquery/jquery-ui.min.js' %}"></script>  
  
<!-- Bootstrap 3 JS -->  
<script src="{% static 'cad_editor/js/bootstrap/bootstrap-3.3.4-dist/js/bootstrap.min.js' %}"></script>  


<!-- Load Blockly core -->  
<script src="{% static 'cad_editor/js/closure-library/closure/goog/base.js' %}"></script>
<script src="{% static 'cad_editor/js/blockly/blockly_uncompressed.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks_compressed.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/openscad_compressed.js' %}"></script>  


<script src="{% static 'cad_editor/js/blockscad/msg/js/en.js' %}"></script>
<script src="{% static 'cad_editor/js/blockly/msg/js/en.js' %}"></script>

<!-- Load BlocksCAD files in correct order -->  
<script src="{% static 'cad_editor/js/blockscad/storage.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/utils.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/lightgl.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/csg.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/viewer.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/blockscad.js' %}"></script>
<script src="{% static 'cad_editor/js/jquery/jquery.hammer.js' %}"></script>  
<script src="{% static 'cad_editor/js/jquery/jquery.ui.touch-punch.min.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/toolbox.js' %}"></script>
<script src="{% static 'cad_editor/js/blockly/blocks/blockscad_changes.js' %}"></script>  

<script>  
// Initialize BlocksCAD for kids  
let workspace;  
let viewer; 


function initViewer() {  
    // Initialize BlocksCAD globals FIRST (critical)  
    Blockscad.picSize = [450, 450];  
    Blockscad.rpicSize = [250, 250];  
    Blockscad.picQuality = 0.85;  
    Blockscad.numRotPics = 13;  
    Blockscad.drawAxes = 1;  // Enable axes/grid  
    Blockscad.resolution = 1;  
  
    const renderDiv = document.getElementById('renderDiv');  
  
    // Ensure Hammer.js is loaded before initializing viewer  
    if (typeof $.fn.hammer === 'undefined') {  
        console.error('Error: Hammer.js jQuery plugin not loaded');  
        return;  
    }  
  
    // Verify the container exists and has dimensions  
    if (!renderDiv) {  
        console.error('Error: renderDiv not found');  
        return;  
    }  
          
    // Ensure container has proper dimensions  
    if (renderDiv.offsetWidth === 0 || renderDiv.offsetHeight === 0) {  
        renderDiv.style.width = '100%';  
        renderDiv.style.height = '100%';  
        renderDiv.style.minHeight = '400px';  
    }  
          
    try {  
        // Create viewer directly instead of processor to avoid snapshot DOM issues  
        viewer = new Blockscad.Viewer(  
            renderDiv,   
            renderDiv.offsetWidth,   
            renderDiv.offsetHeight,   
            100 // initial distance  
        );  
            
        // Configure viewer settings  
        viewer.plate = true;  // Enable grid plate  
        viewer.onDraw();      // Force initial draw  
            
        console.log('3D viewer initialized successfully');  
              
    } catch (e) {  
        console.error('3D viewer error: ' + e.message);  
    }  
}

document.addEventListener('DOMContentLoaded', function() {  
    // Initialize BlocksCAD globals FIRST (critical)  
    if (typeof Blockscad === 'undefined') {  
        window.Blockscad = {};  
        Blockscad.Toolbox = {};  
        Blockscad.Msg = {};  
    }  
      
    // Set BlocksCAD configuration  
    Blockscad.picSize = [450, 450];  
    Blockscad.rpicSize = [250, 250];  
    Blockscad.picQuality = 0.85;  
    Blockscad.numRotPics = 13;  
    Blockscad.drawAxes = 1;  // Enable axes/grid  
    Blockscad.resolution = 1;  
      
    // Wait for all dependencies to load  
    setTimeout(function() {  
        // CRITICAL: Create toolbox before workspace injection  
        if (typeof Blockscad.Toolbox.createToolbox === 'function') {  
            Blockscad.Toolbox.createToolbox();  
            console.log('Toolbox created successfully');  
        } else {  
            console.error('Blockscad.Toolbox.createToolbox not available');  
            return;  
        }  
          
        // Verify toolbox content exists  
        if (!Blockscad.Toolbox.adv) {  
            console.error('Blockscad.Toolbox.adv not available');  
            return;  
        }  
          
        // Initialize workspace with BlocksCAD's advanced toolbox  
        workspace = Blockly.inject('blocklyDiv', {  
            media: '{% static "cad_editor/js/blockly/media/" %}',  
            toolbox: Blockscad.Toolbox.adv, // Use BlocksCAD's advanced toolbox  
            zoom: {  
                controls: true,  
                wheel: true,  
                startScale: 1.0,  
                maxScale: 3,  
                minScale: 0.3,  
                scaleSpeed: 1.2  
            },  
            trashcan: true, // Enable trashcan for drag-to-delete functionality  
            sounds: false,  
            scrollbars: true,  
            grid: {  
                spacing: 20,  
                length: 3,  
                colour: '#ccc',  
                snap: true  
            }  
        });  
          
        // Set color scheme and category colors  
        if (typeof Blockscad.Toolbox.setColorScheme === 'function') {  
            Blockscad.Toolbox.setColorScheme(Blockscad.Toolbox.colorScheme['one']);  
            Blockscad.Toolbox.setCatColors();  
            console.log('Color scheme applied');  
        }  
        
        // Override the resize function to maintain positioning  
        const originalResize = workspace.resize;  
        workspace.resize = function() {  
            originalResize.call(this);  
            fixToolboxPosition(); // Reapply our positioning after resize  
        };


        // CRITICAL: Record delete areas after workspace initialization  
        workspace.recordDeleteAreas();  
        console.log('Delete areas recorded');  
          
        // Debug delete areas to verify they're working  
        setTimeout(() => {  
            if (workspace.trashcan) {  
                const rect = workspace.trashcan.getClientRect();  
                console.log('Trashcan delete area:', rect);  
                console.log('Trashcan SVG position:', workspace.trashcan.svgGroup_.getBoundingClientRect());  
                console.log('Delete area trash:', workspace.deleteAreaTrash_);  
                console.log('Delete area toolbox:', workspace.deleteAreaToolbox_);  
            }  
        }, 1000);  
          
        // Initialize viewer with direct approach (no processor)  
        initViewer();  
        setupEventHandlers();  
          
        showMessage('Kids CAD Editor ready! ðŸš€', 'success');  
        console.log('Workspace initialized with toolbox and delete areas');  
    }, 2000);  
});

function setupEventHandlers() {  
    // Save project  
    document.getElementById('saveBtn').addEventListener('click', function() {  
        const xml = Blockly.Xml.workspaceToDom(workspace);  
        const blocksXml = Blockly.Xml.domToText(xml);  
        const openscadCode = Blockly.OpenSCAD.workspaceToCode(workspace);  
          
        fetch('/keditor/save/', {  
            method: 'POST',  
            headers: {  
                'Content-Type': 'application/json',  
                'X-CSRFToken': getCookie('csrftoken')  
            },  
            body: JSON.stringify({  
                project_id: {{ project.id|default:'null' }},  
                blocks_xml: blocksXml,  
                openscad_code: openscadCode,  
                name: 'My CAD Project'  
            })  
        })  
        .then(response => response.json())  
        .then(data => {  
            if (data.success) {  
                showMessage('Project saved! ðŸ’¾', 'success');  
            } else {  
                showMessage('Save failed! ðŸ˜ž', 'error');  
            }  
        });  
    });  
      
    // Render 3D    
    document.getElementById('renderBtn').addEventListener('click', function() {  
        const xml = Blockly.Xml.workspaceToDom(workspace);  
        const blocksXml = Blockly.Xml.domToText(xml);  
          
        showMessage('Building your 3D model... ðŸ”¨', 'info');  
          
        fetch('/keditor/render/', {  
            method: 'POST',  
            headers: {  
                'Content-Type': 'application/json',  
                'X-CSRFToken': getCookie('csrftoken')  
            },  
            body: JSON.stringify({  
                project_id: {{ project.id|default:'null' }},  
                blocks_xml: blocksXml  
            })  
        })  
        .then(response => response.json())  
        .then(data => {  
            if (data.success) {  
                showMessage('3D model built successfully! ðŸŽ‰', 'success');  
                if (processor && data.result) {  
                    processor.setBlockscad(data.result);  
                }  
            } else {  
                showMessage('Build failed: ' + data.error, 'error');  
            }  
        });  
    });  

    // Export STL  
    document.getElementById('exportBtn').addEventListener('click', function() {  
        if (processor && processor.viewer) {  
            const stlData = processor.generateSTL();  
            downloadSTL(stlData, 'kids_project.stl');  
            showMessage('STL downloaded! ðŸ“', 'success');  
        } else {  
            showMessage('Please build your 3D model first! ðŸ”¨', 'warning');  
        }  
    });  

    document.getElementById('zInButton').addEventListener('click', () => {
        if (viewer) {
            viewer.zoomIn();
            showMessage('Zoomed in! ðŸ”', 'info');
        } else {
            showMessage('3D viewer not ready', 'error');
        }
    });

    document.getElementById('zOutButton').addEventListener('click', () => {
        if (viewer) {
            viewer.zoomOut();
            showMessage('Zoomed out! ðŸ”', 'info');
        } else {
            showMessage('3D viewer not ready', 'error');
        }
    });

    document.getElementById('zResetButton').addEventListener('click', () => {  
        if (viewer) {  
            // Get the currently selected view from dropdown, or default to diagonal  
            const selectedView = document.getElementById('viewMenu') ?   
                               document.getElementById('viewMenu').value : 'diagonal';  
            viewer.viewReset(selectedView);  
            showMessage('View reset to ' + selectedView + '! ðŸ ', 'info');  
        } else {  
            showMessage('3D viewer not ready', 'error');  
        }  
    });

    document.getElementById('axesButton').addEventListener('click', () => {
        if (viewer) {
            Blockscad.drawAxes = Blockscad.drawAxes ? 0 : 1;
            viewer.onDraw(); // Force redraw
            showMessage('Axes ' + (Blockscad.drawAxes ? 'enabled' : 'disabled'), 'info');
        } else {
            showMessage('3D viewer not ready', 'error');
        }
    });
    document.getElementById('viewMenu').addEventListener('change', function() {
        if (viewer) {
            const view = this.value;
            viewer.viewReset(view);  // Pass view parameter
            showMessage('View changed to ' + view, 'info');
        } else {
            showMessage('3D viewer not ready', 'error');
        }
    });

    // Debug function to check delete areas
    function debugDeleteAreas() {
        if (workspace && workspace.trashcan) {
            console.log('Trashcan exists:', !!workspace.trashcan);
            console.log('Delete area trash:', workspace.deleteAreaTrash_);
            console.log('Delete area toolbox:', workspace.deleteAreaToolbox_);

            // Force record delete areas
            workspace.recordDeleteAreas();
            console.log('After recording - Delete area trash:', workspace.deleteAreaTrash_);
        }
    }

    // Call this after workspace initialization
    setTimeout(debugDeleteAreas, 3000);
}  

// Override toolbox positioning after workspace creation  
function fixToolboxPosition() {  
    if (workspace && workspace.toolbox_) {  
        const toolboxDiv = workspace.toolbox_.HtmlDiv;  
        if (toolboxDiv) {  
            // Override the JavaScript positioning  
            toolboxDiv.style.top = '150px';  
            toolboxDiv.style.position = 'absolute';  
            toolboxDiv.style.left = '150px';  
              
            // Also fix flyout positioning  
            if (workspace.toolbox_.flyout_) {  
                const flyoutSvg = workspace.toolbox_.flyout_.svgGroup_;  
                if (flyoutSvg) {  
                    flyoutSvg.setAttribute('transform', 'translate(200, 150)');  
                }  
            }  
        }  
    }  
      
    // Force record delete areas after positioning  
    if (workspace) {  
        workspace.recordDeleteAreas();  
        console.log('Delete areas recorded:', {  
            trash: workspace.deleteAreaTrash_,  
            toolbox: workspace.deleteAreaToolbox_  
        });  
    }  
}  
  
// Call after workspace initialization and on resize  
setTimeout(fixToolboxPosition, 100);  
window.addEventListener('resize', fixToolboxPosition);

// Override the onMouseUp handler to debug and fix deletion  
function fixBlockDeletion() {  
    const originalOnMouseUp = Blockly.BlockSvg.prototype.onMouseUp_;  
      
    Blockly.BlockSvg.prototype.onMouseUp_ = function(e) {  
        console.log('Mouse up on block:', this.type);  
        console.log('Block parent:', this.getParent());  
        console.log('Block deletable:', Blockly.selected ? Blockly.selected.isDeletable() : 'No selection');  
        console.log('Is delete area:', this.workspace.isDeleteArea(e));  
          
        // Call original handler first  
        originalOnMouseUp.call(this, e);  
          
        // Additional check for deletion if original failed  
        if (!this.getParent() && Blockly.selected &&   
            Blockly.selected.isDeletable() && this.workspace.isDeleteArea(e)) {  
            console.log('Forcing block deletion');  
              
            // Ensure proper event grouping  
            if (!Blockly.Events.getGroup()) {  
                Blockly.Events.setGroup(true);  
            }  
              
            // Force disposal with animation  
            Blockly.selected.dispose(false, true);  
              
            // Close trashcan  
            if (this.workspace.trashcan) {  
                this.workspace.trashcan.close();  
            }  
              
            Blockly.Events.setGroup(false);  
        }  
    };  
}  
  
// Apply the fix after workspace initialization  
setTimeout(fixBlockDeletion, 100);

// Utility functions  
function showMessage(message, type = 'info') {  
    const console = document.getElementById('consoleOutput');  
    const div = document.createElement('div');  
    div.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;  
    div.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;  
    console.appendChild(div);  
    console.scrollTop = console.scrollHeight;  
      
    // Auto-remove messages after 5 seconds  
    setTimeout(() => {  
        if (div.parentNode) {  
            div.parentNode.removeChild(div);  
        }  
    }, 5000);  
}  
  
function getCookie(name) {  
    let cookieValue = null;  
    if (document.cookie && document.cookie !== '') {  
        const cookies = document.cookie.split(';');  
        for (let i = 0; i < cookies.length; i++) {  
            const cookie = cookies[i].trim();  
            if (cookie.substring(0, name.length + 1) === (name + '=')) {  
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));  
                break;  
            }  
        }  
    }  
    return cookieValue;  
}  
  
function downloadSTL(stlData, filename) {  
    const blob = new Blob([stlData], { type: 'application/octet-stream' });  
    const url = URL.createObjectURL(blob);  
    const a = document.createElement('a');  
    a.href = url;  
    a.download = filename;  
    document.body.appendChild(a);  
    a.click();  
    document.body.removeChild(a);  
    URL.revokeObjectURL(url);  
}  

function debugBlocksCAD() {  
    console.log('Blockly available:', typeof Blockly !== 'undefined');  
    console.log('Blockscad available:', typeof Blockscad !== 'undefined');  
    console.log('Workspace:', workspace);  
    console.log('Processor:', processor);  
    console.log('RenderDiv:', document.getElementById('renderDiv'));  
    console.log('Toolbox:', document.getElementById('toolbox'));  
}  
  
// Call this after initialization  
setTimeout(debugBlocksCAD, 1000);

</script>  
  
{% endblock %}
