{% extends 'core/base.html' %}    
{% load static %}    
    
{% block title %}Kids CAD Editor{% endblock %}    
    
{% block extra_css %}    
<link rel="stylesheet" href="{% static 'cad_editor/css/spectrum.css' %}">    
<link rel="stylesheet" href="{% static 'cad_editor/css/style.css' %}">    
<link rel="stylesheet" href="{% static 'keditor/css/keditor.css' %}">  
{% endblock %}    
    
{% block content %}    
  
<!-- Simplified Bootstrap 5 layout without complex flexbox -->  
<div class="container-fluid kids-editor" style="width: none;">  
    <div class="toolbar flex-grow-1 bg-primary p-3 border rounded-top">  
        <div class="d-flex justify-content-between align-items-center">  
            <h4 class="text-white mb-0">  
                <i class="fas fa-cubes me-2"></i>Kids CAD Editor  
            </h4>  
            <div class="btn-group">  
                <button id="saveBtn" class="btn btn-success">  
                    <i class="fas fa-save me-1"></i>Save  
                </button>  
                <button id="renderBtn" class="btn btn-warning">  
                    <i class="fas fa-play me-1"></i>Build 3D  
                </button>  
                <button id="exportBtn" class="btn btn-info">  
                    <i class="fas fa-download me-1"></i>Download  
                </button>  
            </div>  
        </div>
    </div>
    <div class="row border border-bottom"> 
        <!-- Left Column: BlocksCAD Workspace Panel -->  
        <div class="col-lg-8 d-flex flex-column">  
            <div id="blocklyDiv" style="height: 600px; width: 100%;"></div>  
        </div>  
          
        <!-- Right Column 3D Preview Panel -->  
        <div class="col-lg-5 d-flex flex-column">
            <div class="preview-panel flex-grow-1 border position-relative">  
                <!-- 3D viewport -->  
                <div id="renderDiv" style="width: 100%; height: 100%"></div>  
                <!-- Controls -->
                <div id="viewerControls" class="position-absolute bottom-0 start-0 p-2 bg-white bg-opacity-75 rounded-end">  
                    <div class="btn-group">    
                        <button id="zInButton" class="btn btn-outline-primary">  
                            <i class="fas fa-search-plus"></i><br>Zoom In  
                        </button>  
                        <button id="zOutButton" class="btn btn-outline-primary">  
                            <i class="fas fa-search-minus"></i><br>Zoom Out  
                        </button>  
                        <button id="zResetButton" class="btn btn-outline-secondary">  
                            <i class="fas fa-home"></i><br>Reset View  
                        </button>  
                        <button id="axesButton" class="btn btn-outline-info">  
                            <i class="fas fa-arrows-alt"></i><br>Show Axes  
                        </button>  
                    </div>  
                </div>  
            </div>  
                
            <!-- Console Panel -->  
            <div class="console-panel bg-dark text-light p-3 rounded m-2" style="height: 30%;">  
                <h6 class="text-warning"><i class="fas fa-terminal me-1"></i>Messages</h6>  
                <div id="consoleOutput" class="overflow-auto h-75">  
                    <div class="text-success">Ready to build! üöÄ</div>  
                </div>  
            </div>  
        </div>  
    </div>  
</div>  

<script src="{% static 'cad_editor/js/blockly/blocks/colour.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/geom_set_ops.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/lists.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/logic.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/loops.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/math.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/primitives.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/procedures.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/text.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks/variables.js' %}"></script>

<xml id="toolbox" style="display: none">  
  <category name="üü¶ Shapes" colour="210">  
    <block type="cube"></block>  
    <block type="sphere"></block>  
    <block type="cylinder"></block>  
  </category>  
  <category name="üîÑ Move & Turn" colour="120">  
    <block type="translate"></block>  
    <block type="rotate"></block>  
    <block type="scale"></block>  
  </category>  
  <category name="‚ûï Combine" colour="45">  
    <block type="union"></block>  
    <block type="difference"></block>  
    <block type="intersection"></block>  
  </category>  
  <category name="üé® Colors" colour="300">  
    <block type="color"></block>  
  </category>  
  <category name="üî¢ Numbers" colour="230">  
    <block type="math_number"></block>  
    <block type="math_arithmetic"></block>  
  </category>  
</xml>  
  
<!-- Hidden XML storage -->  
<textarea id="blocksXml" style="display: none;">{{ blocks_xml }}</textarea>  
  
<!-- JavaScript Dependencies -->  
  
<!-- Load jQuery FIRST (critical for 'each' method) -->  
<script src="{% static 'cad_editor/js/jquery/jquery-1.11.3.js' %}"></script>  
<script src="{% static 'cad_editor/js/jquery/jquery-ui.min.js' %}"></script>  
  
<!-- Load Blockly core -->  
<script src="{% static 'cad_editor/js/blockly/blockly_compressed.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks_compressed.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/openscad_compressed.js' %}"></script>  
  
<!-- Load BlocksCAD files in correct order -->  
<script src="{% static 'cad_editor/js/blockscad/storage.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/utils.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/lightgl.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/csg.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/viewer.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/blockscad.js' %}"></script>
<script src="{% static 'cad_editor/js/jquery/jquery.hammer.js' %}"></script>


<script>  
// Initialize BlocksCAD for kids  
let workspace;  
let processor;  


function initViewer() {  
    const renderDiv = document.getElementById('renderDiv');  
    if (renderDiv && typeof Blockscad !== 'undefined' && typeof Blockscad.Processor !== 'undefined') {  
        processor = new Blockscad.Processor(renderDiv);  
    } else {  
        console.error('Failed to initialize viewer - missing dependencies');  
    }  
}

document.addEventListener('DOMContentLoaded', function() {  
    // Initialize BlocksCAD globals FIRST  
    if (typeof Blockscad === 'undefined') {  
        window.Blockscad = {};  
        Blockscad.Toolbox = {};  
    }  
      
    Blockscad.picSize = [450, 450];  
    Blockscad.rpicSize = [250, 250];  
    Blockscad.picQuality = 0.85;  
    Blockscad.numRotPics = 13;  
    Blockscad.drawAxes = 1;  
    Blockscad.resolution = 1;  
      
    // Wait for all dependencies to load  
    setTimeout(function() {  
        // CRITICAL: Create toolbox before workspace injection  
        if (typeof Blockscad.Toolbox.createToolbox === 'function') {  
            Blockscad.Toolbox.createToolbox();  
        }  
          
        // Initialize workspace with BlocksCAD's advanced toolbox  
        workspace = Blockly.inject('blocklyDiv', {  
            media: '{% static "cad_editor/js/blockly/media/" %}',  
            toolbox: Blockscad.Toolbox.adv, // Use BlocksCAD's toolbox, not DOM element  
            zoom: {  
                controls: true,  
                wheel: true,  
                startScale: 1.0,  
                maxScale: 3,  
                minScale: 0.3,  
                scaleSpeed: 1.2  
            },  
            trashcan: false,  
            sounds: false  
        });  
          
        // Set color scheme and category colors  
        if (typeof Blockscad.Toolbox.setColorScheme === 'function') {  
            Blockscad.Toolbox.setColorScheme(Blockscad.Toolbox.colorScheme['one']);  
            Blockscad.Toolbox.setCatColors();  
        }  
          
        initViewer();  
        setupEventHandlers();  
    }, 2000);  
});


function setupEventHandlers() {  
    // Save project  
    document.getElementById('saveBtn').addEventListener('click', function() {  
        const xml = Blockly.Xml.workspaceToDom(workspace);  
        const blocksXml = Blockly.Xml.domToText(xml);  
        const openscadCode = Blockly.OpenSCAD.workspaceToCode(workspace);  
          
        fetch('/keditor/save/', {  
            method: 'POST',  
            headers: {  
                'Content-Type': 'application/json',  
                'X-CSRFToken': getCookie('csrftoken')  
            },  
            body: JSON.stringify({  
                project_id: {{ project.id|default:'null' }},  
                blocks_xml: blocksXml,  
                openscad_code: openscadCode,  
                name: 'My CAD Project'  
            })  
        })  
        .then(response => response.json())  
        .then(data => {  
            if (data.success) {  
                showMessage('Project saved! üíæ', 'success');  
            } else {  
                showMessage('Save failed! üòû', 'error');  
            }  
        });  
    });  
      
    // Render 3D  
    document.getElementById('renderBtn').addEventListener('click', function() {  
        const xml = Blockly.Xml.workspaceToDom(workspace);  
        const blocksXml = Blockly.Xml.domToText(xml);  
          
        showMessage('Building your 3D model... üî®', 'info');  
          
        fetch('/keditor/render/', {  
            method: 'POST',  
            headers: {  
                'Content-Type': 'application/json',  
                'X-CSRFToken': getCookie('csrftoken')  
            },  
            body: JSON.stringify({  
                project_id: {{ project.id|default:'null' }},  
                blocks_xml: blocksXml  
            })  
        })  
        .then(response => response.json())  
        .then(data => {  
            if (data.success) {  
                showMessage('3D model built successfully! üéâ', 'success');  
                if (processor && data.result) {  
                    processor.setBlockscad(data.result);  
                }  
            } else {  
                showMessage('Build failed: ' + data.error, 'error');  
            }  
        });  
    });  
      
    // Export STL  
    document.getElementById('exportBtn').addEventListener('click', function() {  
        if (processor && processor.viewer) {  
            const stlData = processor.generateSTL();  
            downloadSTL(stlData, 'kids_project.stl');  
            showMessage('STL downloaded! üìÅ', 'success');  
        } else {  
            showMessage('Please build your 3D model first! üî®', 'warning');  
        }  
    });  
      
    // 3D viewer controls  
    document.getElementById('zInButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.zoomIn();  
            showMessage('Zoomed in! üîç', 'info');  
        }  
    });  
      
    document.getElementById('zOutButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.zoomOut();  
            showMessage('Zoomed out! üîç', 'info');  
        }  
    });  
      
    document.getElementById('zResetButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.viewReset();  
            showMessage('View reset! üè†', 'info');  
        }  
    });  
      
    document.getElementById('axesButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.toggleAxes();  
            showMessage('Axes toggled! üìê', 'info');  
        }  
    });  
}  
  
// Utility functions  
function showMessage(message, type = 'info') {  
    const console = document.getElementById('consoleOutput');  
    const div = document.createElement('div');  
    div.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;  
    div.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;  
    console.appendChild(div);  
    console.scrollTop = console.scrollHeight;  
      
    // Auto-remove messages after 5 seconds  
    setTimeout(() => {  
        if (div.parentNode) {  
            div.parentNode.removeChild(div);  
        }  
    }, 5000);  
}  
  
function getCookie(name) {  
    let cookieValue = null;  
    if (document.cookie && document.cookie !== '') {  
        const cookies = document.cookie.split(';');  
        for (let i = 0; i < cookies.length; i++) {  
            const cookie = cookies[i].trim();  
            if (cookie.substring(0, name.length + 1) === (name + '=')) {  
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));  
                break;  
            }  
        }  
    }  
    return cookieValue;  
}  
  
function downloadSTL(stlData, filename) {  
    const blob = new Blob([stlData], { type: 'application/octet-stream' });  
    const url = URL.createObjectURL(blob);  
    const a = document.createElement('a');  
    a.href = url;  
    a.download = filename;  
    document.body.appendChild(a);  
    a.click();  
    document.body.removeChild(a);  
    URL.revokeObjectURL(url);  
}  

function debugBlocksCAD() {  
    console.log('Blockly available:', typeof Blockly !== 'undefined');  
    console.log('Blockscad available:', typeof Blockscad !== 'undefined');  
    console.log('Workspace:', workspace);  
    console.log('Processor:', processor);  
    console.log('RenderDiv:', document.getElementById('renderDiv'));  
    console.log('Toolbox:', document.getElementById('toolbox'));  
}  
  
// Call this after initialization  
setTimeout(debugBlocksCAD, 1000);

</script>  
  
{% endblock %}
