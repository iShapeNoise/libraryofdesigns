 {% extends 'core/base.html' %}    
{% load static %}    
    
{% block title %}Kids CAD Editor{% endblock %}    
    
{% block extra_css %}    
<link rel="stylesheet" href="{% static 'cad_editor/css/spectrum.css' %}">    
<link rel="stylesheet" href="{% static 'cad_editor/css/style.css' %}">    
<link rel="stylesheet" href="{% static 'keditor/css/keditor.css' %}">  
{% endblock %}    
    
{% block content %}    
  
<!-- Simplified Bootstrap 5 layout without complex flexbox -->  
<div class="container-fluid kids-editor">  
    <div class="row">  
        <!-- BlocksCAD Workspace Panel -->  
        <div class="col-lg-8">  
            <div class="toolbar bg-primary p-3 border-bottom">  
                <div class="d-flex justify-content-between align-items-center">  
                    <h4 class="text-white mb-0">  
                        <i class="fas fa-cubes me-2"></i>Kids CAD Editor  
                    </h4>  
                    <div class="btn-group">  
                        <button id="saveBtn" class="btn btn-success btn-lg">  
                            <i class="fas fa-save me-1"></i>Save  
                        </button>  
                        <button id="renderBtn" class="btn btn-warning btn-lg">  
                            <i class="fas fa-play me-1"></i>Build 3D  
                        </button>  
                        <button id="exportBtn" class="btn btn-info btn-lg">  
                            <i class="fas fa-download me-1"></i>Download  
                        </button>  
                    </div>  
                </div>  
            </div>  
            <!-- Fixed height instead of flexbox -->  
            <div id="blocklyDiv" style="height: 600px; width: 100%;"></div>  
        </div>  
          
        <!-- 3D Preview Panel -->  
        <div class="col-lg-4">  
            <div class="preview-panel border rounded m-2">  
                <div class="bg-dark text-white p-2 rounded-top">  
                    <h6 class="mb-0"><i class="fas fa-cube me-1"></i>3D Preview</h6>  
                </div>  
                <!-- Fixed height for 3D viewport -->  
                <div id="renderDiv" style="height: 400px;"></div>  
                  
                <!-- Kid-friendly Controls -->  
                <div id="viewerControls" class="p-3 bg-white">  
                    <div class="row g-2">  
                        <div class="col-6">  
                            <button id="zInButton" class="btn btn-outline-primary btn-lg w-100">  
                                <i class="fas fa-search-plus"></i><br>Zoom In  
                            </button>  
                        </div>  
                        <div class="col-6">  
                            <button id="zOutButton" class="btn btn-outline-primary btn-lg w-100">  
                                <i class="fas fa-search-minus"></i><br>Zoom Out  
                            </button>  
                        </div>
                        <div class="col-6">  
                            <button id="zResetButton" class="btn btn-outline-secondary btn-lg w-100">  
                                <i class="fas fa-home"></i><br>Reset View  
                            </button>  
                        </div>
                        <div class="col-6">  
                            <button id="axesButton" class="btn btn-outline-info btn-lg w-100">  
                                <i class="fas fa-arrows-alt"></i><br>Show Axes  
                            </button>  
                        </div>  
                    </div>  
                </div>  
            </div>  
                
            <!-- Console Panel -->  
            <div class="console-panel bg-dark text-light p-3 rounded m-2" style="height: 30%;">  
                <h6 class="text-warning"><i class="fas fa-terminal me-1"></i>Messages</h6>  
                <div id="consoleOutput" class="overflow-auto h-75">  
                    <div class="text-success">Ready to build! üöÄ</div>  
                </div>  
            </div>  
        </div>  
    </div>  
</div>  
  
<xml id="toolbox" style="display: none">  
  <category name="üü¶ Shapes" colour="210">  
    <block type="cube"></block>  
    <block type="sphere"></block>  
    <block type="cylinder"></block>  
  </category>  
  <category name="üîÑ Move & Turn" colour="120">  
    <block type="translate"></block>  
    <block type="rotate"></block>  
    <block type="scale"></block>  
  </category>  
  <category name="‚ûï Combine" colour="45">  
    <block type="union"></block>  
    <block type="difference"></block>  
    <block type="intersection"></block>  
  </category>  
  <category name="üé® Colors" colour="300">  
    <block type="color"></block>  
  </category>  
  <category name="üî¢ Numbers" colour="230">  
    <block type="math_number"></block>  
    <block type="math_arithmetic"></block>  
  </category>  
</xml>  
  
<!-- Hidden XML storage -->  
<textarea id="blocksXml" style="display: none;">{{ blocks_xml }}</textarea>  
  
<!-- JavaScript Dependencies -->  
<!-- 1. Load Closure Library FIRST -->  
<script src="{% static 'cad_editor/js/closure-library/closure/goog/base.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blockly_uncompressed.js' %}"></script>  
  
<!-- 2. Load message files -->  
<script src="{% static 'cad_editor/js/blockly/core/msg.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/msg/js/en.js' %}"></script>  
<script src="{% static 'keditor/js/en.js' %}"></script>  
  
<!-- 3. Load jQuery and dependencies -->  
<script src="{% static 'cad_editor/js/jquery/jquery-1.11.3.js' %}"></script>  
<script src="{% static 'cad_editor/js/jquery/jquery-ui.min.js' %}"></script>  
<script src="{% static 'cad_editor/js/jquery/jquery.hammer.js' %}"></script>  
<script src="{% static 'cad_editor/js/jquery/jquery.ui.touch-punch.min.js' %}"></script>  
  
<!-- 4. Load Blockly core -->  
<script src="{% static 'cad_editor/js/blockly/blockly_compressed.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/blocks_compressed.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockly/openscad_compressed.js' %}"></script>  
  
<!-- 5. Load BlocksCAD utilities BEFORE blockscad.js -->  
<script src="{% static 'cad_editor/js/blockscad/storage.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/utils.js' %}"></script>  
  
<!-- 6. Load main BlocksCAD file -->  
<script src="{% static 'cad_editor/js/blockscad/blockscad.js' %}"></script>  
  
<!-- 7. Load other BlocksCAD components -->  
<script src="{% static 'cad_editor/js/blockscad/viewer.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/csg.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/lightgl.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/FileSaver.js' %}"></script>  
<script src="{% static 'cad_editor/js/blockscad/stl.js' %}"></script>  
<script src="{% static 'cad_editor/js/spectrum/spectrum.js' %}"></script>  
  
<script>  
// Initialize BlocksCAD for kids  
let workspace;  
let processor;  
  
document.addEventListener('DOMContentLoaded', function() {  
    // Initialize BlocksCAD globals FIRST  
    Blockscad.picSize = [450, 450];  
    Blockscad.rpicSize = [250, 250];  
    Blockscad.picQuality = 0.85;  
    Blockscad.numRotPics = 13;  
    Blockscad.drawAxes = 1;  
    Blockscad.resolution = 1;  
      
    // Initialize Blockly workspace  
    workspace = Blockly.inject('blocklyDiv', {  
        media: '{% static "cad_editor/js/blockly/media/" %}',  
        toolbox: document.getElementById('toolbox'),  
        sounds: true  
    });  
      
    // Initialize 3D processor  
    const renderDiv = document.getElementById('renderDiv');  
    processor = new Blockscad.Processor(renderDiv);  
      
    setupEventHandlers();  
});  
  
function setupEventHandlers() {  
    // Save project  
    document.getElementById('saveBtn').addEventListener('click', function() {  
        const xml = Blockly.Xml.workspaceToDom(workspace);  
        const blocksXml = Blockly.Xml.domToText(xml);  
        const openscadCode = Blockly.OpenSCAD.workspaceToCode(workspace);  
          
        fetch('/keditor/save/', {  
            method: 'POST',  
            headers: {  
                'Content-Type': 'application/json',  
                'X-CSRFToken': getCookie('csrftoken')  
            },  
            body: JSON.stringify({  
                project_id: {{ project.id|default:'null' }},  
                blocks_xml: blocksXml,  
                openscad_code: openscadCode,  
                name: 'My CAD Project'  
            })  
        })  
        .then(response => response.json())  
        .then(data => {  
            if (data.success) {  
                showMessage('Project saved! üíæ', 'success');  
            } else {  
                showMessage('Save failed! üòû', 'error');  
            }  
        });  
    });  
      
    // Render 3D  
    document.getElementById('renderBtn').addEventListener('click', function() {  
        const xml = Blockly.Xml.workspaceToDom(workspace);  
        const blocksXml = Blockly.Xml.domToText(xml);  
          
        showMessage('Building your 3D model... üî®', 'info');  
          
        fetch('/keditor/render/', {  
            method: 'POST',  
            headers: {  
                'Content-Type': 'application/json',  
                'X-CSRFToken': getCookie('csrftoken')  
            },  
            body: JSON.stringify({  
                project_id: {{ project.id|default:'null' }},  
                blocks_xml: blocksXml  
            })  
        })  
        .then(response => response.json())  
        .then(data => {  
            if (data.success) {  
                showMessage('3D model built successfully! üéâ', 'success');  
                if (processor && data.result) {  
                    processor.setBlockscad(data.result);  
                }  
            } else {  
                showMessage('Build failed: ' + data.error, 'error');  
            }  
        });  
    });  
      
    // Export STL  
    document.getElementById('exportBtn').addEventListener('click', function() {  
        if (processor && processor.viewer) {  
            const stlData = processor.generateSTL();  
            downloadSTL(stlData, 'kids_project.stl');  
            showMessage('STL downloaded! üìÅ', 'success');  
        } else {  
            showMessage('Please build your 3D model first! üî®', 'warning');  
        }  
    });  
      
    // 3D viewer controls  
    document.getElementById('zInButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.zoomIn();  
            showMessage('Zoomed in! üîç', 'info');  
        }  
    });  
      
    document.getElementById('zOutButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.zoomOut();  
            showMessage('Zoomed out! üîç', 'info');  
        }  
    });  
      
    document.getElementById('zResetButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.viewReset();  
            showMessage('View reset! üè†', 'info');  
        }  
    });  
      
    document.getElementById('axesButton').addEventListener('click', () => {  
        if (processor && processor.viewer) {  
            processor.viewer.toggleAxes();  
            showMessage('Axes toggled! üìê', 'info');  
        }  
    });  
}  
  
// Utility functions  
function showMessage(message, type = 'info') {  
    const console = document.getElementById('consoleOutput');  
    const div = document.createElement('div');  
    div.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'}`;  
    div.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;  
    console.appendChild(div);  
    console.scrollTop = console.scrollHeight;  
      
    // Auto-remove messages after 5 seconds  
    setTimeout(() => {  
        if (div.parentNode) {  
            div.parentNode.removeChild(div);  
        }  
    }, 5000);  
}  
  
function getCookie(name) {  
    let cookieValue = null;  
    if (document.cookie && document.cookie !== '') {  
        const cookies = document.cookie.split(';');  
        for (let i = 0; i < cookies.length; i++) {  
            const cookie = cookies[i].trim();  
            if (cookie.substring(0, name.length + 1) === (name + '=')) {  
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));  
                break;  
            }  
        }  
    }  
    return cookieValue;  
}  
  
function downloadSTL(stlData, filename) {  
    const blob = new Blob([stlData], { type: 'application/octet-stream' });  
    const url = URL.createObjectURL(blob);  
    const a = document.createElement('a');  
    a.href = url;  
    a.download = filename;  
    document.body.appendChild(a);  
    a.click();  
    document.body.removeChild(a);  
    URL.revokeObjectURL(url);  
}  
</script>  
  
{% endblock %}
