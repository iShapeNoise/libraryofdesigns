{% extends 'core/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex flex-fill justify-content-center mb-3 rounded">
    <div style="width: 80%; max-width: 1200px;">
        <form method="post" action="." enctype="multipart/form-data">
            {% csrf_token %}
            <fieldset>
                <legend>{{ title }}</legend>
                <hr class="border-bottom border-1 border-dark">
                <div class="row pt-3 border rounded">
                    <label class="form-label">
                        <h3>Header Content</h3>
                    </label>
                    <!-- Left Column -->
                    <div class="col-lg-6 col-12">
                        <div class="mt-6 mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                {{ form.category.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.category }}
                        </div>
                        <div class="mt-3 mb-3">  
                            <label for="{{ form.tags.id_for_label }}" class="form-label">  
                                {{ form.tags.label }}  
                            </label>  
                            {{ form.tags }}  
                            {% if form.tags.help_text %}  
                                <small class="form-text text-muted">{{ form.tags.help_text }}</small>  
                            {% endif %}  
                        </div>
                        <div class="mt-6 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                {{ form.name.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                        </div>
                        <div class="mt-6 mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                {{ form.description.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.description }}
                        </div>
                        {% if not existing_images %}
                            <div class="mt-3 mb-3">  
                                <label for="{{ form.image.id_for_label }}" class="form-label">  
                                    Design Images <span class="text-danger">*</span>
                                </label>
                                <div>
                                    {{ form.images }}  
                                    {% if form.images.help_text %}
                                    <br>
                                        <small class="form-text text-muted">{{ form.images.help_text }}</small>  
                                    {% endif %}  
                                </div>
                            </div>
                            <div class="mt-3 mb-3">  
                                <label for="{{ form.techdraw.id_for_label }}" class="form-label">  
                                    Technical Drawings  
                                </label>
                                <div>
                                    {{ form.techdraws }}  
                                    {% if form.techdraws.help_text %} 
                                    <br>
                                        <small class="form-text text-muted">{{ form.techdraws.help_text }}</small>  
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        {% if existing_images %}  
                            <div class="mt-3 mb-3">  
                                <h5>Current Images</h5>  
                                <div class="row">  
                                    {% for image in existing_images %}  
                                        <div class="col-md-3 col-sm-4 col-6 mb-2">  
                                            <img src="{{ image.url }}" class="img-fluid rounded" alt="{{ image.filename }}"   
                                                 style="height: 200px; width: 100%;">  
                                            <small class="d-block text-muted">{{ image.filename }}</small>  
                                        </div>  
                                    {% endfor %}  
                                </div>                            
                                <div class="mt-3">  
                                    {{ form.delete_all_images }}  
                                    <label for="{{ form.delete_all_images.id_for_label }}" class="form-label text-danger">  
                                        {{ form.delete_all_images.label }}  
                                    </label> 
                                </div> 
                            </div> 
                        {% endif %}
                        {% if title != 'New Design' %}
                            <!-- Add new images section -->  
                            <div class="mt-3 mb-3">  
                                <label for="{{ form.images.id_for_label }}" class="form-label">  
                                    Add New Design Images  
                                </label>
                                <br>
                                {{ form.images }}  
                                {% if form.images.help_text %}
                                <br>
                                    <small class="form-text text-muted">{{ form.images.help_text }}</small>  
                                {% endif %}  
                            </div>  
                        {% endif %}
                        <!-- Similar sections for techdraws -->  
                        {% if existing_techdraws %}  
                            <div class="mt-3 mb-3">  
                                <h5>Current Technical Drawings</h5>  
                                <div class="row">  
                                    {% for techdraw in existing_techdraws %}  
                                        <div class="col-md-3 col-sm-4 col-6 mb-2">  
                                            <img src="{{ techdraw.url }}" class="img-fluid rounded" alt="{{ techdraw.filename }}"   
                                                 style="height: 200px; width: 100%; object-fit: cover;">  
                                            <small class="d-block text-muted">{{ techdraw.filename }}</small>  
                                        </div>  
                                    {% endfor %}  
                                </div>
                                <div class="mt-3">  
                                    {{ form.delete_all_techdraws }}  
                                    <label for="{{ form.delete_all_techdraws.id_for_label }}" class="form-label text-danger">  
                                        {{ form.delete_all_techdraws.label }}  
                                    </label>  
                                </div>  
                            </div>
                        {% endif %}
                        {% if title != 'New Design' %}
                            <div class="mt-3 mb-3">  
                                <label for="{{ form.techdraws.id_for_label }}" class="form-label">  
                                    Add New Technical Drawings  
                                </label>
                                <br>
                                {{ form.techdraws }}  
                                {% if form.techdraws.help_text %}  
                                <br>
                                    <small class="form-text text-muted">{{ form.techdraws.help_text }}</small>  
                                {% endif %}  
                            </div>
                        {% endif %}
                    </div>
                    <!-- Right Column -->  
                    <div class="col-lg-6 col-12"> 
                        <div class="mt-3 mb-3">    
                            <label for="{{ form.created_by.id_for_label }}" class="form-label">  
                                {{ form.created_by.label }} <span class="text-danger">*</span>
                            </label>  
                            {{ form.created_by }}  
                            {{ form.custom_creator_name }}  
                        </div>
                        <div class="mt-3 mb-3">
                            <div> 
                                {{ form.is_modified }}  
                                <label for="{{ form.is_modified.id_for_label }}" class="form-label">
                                    This design has been modified
                                </label>
                            </div>
                            <div>
                                <label for="{{ form.modified_from.id_for_label }}" class="form-label">
                                    {{ form.modified_from.label }}
                                </label>
                                {{ form.modified_from }}  
                            </div>
                        </div>
                        <div class="mt-3 mb-3">
                            <label for="{{ form.costs.id_for_label }}" class="form-label">
                                Production costs
                            </label>
                            {{ form.costs }}
                        </div>
                        <div class="mt-3 mb-3">
                            <label for="{{ form.production_notes.id_for_label }}" class="form-label">
                                {{ form.production_notes.label }}
                            </label>
                                {{ form.production_notes }}
                        </div>
                    </div>
                </div>
                <hr class="border-bottom border-1 border-dark">
                <div class="row pt-6 border rounded">
                    <label class="form-label">
                        <h3>Body Content</h3>
                    </label>
                    <div class="mt-3 mb-3">
                        <label for="{{ form.utilities_file.id_for_label }}" class="form-label">OpenSCAD Utilities for LoD Design
                        </label>
                        <br>
                        {{ form.utilities_file }}    
                        <button type="button" onclick="addUtilityFile()" class="btn btn-primary mt-2">Add Selected File to Utilities</button>  
                        <button type="button" onclick="removeSelectedUtilityFile()" class="btn btn-danger mt-2 ms-2">Remove Selected File</button>    
                    </div>
                    <div class="mt-3 mb-3">    
                        <ul id="utilities-list" class="list-group" style="max-height: 200px; overflow-y: auto;"></ul>  
                            {{ form.utilities }}
                        <script> 
                            // Hide the original textarea  
                            document.getElementById('id_utilities').style.display = 'none';  
                        </script>  
                    </div>
                    <label for="{{ form.utilities_file.id_for_label }}" class="form-label">B.O.M. (Bills of Materials)
                    </label>
                    <br>
                    <div class="mb-3">
                        <div class="row g-2">
                            {% for form in bom_formset %}
                                <div class="col-12 col-md-1">    
                                    <label class="form-label">Position</label>    
                                    {{ form.bom_position }}    
                                </div>    
                                <div class="col-12 col-md-1">    
                                    <label class="form-label">Count</label>    
                                    {{ form.bom_count }}    
                                </div>    
                                <div class="col-12 col-md-2">    
                                    <label class="form-label">Name</label>    
                                    {{ form.bom_name }}   
                                </div>    
                                <div class="col-12 col-md-4">    
                                    <label class="form-label">Standardization Notes</label>    
                                    {{ form.bom_standard }}    
                                </div>    
                                <div class="col-12 col-md-4">    
                                    <label class="form-label">Material</label>    
                                    {{ form.bom_material }}    
                                </div>     
                                <div class="col-12 col-md-6">    
                                    <label class="form-label">Notes</label>    
                                    {{ form.bom_notes }}    
                                </div>    
                                <div class="col-12 col-md-6">    
                                    <label class="form-label">LoD Link</label>    
                                    {{ form.bom_link }}    
                                </div>
                            {% endfor %}
                        </div>
                        <div class="mt-2">  
                            <button type="button" onclick="addBOMItem()" class="btn btn-primary">Add BOM Item</button>  
                            <button type="button" onclick="editBOMItem()" id="edit-bom-btn" class="btn btn-warning ms-2">Edit</button>  
                            <button type="button" onclick="removeSelectedBOMItem()" class="btn btn-danger ms-2">Remove Selected Item</button>  
                        </div>    
                        <!-- BOM List -->  
                        <div class="mt-3 mb-3">  
                            <ul id="bom-list" class="list-group mt-3" style="max-height: 300px; overflow-y: auto;">  
                            <!-- Dynamic BOM items will be added here -->  
                            </ul>  
                            <!-- Hidden formset for form submission -->  
                            {{ bom_formset.management_form }} 
                        </div>
                        <div id="bom-formset-container" style="display: none;">  
                            {% for form in bom_formset %}  
                                <div class="bom-formset-item">  
                                    {{ form.as_p }}  
                                </div>  
                            {% endfor %}  
                        </div>  
                    </div>
                    <!-- Module Section -->   
                    <div class="mb-3">  
                        <label for="{{ form.module.id_for_label }}" class="form-label">  
                            {{ form.module.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.module }}
                    </div>
                    <!-- Parameters Section --> 
                    <div class="mb-3">  
                        <label for="{{ form.example.id_for_label }}" class="form-label">
                            Assembled Example <span class="text-danger">*</span></label>  
                        {{ form.example }}
                    </div>
                </div>
                <hr class="border-bottom border-1 border-dark">
                <div class="row">
                    {% if form.errors or form.non_field_errors %}
                        <div class="mt-3 mb-3 border border-warning">
                            {% for field in form %}
                                {{ field.errors }}
                            {% endfor %}
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    <button class="btn btn-lg btn-primary">  
                        {% if form.instance.pk %}Update Design{% else %}Add Design To LoD{% endif %}  
                    </button>
                </div>
            </fieldset>
        </form>
    </div>
</div>
<script type="text/javascript">    

// Optional: Auto-format lists on blur  
document.addEventListener('DOMContentLoaded', function() {  
    const imageList = document.getElementById('id_image_list');  
    const techdrawList = document.getElementById('id_techdraw_list');  
      
    [imageList, techdrawList].forEach(field => {  
        if (field) {  
            field.addEventListener('blur', function() {  
                // Simple cleanup: remove empty lines  
                this.value = this.value.split('\n').filter(line => line.trim()).join('\n');  
            });  
        }  
    });  
});

function addImageToList() {
    const imageInput = document.getElementById('id_image');
    const imageListField = document.getElementById('id_image_list');

    if (imageInput.files.length > 0) {
        const fileName = imageInput.files[0].name;
        const currentList = imageListField.value.trim();

        if (currentList) {
            imageListField.value = currentList + ', ' + fileName;
        } else {
            imageListField.value = fileName;
        }
        imageInput.value = '';
    } else {
        alert('Please select an image first.');
    }
}

function addTechdrawToList() {  
    const techdrawInput = document.getElementById('id_techdraw');  
    const techdrawListField = document.getElementById('id_techdraw_list');  
      
    if (techdrawInput.files.length > 0) {  
        const fileName = techdrawInput.files[0].name;  
        const currentList = techdrawListField.value.trim();  
          
        if (currentList) {  
            techdrawListField.value = currentList + ', ' + fileName;  
        } else {  
            techdrawListField.value = fileName;  
        }  
          
        // Clear the file input  
        techdrawInput.value = '';  
    } else {  
        alert('Please select a techdraw first.');  
    }  
}

function resetImageList() {
    const imageListField = document.getElementById('id_image_list');
    if (imageListField) {
        imageListField.value = '';
    }
}

function resetTechdrawList() {
    const techdrawListField = document.getElementById('id_techdraw_list');
    if (techdrawListField) {
        techdrawListField.value = '';
    }
}

function toggleModifiedFrom() {  
    const checkbox = document.querySelector('input[name="is_modified"]');  
    const modifiedFromField = document.getElementById('id_modified_from');  
    if (modifiedFromField) {  
        modifiedFromField.disabled = !checkbox.checked;  
        modifiedFromField.style.opacity = checkbox.checked ? '1' : '0.5';  
    }  
}

// Minimal JavaScript for conditional field and utility file addition    
function toggleModifiedBy() {    
    const checkbox = document.querySelector('input[name="is_modified"]');    
    const modifiedByField = document.getElementById('id_modified_from');    
    if (modifiedByField) {    
        modifiedByField.disabled = !checkbox.checked;    
        modifiedByField.style.opacity = checkbox.checked ? '1' : '0.5';    
    }    
}  
  
let selectedUtilityItem = null;  
  
function addUtilityFile() {    
    const fileSelect = document.querySelector('select[name="utilities_file"]');    
    const utilitiesList = document.getElementById('utilities-list');  
    const utilitiesField = document.getElementById('id_utilities');  
        
    if (fileSelect && fileSelect.value && utilitiesList) {    
        // Check if file already exists  
        const existingItems = Array.from(utilitiesList.children);  
        const fileExists = existingItems.some(item =>   
            item.querySelector('.utility-filename').textContent === fileSelect.value  
        );  
          
        if (fileExists) {  
            alert('This file is already in the utilities list.');  
            return;  
        }  
          
        // Create new list item  
        const listItem = document.createElement('li');  
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center utility-item';  
        listItem.style.cursor = 'pointer';  
          
        listItem.innerHTML = `  
            <span class="utility-filename">${fileSelect.value}</span>  
            <span class="badge bg-secondary">SCAD</span>  
        `;  
          
        // Add click handler for selection  
        listItem.addEventListener('click', function() {  
            // Clear previous selection  
            document.querySelectorAll('.utility-item').forEach(item => {  
                item.classList.remove('active', 'bg-primary', 'text-white');  
            });  
              
            // Select this item  
            this.classList.add('active', 'bg-primary', 'text-white');  
            selectedUtilityItem = this;  
        });  
          
        utilitiesList.appendChild(listItem);  
          
        // Update hidden textarea  
        updateUtilitiesField();  
          
        fileSelect.value = ''; // Reset selection    
    }    
}  
  
function removeSelectedUtilityFile() {  
    if (!selectedUtilityItem) {  
        alert('Please select a utility file to remove.');  
        return;  
    }  
      
    selectedUtilityItem.remove();  
    selectedUtilityItem = null;  
      
    // Update hidden textarea  
    updateUtilitiesField();  
}  
  
function updateUtilitiesField() {  
    const utilitiesList = document.getElementById('utilities-list');  
    const utilitiesField = document.getElementById('id_utilities');  
      
    const filenames = Array.from(utilitiesList.children).map(item =>   
        item.querySelector('.utility-filename').textContent  
    );  
      
    utilitiesField.value = filenames.join('\n');  
}  
  
// Initialize utilities list from existing data  
function initializeUtilitiesList() {  
    const utilitiesField = document.getElementById('id_utilities');  
    const utilitiesList = document.getElementById('utilities-list');  
      
    if (utilitiesField.value.trim()) {  
        const filenames = utilitiesField.value.split('\n').filter(name => name.trim());  
          
        filenames.forEach(filename => {  
            const listItem = document.createElement('li');  
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center utility-item';  
            listItem.style.cursor = 'pointer';  
              
            listItem.innerHTML = `  
                <span class="utility-filename">${filename.trim()}</span>  
                <span class="badge bg-secondary">SCAD</span>  
            `;  
              
            // Add click handler for selection  
            listItem.addEventListener('click', function() {  
                // Clear previous selection  
                document.querySelectorAll('.utility-item').forEach(item => {  
                    item.classList.remove('active', 'bg-primary', 'text-white');  
                });  
                  
                // Select this item  
                this.classList.add('active', 'bg-primary', 'text-white');  
                selectedUtilityItem = this;  
            });  
              
            utilitiesList.appendChild(listItem);  
        });  
    }  
}  
    
// Initialize on page load    
document.addEventListener('DOMContentLoaded', function() {    
    toggleModifiedBy();  
    initializeUtilitiesList(); // Initialize the utilities list  
    initializeBOMList();

    // Add event listener for the checkbox    
    const checkbox = document.querySelector('input[name="is_modified"]');    
    if (checkbox) {    
        checkbox.addEventListener('change', toggleModifiedBy);    
    }    
        
    // Initialize BOM formset functionality    
    const addButton = document.getElementById('add-bom-form');    
    if (addButton && typeof django !== 'undefined' && django.jQuery) {    
        // Use Django's inline formset functionality if available    
        django.jQuery('#bom-forms .bom-form').formset({    
            prefix: 'bom_items',    
            addText: 'Add BOM Item',    
            deleteText: 'Remove',    
            addButton: addButton    
        });    
    }    
});

let selectedBOMItem = null;  
let editingBOMItem = null;  
let bomItems = [];  
 
function addBOMItem() {  
    const bom_position = document.getElementById('bom_position').value;
    const bom_count = document.getElementById('bom_count').value || 1;
    const bom_name = document.getElementById('bom_name').value;
    const bom_standard = document.getElementById('bom_standard').value;
    const bom_material = document.getElementById('bom_material').value;
    const bom_notes = document.getElementById('bom_notes').value;
    const bom_link = document.getElementById('bom_link').value;
      
    if (!bom_position || !bom_name) {  
        alert('Position and Name are required fields.');  
        return;  
    }  
      
    const bomItem = {  
        bom_position: parseInt(bom_position),  
        bom_count: parseInt(bom_count),  
        bom_name: bom_name,  
        bom_standard: bom_standard,  
        bom_material: bom_material,  
        bom_notes: bom_notes,  
        bom_link: bom_link
    };
      
    // Check if we're in editing mode  
    if (editingBOMItem !== null) {  
        // Replace existing item (this is the "Append" functionality)  
        bomItems[editingBOMItem] = bomItem;
        editingBOMItem = null;  
        document.getElementById('edit-bom-btn').textContent = 'Edit';  
        selectedBOMItem = null; // Clear selection after append  
    } else {  
        // Add new item  
        bomItems.push(bomItem);  
    }  
      
    clearBOMForm();  
    renderBOMList();  
    updateBOMFormset();  
}

function editBOMItem() {  
    if (!selectedBOMItem) {  
        alert('Please select a BOM item to edit.');  
        return;  
    }  
      
    const itemIndex = parseInt(selectedBOMItem.dataset.bomIndex);  
    const item = bomItems[itemIndex];  
      
    if (!item) {  
        console.error('BOM item not found at index:', itemIndex);  
        return;  
    }  
      
    console.log('Editing item:', item); // Debug log to see what data we have  
      
    // Populate form with selected item data using underscore naming  
    const elements = {  
        position: document.getElementById('bom_position'),  
        count: document.getElementById('bom_count'),  
        name: document.getElementById('bom_name'),  
        standard: document.getElementById('bom_standard'),  
        material: document.getElementById('bom_material'),  
        notes: document.getElementById('bom_notes'),  
        link: document.getElementById('bom_link')  
    };  
      
    // Check which elements are found and populate them  
    Object.keys(elements).forEach(key => {  
        const element = elements[key];  
        if (!element) {  
            console.error(`Element not found: bom_${key}`);  
            return;  
        }  
          
        let value = '';  
        switch(key) {  
            case 'position':  
                value = item.bom_position || '';  
                break;  
            case 'count':  
                value = item.bom_count || 1;  
                break;  
            case 'name':  
                value = item.bom_name || '';  
                break;  
            case 'standard':  
                value = item.bom_standard || '';  
                break;  
            case 'material':  
                value = item.bom_material || '';  
                break;  
            case 'notes':  
                value = item.bom_notes || '';  
                break;  
            case 'link':  
                value = item.bom_link || '';  
                break;  
        }  
          
        element.value = value;  
        console.log(`Set ${key} to:`, value); // Debug log  
    });  
      
    editingBOMItem = itemIndex;  
    const editBtn = document.getElementById('edit_bom_btn');  
    if (editBtn) editBtn.textContent = 'Append';  
}

function removeSelectedBOMItem() {  
    if (!selectedBOMItem) {  
        alert('Please select a BOM item to remove.');  
        return;  
    }  
      
    const itemIndex = parseInt(selectedBOMItem.dataset.bomIndex);  
    bomItems.splice(itemIndex, 1);  
    selectedBOMItem = null;  
      
    renderBOMList();  
    updateBOMFormset();
}  
  
function clearBOMForm() {  
    const fields = ['bom_position', 'bom_count', 'bom_name', 'bom_standard', 'bom_material', 'bom_notes', 'bom_link'];  
    fields.forEach(fieldId => {  
        const field = document.getElementById(fieldId);  
        if (field) {  
            field.value = fieldId === 'bom_count' ? '1' : '';  
        }  
    });  
}  

function renderBOMList() {  
    const bomList = document.getElementById('bom-list');  
    bomList.innerHTML = '';  
      
    bomItems.forEach((item, index) => {  
        const listItem = document.createElement('li');  
        listItem.className = 'list-group-item bom-item';  
        listItem.style.cursor = 'pointer';  
        listItem.dataset.bomIndex = index;  
          
        listItem.innerHTML = `  
            <div class="row">  
                <div class="col-1"><strong>Pos:</strong> ${item.bom_position}</div>  
                <div class="col-1"><strong>Count:</strong> ${item.bom_count}</div>  
                <div class="col-2"><strong>Name:</strong> ${item.bom_name}</div>  
                <div class="col-1"><strong>Material:</strong> ${item.bom_material || 'N/A'}</div>  
                <div class="col-3"><strong>Standardization Notes:</strong> ${item.bom_standard || 'N/A'}</div>  
                <div class="col-4"><strong>Notes:</strong> ${item.bom_notes || 'N/A'}</div>
            </div>  
            ${item.bom_link ? `<div class="mt-1"><strong>LoD Link:</strong> <a href="${item.bom_link}" target="_blank">${item.bom_link}</a></div>` : ''}  
        `;  
          
        // Add click handler for selection  
        listItem.addEventListener('click', function() {  
            // Clear previous selection  
            document.querySelectorAll('.bom-item').forEach(item => {  
                item.classList.remove('active', 'bg-primary', 'text-white');  
            });  
              
            // Select this item  
            this.classList.add('active', 'bg-primary', 'text-white');  
            selectedBOMItem = this;  
        });  
          
        bomList.appendChild(listItem);  
    });  
}  
  
function updateBOMFormset() {  
    // Update Django formset with current BOM items  
    const totalForms = document.querySelector('input[name="bom_items-TOTAL_FORMS"]');  
    if (totalForms) {  
        totalForms.value = bomItems.length;  
    }  
      
    // Clear existing formset items  
    const container = document.getElementById('bom-formset-container');  
    container.innerHTML = '';  
      
    // Add management form  
    const managementForm = document.querySelector('input[name="bom_items-TOTAL_FORMS"]').parentNode;  
    container.appendChild(managementForm.cloneNode(true));  
      
    // Create hidden form fields for each BOM item  
    bomItems.forEach((item, index) => {  
        const formDiv = document.createElement('div');  
        formDiv.innerHTML = `  
            <input type="hidden" name="bom_items-${index}-position" value="${item.bom_position}">  
            <input type="hidden" name="bom_items-${index}-count" value="${item.bom_count}">  
            <input type="hidden" name="bom_items-${index}-name" value="${item.bom_name}">  
            <input type="hidden" name="bom_items-${index}-standard" value="${item.bom_standard}">  
            <input type="hidden" name="bom_items-${index}-material" value="${item.bom_material}">  
            <input type="hidden" name="bom_items-${index}-notes" value="${item.bom_notes}">  
            <input type="hidden" name="bom_items-${index}-link" value="${item.bom_link}">  
        `;  
        container.appendChild(formDiv);  
    });  
}  
  
// Initialize BOM list from existing data  
function initializeBOMList() {  
    // Extract existing BOM data from formset  
    const totalForms = document.querySelector('input[name="bom_items-TOTAL_FORMS"]');  
    if (totalForms) {  
        const formCount = parseInt(totalForms.value);  
          
        for (let i = 0; i < formCount; i++) {  
            const position = document.querySelector(`input[name="bom_items-${i}-position"]`)?.value;  
            const count = document.querySelector(`input[name="bom_items-${i}-count"]`)?.value;  
            const name = document.querySelector(`input[name="bom_items-${i}-name"]`)?.value;  
              
            if (position && name) {  
                bomItems.push({  
                    position: parseInt(position),  
                    count: parseInt(count) || 1,  
                    name: name,  
                    standard: document.querySelector(`input[name="bom_items-${i}-standard"]`)?.value || '',  
                    material: document.querySelector(`input[name="bom_items-${i}-material"]`)?.value || '',  
                    notes: document.querySelector(`input[name="bom_items-${i}-notes"]`)?.value || '',  
                    link: document.querySelector(`input[name="bom_items-${i}-link"]`)?.value || ''  
                });  
            }  
        }  
          
        renderBOMList();  
    }  
}

function toggleCreatorField() {  
    const createdBySelect = document.getElementById('id_created_by');  
    const customCreatorField = document.getElementById('id_custom_creator_name');  
      
    if (createdBySelect && customCreatorField) {  
        if (createdBySelect.value === 'add_creator') {  
            customCreatorField.style.display = 'block';  
            customCreatorField.required = true;  
            createdBySelect.style.display = 'none';  
        } else {  
            customCreatorField.style.display = 'none';  
            customCreatorField.required = false;  
            customCreatorField.value = '';  
        }  
    }  
}  
 
document.addEventListener('DOMContentLoaded', function() {  
    const createdBySelect = document.getElementById('id_created_by');  
    if (createdBySelect) {  
        createdBySelect.addEventListener('change', toggleCreatorField);  
    }    
});
</script>
{% endblock %}
