{% extends 'core/base.html' %}  
  
{% block title %}  
    BOM Design Search  
{% endblock %}  
  
{% block content %}  
<div class="container-fluid">  
    <div class="row">  
        <!-- Left Sidebar: Categories -->  
        <div class="col-md-3">  
            <div class="card">  
                <div class="card-header">  
                    <h5>Categories {% if has_search_results %}(with "{{ query }}"){% endif %}</h5>  
                </div>  
                <div class="card-body">  
                    {% if categories %}  
                        {% for category in categories %}  
                            <div class="d-flex justify-content-between align-items-center mb-2">  
                                <a href="{% url 'design:bom_search' %}?category={{ category.id }}{% if query %}&query={{ query }}{% endif %}{% if per_page %}&per_page={{ per_page }}{% endif %}"   
                                   class="text-decoration-none">  
                                    {{ category.name }}  
                                </a>  
                                <span class="badge bg-primary">{{ category.design_count }}</span>  
                            </div>  
                        {% endfor %}  
                    {% else %}  
                        <p class="text-muted">No categories found</p>  
                    {% endif %}  
                </div>  
            </div>  
        </div>  
  
        <!-- Main Content: Search Results -->  
        <div class="col-md-9">  
            <!-- Search Bar -->  
            <div class="mb-4">  
                <form method="get" class="d-flex">  
                    <input type="text" name="query" value="{{ query }}"   
                           class="form-control me-2" placeholder="Search designs for BOM...">  
                    {% if category_id %}  
                        <input type="hidden" name="category" value="{{ category_id }}">  
                    {% endif %}  
                    {% if per_page %}  
                        <input type="hidden" name="per_page" value="{{ per_page }}">  
                    {% endif %}  
                    <button type="submit" class="btn btn-primary">Search</button>  
                </form>  
            </div>  
  
            <!-- Results Header -->  
            <div class="d-flex justify-content-between align-items-center mb-3">  
                <h4>  
                    {% if query %}  
                        Search Results for "{{ query }}"  
                    {% else %}  
                        All Designs  
                    {% endif %}  
                </h4>  
                  
                <!-- Per-page selector -->  
                <div class="dropdown">  
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">  
                        Show: {{ per_page|capfirst }}  
                    </button>  
                    <ul class="dropdown-menu">  
                        <li><a class="dropdown-item" href="javascript:changePerPage('25')">25 per page</a></li>  
                        <li><a class="dropdown-item" href="javascript:changePerPage('50')">50 per page</a></li>  
                        <li><a class="dropdown-item" href="javascript:changePerPage('all')">All</a></li>  
                    </ul>  
                </div>  
            </div>  
  
            <!-- Design Grid -->  
            {% if designs %}  
                <div class="row {% if per_page == 'all' %}overflow-auto{% endif %}" {% if per_page == 'all' %}style="max-height: 70vh;"{% endif %}>  
                    {% for design in designs %}  
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">  
                            <div class="card h-100">  
                                {% if design.first_image.url %}  
                                    <img src="{{ design.first_image.url }}" class="card-img-top"   
                                         style="height: 200px; object-fit: cover;">  
                                {% else %}  
                                    <div class="bg-secondary d-flex align-items-center justify-content-center"   
                                         style="height: 200px;">  
                                        <i class="fas fa-image fa-3x text-white"></i>  
                                    </div>  
                                {% endif %}  
                                  
                                <div class="card-body d-flex flex-column">  
                                    <h6 class="card-title">{{ design.name }}</h6>  
                                    <p class="card-text text-muted small flex-grow-1">  
                                        {{ design.description|truncatewords:15 }}  
                                    </p>  
                                    <div class="mt-auto">  
                                        <small class="text-muted d-block">{{ design.category.get_full_path }}</small>  
                                        <small class="text-muted d-block">by {{ design.created_by.username }}</small>  
                                        {% if design.production_notes %}  
                                            <small class="text-muted d-block">Notes: {{ design.production_notes|truncatewords:10 }}</small>  
                                        {% endif %}  
                                        {% if design.standardization %}  
                                            <small class="text-muted d-block">Standards: {{ design.standardization|truncatewords:5 }}</small>  
                                        {% endif %}  
                                    </div>  
                                </div>  
                                  
                                <div class="card-footer">  
                                    <button type="button" class="btn btn-success btn-sm w-100"   
                                            onclick="addToBOM('{{ design.id }}', '{{ design.name }}', '{{ design.standardization|default:'' }}', '{{ design.production_notes|default:'' }}', 'lod_content/designs/{{ design.category.get_full_path|slugify }}/{{ design.name|slugify }}/design/{{ design.name|slugify }}.scad')">  
                                        Add to B.O.M.  
                                    </button>  
                                </div>  
                            </div>  
                        </div>  
                    {% endfor %}  
                </div>  
  
                <!-- Pagination -->  
                {% if per_page != 'all' and designs.has_other_pages %}  
                <nav aria-label="Search results pagination" class="mt-4">  
                    <ul class="pagination justify-content-center">  
                        {% if designs.has_previous %}  
                        <li class="page-item">  
                            <a class="page-link" href="?page=1{% if query %}&query={{ query }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}&per_page={{ per_page }}">&laquo; First</a>  
                        </li>  
                        <li class="page-item">  
                            <a class="page-link" href="?page={{ designs.previous_page_number }}{% if query %}&query={{ query }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}&per_page={{ per_page }}">Previous</a>  
                        </li>  
                        {% endif %}  
                          
                        <li class="page-item active">  
                            <span class="page-link">Page {{ designs.number }} of {{ designs.paginator.num_pages }}</span>  
                        </li>  
                          
                        {% if designs.has_next %}  
                        <li class="page-item">  
                            <a class="page-link" href="?page={{ designs.next_page_number }}{% if query %}&query={{ query }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}&per_page={{ per_page }}">Next</a>  
                        </li>  
                        <li class="page-item">  
                            <a class="page-link" href="?page={{ designs.paginator.num_pages }}{% if query %}&query={{ query }}{% endif %}{% if category_id %}&category={{ category_id }}{% endif %}&per_page={{ per_page }}">Last &raquo;</a>  
                        </li>  
                        {% endif %}  
                    </ul>  
                </nav>  
                {% endif %}  
            {% else %}  
                <div class="alert alert-info">  
                    {% if query %}  
                        No designs found for "{{ query }}"  
                    {% else %}  
                        No designs available  
                    {% endif %}  
                </div>  
            {% endif %}  
        </div>  
    </div>  
</div>  
  
<script>  
function changePerPage(value) {  
    const url = new URL(window.location);  
    url.searchParams.set('per_page', value);  
    url.searchParams.delete('page');  
    window.location.href = url.toString();  
}  
  
function addToBOM(design) {  
    const designData = {  
        name: design.name,  
        standardization: design.standardization,  
        production_notes: design.production_notes,  
        lod_link: `/designs/${design.id}/` // Construct proper URL  
    };  
      
    if (window.opener && window.opener.addBOMItemFromSearch) {  
        window.opener.addBOMItemFromSearch(designData);  
        window.close();  
    }  
}
</script>  
{% endblock %}
