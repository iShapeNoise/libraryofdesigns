// Do not edit this file; automatically generated by openscad_build.py.
"use strict";
var Openscad=Openscad||{},CSG=CSG||{},CAG=CAG||{};Openscad.Viewer=function(e,t,n,r){var o=GL.create();this.gl=o,this.angleX=-60,this.angleY=0,this.angleZ=-45,this.viewpointX=0,this.viewpointY=-5,this.viewpointZ=r,this.defaultColor=[1,.5,1,1],this.touch={lastX:0,lastY:0,scale:0,ctrl:0,shiftTimer:null,shiftControl:null,cur:null},this.drawLines=!1,this.lineOverlay=!1,o.canvas.width=t,o.canvas.height=n,o.viewport(0,0,t,n),o.matrixMode(o.PROJECTION),o.loadIdentity(),o.perspective(45,t/n,1,3e3),o.matrixMode(o.MODELVIEW),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.clearColor(1,1,1,1),o.enable(o.DEPTH_TEST),o.enable(o.CULL_FACE),o.polygonOffset(1,1),this.blackShader=new GL.Shader("void main() {gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;}","void main() {gl_FragColor = vec4(0.0, 0.0, 0.0, 0.1);}"),this.lightingShader=new GL.Shader("varying vec3 color;varying float alpha;varying vec3 normal;varying vec3 light;void main() {const vec3 lightDir = vec3(1.0, 2.0, 3.0) / 3.741657386773941;light = lightDir;color = gl_Color.rgb;alpha = gl_Color.a;normal = gl_NormalMatrix * gl_Normal;gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;}","varying vec3 color;varying float alpha;varying vec3 normal;varying vec3 light;void main() {vec3 n = normalize(normal);float diffuse = max(0.0, dot(light, n));float specular = pow(max(0.0, -reflect(light, n).z), 18.0) * sqrt(diffuse);gl_FragColor = vec4(mix(color * (0.3 + 0.7 * diffuse), vec3(1.0), specular), alpha);}");var i=this,s=$('<div class="shift-scene"><div class="arrow arrow-left" /><div class="arrow arrow-right" /><div class="arrow arrow-top" /><div class="arrow arrow-bottom" /></div>');this.touch.shiftControl=s,$(e).append(o.canvas).append(s).hammer({drag_lock_to_axis:!0}).on("transform",function(e){e.gesture.touches.length>=2&&(i.clearShift(),i.onTransform(e),e.preventDefault())}).on("touch",function(e){if("touch"==e.gesture.pointerType)if(1==e.gesture.touches.length){var t=e.gesture.center;i.touch.shiftTimer=setTimeout(function(){s.addClass("active").css({left:t.pageX+"px",top:t.pageY+"px"}),i.touch.shiftTimer=null,i.touch.cur="shifting"},500)}else i.clearShift();else e.preventDefault()}).on("drag",function(e){"touch"==e.gesture.pointerType?i.touch.cur&&"dragging"!=i.touch.cur?"shifting"==i.touch.cur&&i.onShift(e):(i.clearShift(),i.onPanTilt(e)):e.preventDefault()}).on("touchend",function(e){i.clearShift(),i.touch.cur&&s.removeClass("active shift-horizontal shift-vertical")}).on("transformend dragstart dragend",function(e){("transformend"==e.type&&"transforming"==i.touch.cur||"dragend"==e.type&&"shifting"==i.touch.cur||"dragend"==e.type&&"dragging"==i.touch.cur)&&(i.touch.cur=null),i.touch.lastX=0,i.touch.lastY=0,i.touch.scale=0}),o.onmousemove=function(e){i.onMouseMove(e)},o.ondraw=function(){i.onDraw()},o.onmousewheel=function(e){var t=0;if(e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-40*e.detail),t){t/=2;var n=Math.pow(1.003,-t),r=i.getZoom();r*=n,i.setZoom(r)}},this.clear()},Openscad.Viewer.prototype={setCsg:function(e){this.gl.makeCurrent(),this.meshes=Blockscad.Viewer.csgToMeshes(e,this.defaultColor),this.onDraw()},rendered_resize:function(e,t){this.gl.canvas.width=e,this.gl.canvas.height=t,this.gl.viewport(0,0,e,t),this.gl.matrixMode(this.gl.PROJECTION),this.gl.loadIdentity(),this.gl.perspective(45,e/t,1,3e3),this.gl.matrixMode(this.gl.MODELVIEW),this.onDraw()},viewReset:function(e){if(e)var t=e;else t=document.getElementById("viewMenu").value;"diagonal"==t?(this.angleX=-60,this.angleY=0,this.angleZ=-45,this.viewpointX=0,this.viewpointY=-5,this.viewpointZ=100):"top"==t?(this.angleX=0,this.angleY=0,this.angleZ=0,this.viewpointX=0,this.viewpointY=0,this.viewpointZ=100):"bottom"==t?(this.angleX=180,this.angleY=0,this.angleZ=0,this.viewpointX=0,this.viewpointY=0,this.viewpointZ=100):"right"==t?(this.angleX=-90,this.angleY=0,this.angleZ=0,this.viewpointX=0,this.viewpointY=0,this.viewpointZ=100):"front"==t?(this.angleX=-90,this.angleY=0,this.angleZ=-90,this.viewpointX=0,this.viewpointY=0,this.viewpointZ=100):"left"==t?(this.angleX=-90,this.angleY=0,this.angleZ=180,this.viewpointX=0,this.viewpointY=0,this.viewpointZ=100):"back"==t&&(this.angleX=-90,this.angleY=0,this.angleZ=90,this.viewpointX=0,this.viewpointY=0,this.viewpointZ=100),this.onDraw()},clear:function(){this.meshes=[],this.onDraw()},supported:function(){return!!this.gl},ZOOM_MAX:1500,ZOOM_MIN:5,onZoomChanged:null,plate:!0,setZoom:function(e){e=Math.max(e,0),e=Math.min(e,1),this.viewpointZ=this.ZOOM_MIN+e*(this.ZOOM_MAX-this.ZOOM_MIN),this.onZoomChanged&&this.onZoomChanged(),this.onDraw()},getZoom:function(){return(this.viewpointZ-this.ZOOM_MIN)/(this.ZOOM_MAX-this.ZOOM_MIN)},zoomOut:function(){var e=this.getZoom();e*=1.15,this.setZoom(e)},zoomIn:function(){var e=this.getZoom();e*=.85,this.setZoom(e)},onMouseMove:function(e){if(e.dragging){var t=e.button;if(e.which&&(t=e.which),e.preventDefault(),e.altKey||3==t)this.angleY+=e.deltaX,this.angleX+=e.deltaY;else if(e.shiftKey||2==t){var n=.005;this.viewpointX+=n*e.deltaX*this.viewpointZ,this.viewpointY-=n*e.deltaY*this.viewpointZ}else if(e.ctrlKey){n=Math.pow(1.006,e.deltaX+e.deltaY);var r=this.getZoom();r*=n,this.setZoom(r)}else this.angleZ+=e.deltaX,this.angleX+=e.deltaY;this.onDraw()}},clearShift:function(){return this.touch.shiftTimer&&(clearTimeout(this.touch.shiftTimer),this.touch.shiftTimer=null),this},onPanTilt:function(e){this.touch.cur="dragging";var t=0;!this.touch.lastY||"up"!=e.gesture.direction&&"down"!=e.gesture.direction?!this.touch.lastX||"left"!=e.gesture.direction&&"right"!=e.gesture.direction||(t=e.gesture.deltaX-this.touch.lastX,this.angleZ+=t):(t=e.gesture.deltaY-this.touch.lastY,this.angleX+=t),t&&this.onDraw(),this.touch.lastX=e.gesture.deltaX,this.touch.lastY=e.gesture.deltaY},onShift:function(e){this.touch.cur="shifting";var t=0;!this.touch.lastY||"up"!=e.gesture.direction&&"down"!=e.gesture.direction||(this.touch.shiftControl.removeClass("shift-horizontal").addClass("shift-vertical").css("top",e.gesture.center.pageY+"px"),t=e.gesture.deltaY-this.touch.lastY,this.viewpointY-=.005*t*this.viewpointZ,this.angleX+=t),!this.touch.lastX||"left"!=e.gesture.direction&&"right"!=e.gesture.direction||(this.touch.shiftControl.removeClass("shift-vertical").addClass("shift-horizontal").css("left",e.gesture.center.pageX+"px"),t=e.gesture.deltaX-this.touch.lastX,this.viewpointX+=.005*t*this.viewpointZ,this.angleZ+=t),t&&this.onDraw(),this.touch.lastX=e.gesture.deltaX,this.touch.lastY=e.gesture.deltaY},onTransform:function(e){if(this.touch.cur="transforming",this.touch.scale){var t=1/(1+e.gesture.scale-this.touch.scale),n=this.getZoom();n*=t,this.setZoom(n)}return this.touch.scale=e.gesture.scale,this},onDraw:function(e,t,n){var r=this.gl;if(r.makeCurrent(),e&&r.clearColor(1,1,1,1),e&&this.meshes[0]){t+=3*Math.PI/4;var o=this.bsph,i=this.bbox,s=1.3-(i[1].z-i[0].z)/(2*o.radius),a=2.6*o.radius;r.matrixMode(r.PROJECTION),r.loadIdentity(),r.perspective(45,r.canvas.width/r.canvas.height,1,3e3),r.matrixMode(r.MODELVIEW),r.loadIdentity(),r.lookAt(o.center.x+a*Math.sin(t),o.center.y+a*Math.cos(t),o.center.z+s*a/2,o.center.x,o.center.y,o.center.z,0,0,1)}else r.matrixMode(r.PROJECTION),r.loadIdentity(),r.perspective(45,r.canvas.width/r.canvas.height,1,3e3),r.matrixMode(r.MODELVIEW),r.loadIdentity(),r.translate(this.viewpointX,this.viewpointY,-this.viewpointZ),r.rotate(this.angleX,1,0,0),r.rotate(this.angleY,0,1,0),r.rotate(this.angleZ,0,0,1);r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.enable(r.BLEND),this.lineOverlay||r.enable(r.POLYGON_OFFSET_FILL);for(var l=0;l<this.meshes.length;l++){(h=this.meshes[l]).vertices.length>0&&this.lightingShader.draw(h,r.TRIANGLES)}if(this.lineOverlay||r.disable(r.POLYGON_OFFSET_FILL),r.disable(r.BLEND),this.drawLines){this.lineOverlay&&r.disable(r.DEPTH_TEST),r.enable(r.BLEND);for(l=0;l<this.meshes.length;l++){var h;(h=this.meshes[l]).vertices.length>0&&this.blackShader.draw(h,r.LINES)}r.disable(r.BLEND),this.lineOverlay&&r.enable(r.DEPTH_TEST)}if(Blockscad.drawAxes&&!e){r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.begin(r.LINES);var c=200;if(this.plate){r.color(.8,.8,.8,.5);for(var u=-100;u<=100;u++)u%10&&0!==u&&(r.vertex(-100,u,0),r.vertex(100,u,0),r.vertex(u,-100,0),r.vertex(u,100,0),u<c/2.8&&u>-200/2.8&&(r.vertex(-.5,0,u),r.vertex(.5,0,u),r.vertex(0,-.5,u),r.vertex(0,.5,u)));r.color(.5,.5,.5,.5);for(u=10;u<=100;u+=10)0!==u&&(r.vertex(-100,u,0),r.vertex(100,u,0),r.vertex(u,-100,0),r.vertex(u,100,0),r.vertex(-100,-u,0),r.vertex(100,-u,0),r.vertex(-u,-100,0),r.vertex(-u,100,0),u<c/2.8&&(r.vertex(-1,0,u),r.vertex(1,0,u),r.vertex(0,-1,u),r.vertex(0,1,u),r.vertex(-1,0,-u),r.vertex(1,0,-u),r.vertex(0,-1,-u),r.vertex(0,1,-u)))}r.color(1,0,0,1),r.vertex(0,0,0),r.vertex(100,0,0);for(l=-100;l<0;l++)l%2&&(r.vertex(l,0,0),r.vertex(l+1,0,0));r.color(0,.7,0,1),r.vertex(0,0,0),r.vertex(0,100,0);for(l=-100;l<0;l++)l%2&&(r.vertex(0,l,0),r.vertex(0,l+1,0));r.color(.1,.1,.4,1),r.vertex(0,0,0),r.vertex(0,0,c/2.8);for(l=Math.floor(-200/2.8);l<0;l++)l%2&&(r.vertex(0,0,l),r.vertex(0,0,l+1));r.color(0,0,0,1),r.vertex(102.5,-2.5,0),r.vertex(107.5,2.5,0),r.vertex(102.5,2.5,0),r.vertex(107.5,-2.5,0),r.vertex(-2.5,110,0),r.vertex(0,107.5,0),r.vertex(0,107.5,0),r.vertex(2.5,110,0),r.vertex(0,102.5,0),r.vertex(0,107.5,0),r.vertex(-2.5,0,c/2.8+7.5),r.vertex(2.5,0,c/2.8+7.5),r.vertex(-2.5,0,c/2.8+2.5),r.vertex(2.5,0,c/2.8+2.5),r.vertex(-2.5,0,c/2.8+2.5),r.vertex(2.5,0,c/2.8+7.5),r.end(),r.disable(r.BLEND)}if(e){var p=[];p[0]=this.gl.canvas.toDataURL("image/jpeg",e);var f=document.createElement("canvas"),d=f.getContext("2d");f.height=.5*this.gl.canvas.height,f.width=.5*this.gl.canvas.height,d.drawImage(this.gl.canvas,0,0,f.width,f.height);var g=document.createElement("canvas"),m=g.getContext("2d");return g.height=.5*f.height,g.width=.5*f.width,m.drawImage(f,0,0,.5*f.width,.5*f.height),p[1]=g.toDataURL("image/jpeg",e),p}if(n)return this.gl.canvas.toDataURL("image/jpeg",n)},takePic:function(e,t){return this.onDraw(e,t)},takeCameraPic:function(e){return this.onDraw(0,0,e)}},Openscad.Viewer.csgToMeshes=function(e,t){for(var n=e.canonicalized(),r=new GL.Mesh({normals:!0,colors:!0}),o=[r],i={},s=[],a=[],l=[],h=n.toPolygons(),c=h.length,u=0;u<c;u++){var p=h[u],f=t;p.shared&&p.shared.color&&(f=p.shared.color),p.color&&(f=p.color),f.length<4&&f.push(1);for(var d=p.vertices.map(function(e){var t,n=e.getTag();return t=s.length,i[n]=t,s.push([e.pos.x,e.pos.y,e.pos.z]),a.push(f),t}),g=2;g<d.length;g++)l.push([d[0],d[g-1],d[g]]);s.length>65e3&&(r.triangles=l,r.vertices=s,r.colors=a,r.computeWireframe(),r.computeNormals(),r=new GL.Mesh({normals:!0,colors:!0}),l=[],a=[],s=[],o.push(r))}return r.triangles=l,r.vertices=s,r.colors=a,r.computeWireframe(),r.computeNormals(),o},Openscad.makeAbsoluteUrl=function(e,t){if(!e.match(/^[a-z]+\:/i)){var n=t.split("/");n.length>0&&n.splice(n.length-1,1);var r=e.split("/"),o=n.concat(r),i=[];o.map(function(e){".."==e?i.length>0&&i.splice(i.length-1,1):i.push(e)}),e="";for(var s=0;s<i.length;s++)s>0&&(e+="/"),e+=i[s]}return e},Openscad.isChrome=function(){return navigator.userAgent.search("Chrome")>=0},Openscad.parseCodeInWorker=function(e,t,n){try{var r=openscadOpenJscadParser.parse(e);if(!r||!r.length)throw new Error("parser produced no output at all");self.postMessage({cmd:"parsed",err:"haha"}),Blockscad.runMainInWorker(r)}catch(e){var o=e.toString();self.postMessage({cmd:"errorParse",err:o})}},Openscad.runMainInWorker=function(e){var t=new Function(e);try{if("function"!=typeof t)throw new Error("Your code has an error somewhere.  Parsing your blocks failed.");var n=t();if("object"!=typeof n[0]||!(n[0]instanceof CSG||n[0]instanceof CAG))throw new Error("Nothing to Render!");var r=n[0];if(r instanceof CAG&&(r=r.extrude({offset:[0,0,.1]})),1==n.length){var o=r.toCompactBinary();self.postMessage({cmd:"finalMesh",result:o})}else{var i=n[0],s=n.slice(1);(i=i.union(s))instanceof CAG&&(i=i.extrude({offset:[0,0,.1]})),self.postMessage({cmd:"log",txt:"number of polys final: "+i.polygons.length});var a=i.toCompactBinary();self.postMessage({cmd:"finalMesh",result:a}),n=null}}catch(e){var l=e.toString();self.postMessage({cmd:"error",err:l})}},Openscad.parseBlockscadScriptSync=function(e,t){var n="//SYNC\n";return n+="_includePath = "+JSON.stringify(_includePath)+";\n",n+=e,n+="return main();",n+="function include(fn) {if(0) {_csg_libraries.push(fn);} else if(0) {var url = _includePath!=='undefined'?_includePath:'./';var index = url.indexOf('index.html');if(index!=-1) {url = url.substring(0,index);}importScripts(url+fn);} else {var xhr = new XMLHttpRequest();xhr.open('GET',_includePath+fn,false);console.log('include:'+_includePath+fn);xhr.onload = function() {var src = this.responseText;eval(src);};xhr.onerror = function() {};xhr.send();}}",new Function(n)()},Openscad.parseBlockscadScriptASync=function(e,t){var n=document.location.href.replace(/\?.*$/,""),r=n=n.replace(/#.*$/,""),o="//ASYNC\n";o+="var _csg_baseurl="+JSON.stringify(n)+";\n";o+="\n\n\n\n//// The following code was added by BlocksCAD:\n",o+="var _csg_baselibraries="+JSON.stringify(["openscad/csg.js","openscad/formats.js","opentype/dist/opentype.min.js","openscad/viewer.js","openscad/underscore.js","openscad/openscad-openjscad-translator.js"])+";\n",o+="var _csg_libraries="+JSON.stringify([])+";\n",o+="var _csg_blockscadurl="+JSON.stringify(r)+";\n",o+="var _csg_makeAbsoluteURL="+Openscad.makeAbsoluteUrl.toString()+";\n",o+="_csg_baselibraries = _csg_baselibraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_openscadurl);});\n",o+="_csg_libraries = _csg_libraries.map(function(l){return _csg_makeAbsoluteURL(l,_csg_baseurl);});\n",o+="_csg_baselibraries.map(function(l){importScripts(l)});\n",o+="_csg_libraries.map(function(l){importScripts(l)});\n",o+="self.addEventListener('message', function(e) {if(e.data && e.data.cmd == 'render'){",o+="Openscad.resolution = "+Openscad.resolution+";",o+="Openscad.csg_filename = e.data.csg_filename;",o+="Openscad.csg_commands = e.data.csg_commands;",o+="Openscad.fonts = {};",o+="var fontkeys = e.data.fontkeys;",o+="var fontdata = e.data.fontdata;",o+="for (var i = 0; i < fontkeys.length; i++) {",o+="  Openscad.fonts[fontkeys[i]] = opentype.parse(fontdata[i]); }",o+="  Openscad.parseCodeInWorker(e.data.data);",o+="}},false);\n";var i=Openscad.textToBlobUrl(o);if(!window.Worker)throw new Error("Your browser doesn't support Web Workers. Please try the Chrome or Firefox browser instead.");var s=new Worker(i);s.onmessage=function(e){if(e.data)if("rendered"==e.data.cmd||"finalMesh"==e.data.cmd){var n,r=e.data.result.class;if("CSG"==r)n=CSG.fromCompactBinary(e.data.result);else{if("CAG"!=r)throw new Error("cannot parse final result");n=CAG.fromCompactBinary(e.data.result)}t(e.data.cmd,n)}else"error"==e.data.cmd?t(e.data.err,null):"errorParse"==e.data.cmd?(console.log("caught parsing error:",e.data.err),$("#error-message").html(e.data.err),$("#error-message").addClass("has-error"),t(e.data.err,null)):"parsed"==e.data.cmd?$("#render-ongoing").html(Openscad.Msg.RENDER_IN_PROGRESS+'<img id=busy src="imgs/busy2.gif">'):"log"==e.data.cmd&&console.log(e.data.txt)},s.onerror=function(e){var n="Error in line "+e.lineno+": "+e.message;t(n,null)};var a=[],l=[];for(var h in Blockscad.fonts)a.push(h),l.push(Blockscad.fonts[h]);return s.postMessage({cmd:"render",data:e,fontkeys:a,fontdata:l,csg_filename:Openscad.csg_filename,csg_commands:Openscad.csg_commands}),s},Openscad.getWindowURL=function(){if(window.URL)return window.URL;if(window.webkitURL)return window.webkitURL;throw new Error("Your browser doesn't support window.URL")},Openscad.textToBlobUrl=function(e){var t=Blockscad.getWindowURL(),n=new Blob([e]),r=t.createObjectURL(n);if(!r)throw new Error("createObjectURL() failed");return r},Openscad.revokeBlobUrl=function(e){if(window.URL)window.URL.revokeObjectURL(e);else{if(!window.webkitURL)throw new Error("Your browser doesn't support window.URL");window.webkitURL.revokeObjectURL(e)}},Openscad.AlertUserOfUncaughtExceptions=function(){window.onerror=function(e,t,n){e=e.replace(/^Uncaught /i,""),alert(e+"\n\n("+t+" line "+n+")")}},Openscad.Processor=function(e,t){this.containerdiv=e,this.onchange=t,this.viewerdiv=null,this.picdiv=null,this.viewer=null,this.picviewer=null,this.rpicviewer=null,this.initialViewerDistance=100,this.processing=!1,this.currentObject=null,this.hasValidCurrentObject=!1,this.hasOutputFile=!1,this.worker=null,this.paramDefinitions=[],this.paramControls=[],this.script=null,this.hasError=!1,this.debugging=!1,this.thumbnail="none",this.imgStrip="none",this.img="none",this.createElements()},Openscad.Processor.convertToSolid=function(e){if("object"!=typeof e||!(e instanceof CAG||e instanceof CSG))throw new Error("Cannot convert to solid");return e},Openscad.Processor.prototype={createElements:function(){for(var e=this;this.containerdiv.children.length>7;)this.containerdiv.removeChild(7);var t=document.createElement("div");t.style.width="100%",t.style.height="100%",t.style.top="0px",t.style.position="absolute",t.style.zIndex="9",this.containerdiv.appendChild(t),this.viewerdiv=t;var n=document.createElement("div");n.setAttribute("id","picdiv"),n.style.width=Openscad.picSize[0]+"px",n.style.height=Openscad.picSize[1]+"px",n.style.top="0px",n.style.right="10px",n.style.position="absolute",n.style.zIndex="-1",document.getElementById("blocklyDiv").appendChild(n),this.picdiv=n;var r=document.createElement("div");r.setAttribute("id","picdiv"),r.style.width=Openscad.rpicSize[0]+"px",r.style.height=Openscad.rpicSize[1]+"px",r.style.top="0px",r.style.right="10px",r.style.position="absolute",r.style.zIndex="-1",document.getElementById("blocklyDiv").appendChild(r),this.rpicdiv=r;try{this.picviewer=new Openscad.Viewer(this.picdiv,n.offsetWidth,n.offsetHeight,this.initialViewerDistance)}catch(e){this.picdiv.innerHTML="<b><br><br>Error: "+e.toString()+"</b><br><br>BlocksCAD currently requires Google Chrome or Firefox with WebGL enabled"}$("#picdiv").addClass("hidden");try{this.rpicviewer=new Openscad.Viewer(this.rpicdiv,r.offsetWidth,r.offsetHeight,this.initialViewerDistance)}catch(e){this.rpicdiv.innerHTML="<b><br><br>Error: "+e.toString()+"</b><br><br>BlocksCAD currently requires Google Chrome or Firefox with WebGL enabled"}$("#rpicdiv").addClass("hidden");try{this.viewer=new Openscad.Viewer(this.viewerdiv,t.offsetWidth,t.offsetHeight,this.initialViewerDistance)}catch(e){this.viewerdiv.innerHTML="<b><br><br>Error: "+e.toString()+"</b><br><br>OpenSCAD currently requires Google Chrome or Firefox with WebGL enabled"}this.abortbutton=document.getElementById("abortButton"),this.renderbutton=document.getElementById("renderButton"),this.ongoingrender=document.getElementById("render-ongoing"),this.abortbutton.onclick=function(t){e.abort()},this.formatDropdown=document.getElementById("render-type"),this.formatDropdown.onchange=function(t){e.currentFormat=e.formatDropdown.options[e.formatDropdown.selectedIndex].value,e.updateDownloadLink()},this.generateOutputFileButton=document.getElementById("stlButton"),this.generateOutputFileButton.onclick=function(t){e.generateOutputFile()},this.enableItems()},setCurrentObject:function(e,t){var n=Blockscad.Processor.convertToSolid(e);if(this.currentObject=n,this.hasValidCurrentObject=!0,this.viewer&&this.viewer.setCsg(n),this.picviewer&&(this.picviewer.bbox=n.getBounds(),this.picviewer.bsph=n.getBoundingSphere(),this.picviewer.setCsg(n)),this.rpicviewer&&(this.rpicviewer.bbox=n.getBounds(),this.rpicviewer.bsph=n.getBoundingSphere(),this.rpicviewer.setCsg(n)),t){for($("#stl_buttons").removeClass("hidden");this.formatDropdown.options.length>0;)this.formatDropdown.options.remove(0);var r=this;this.supportedFormatsForCurrentObject().forEach(function(e){var t=document.createElement("option");t.setAttribute("value",e),t.appendChild(document.createTextNode(r.formatInfo(e).displayName)),r.formatDropdown.options.add(t)}),this.updateDownloadLink()}},selectedFormat:function(){return this.formatDropdown.options[this.formatDropdown.selectedIndex].value},selectedFormatInfo:function(){return this.formatInfo(this.selectedFormat())},updateDownloadLink:function(){var e=this.selectedFormatInfo().extension;this.generateOutputFileButton.innerHTML=Openscad.Msg.GENERATE_STL+" "+e.toUpperCase()},clearViewer:function(){this.clearOutputFile(),this.setCurrentObject(new CSG),this.hasValidCurrentObject=!1,this.thumbnail="none",this.imgStrip="none",this.img="none",$("#stl_buttons").addClass("hidden"),this.enableItems()},abort:function(){this.processing&&($("#renderButton").prop("disabled",!1),$("#render-ongoing").html(Openscad.Msg.PARSE_IN_PROGRESS+'<img id=busy src="imgs/busy2.gif">'),this.processing=!1,this.worker.terminate(),this.enableItems(),this.onchange&&this.onchange())},enableItems:function(){this.abortbutton.style.display=this.processing?"inline-block":"none",this.renderbutton.style.display=this.processing?"none":"inline-block",this.ongoingrender.style.display=this.processing?"inline-block":"none"},setError:function(e){this.hasError=""!=e,$("#error-message").text(e),this.enableItems()},setDebugging:function(e){this.debugging=e},setBlockscad:function(e){this.script=e,this.rebuildSolid()},rebuildSolid:function(){this.abort(),this.setError(""),this.clearViewer(),this.processing=!0,$("#renderButton").html(Openscad.Msg.RENDER_BUTTON),$("#renderButton").prop("disabled",!1),this.enableItems();var e=this,t=this.debugging;if(!t)try{this.worker=Openscad.parseBlockscadScriptASync(this.script,function(t,n){if(t&&"finalMesh"==t){$("#render-ongoing").html(Openscad.Msg.PARSE_IN_PROGRESS+'<img id=busy src="imgs/busy2.gif">'),e.processing=!1,e.setCurrentObject(n,!0);var r=e.picviewer.takePic(Openscad.picQuality,0,1);e.img=r[0],e.thumbnail=r[1],e.imgStrip=e.takeRotatingPic(1,Openscad.numRotPics),e.processing=!1,e.worker=null}else if(t&&"rendered"==t){$("#render-ongoing").html('Prepare for Download...<img id=busy src="imgs/busy2.gif">'),e.setCurrentObject(n,!1);r=e.picviewer.takePic(Openscad.picQuality,0,1);e.img=r[0],e.thumbnail=r[1],e.imgStrip=e.takeRotatingPic(1,Openscad.numRotPics)}else console.log("what is going on?"),console.log("error in proc"+t),e.processing=!1,e.worker=null,e.setError(t);e.onchange&&e.onchange(),e.enableItems()})}catch(e){console.log("async failed, try sync compute, error: "+e.message),t=!0}if(t){try{var n=Openscad.parseOpenscadScriptSync(this.script,this.debugging);e.setCurrentObject(n),e.processing=!1}catch(t){e.processing=!1;var r=t.stack;r||(r=t.toString()),e.setError(r)}e.enableItems(),e.onchange&&e.onchange()}},hasSolid:function(){return this.hasValidCurrentObject},isProcessing:function(){return this.processing},clearOutputFile:function(){this.hasOutputFile&&(this.outputFileBlobUrl&&(Openscad.revokeBlobUrl(this.outputFileBlobUrl),this.outputFileBlobUrl=null),this.enableItems(),this.onchange&&this.onchange())},generateOutputFile:function(){this.clearOutputFile(),this.hasValidCurrentObject&&this.generateAndSaveRenderedFile()},currentObjectToBlob:function(){var e,t=this.selectedFormat();if("stla"==t)e=this.currentObject.toStlString(),e=new Blob([e],{type:"text/plain; charset=utf-8"});else if("stlb"==t)e=this.currentObject.toStlBinary({webBlob:!0});else if("amf"==t)e=this.currentObject.toAMFString({producer:"OpenSCAD "+Openscad.version,date:new Date}),e=new Blob([e],{type:"text/plain; charset=utf-8"});else if("x3d"==t)e=this.currentObject.toX3D(),e=new Blob([e],{type:"text/plain; charset=utf-8"});else if("dxf"==t)e=this.currentObject.toDxf(),e=new Blob([e],{type:"text/plain; charset=utf-8"});else{if("obj"!=t)throw new Error("Not supported");e=this.currentObject.toObj(),e=new Blob([e],{type:"text/plain; charset=utf-8"})}return e},supportedFormatsForCurrentObject:function(){if(this.currentObject instanceof CSG)return-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")?["stla","amf","x3d"]:["stlb","stla","x3d","obj","amf"];if(this.currentObject instanceof CAG)return["dxf"];throw new Error("Not supported")},formatInfo:function(e){return{stla:{displayName:"STL (ASCII)",extension:"stl",mimetype:"application/sla"},obj:{displayName:"OBJ (ASCII)",extension:"obj",mimetype:"application/sla"},stlb:{displayName:"STL (Binary)",extension:"stl",mimetype:"application/sla"},amf:{displayName:"AMF",extension:"amf",mimetype:"application/amf+xml"},x3d:{displayName:"X3D",extension:"x3d",mimetype:"model/x3d+xml"},dxf:{displayName:"DXF",extension:"dxf",mimetype:"application/dxf"}}[e]},generateAndSaveRenderedFile:function(){var e=this.currentObjectToBlob(),t=this.selectedFormatInfo().extension,n=$("#project-name").val();n?saveAs(e,n+"."+t):($("#message-text").html("<h4>"+Openscad.Msg.SAVE_FAILED+" "+Openscad.Msg.SAVE_FAILED_PROJECT_NAME+".</h4>"),$("#message-modal").modal())},takeRotatingPic:function(e,t){var n=[],r=[],o=document.createElement("canvas");o.width=Openscad.rpicSize[0]*t,o.height=Openscad.rpicSize[0];for(var i=o.getContext("2d"),s=0;s<t;s+=1){var a=-s*(2*Math.PI/t);n[s]=this.rpicviewer.takePic(e,a)[0],r[s]=new Image,r[s].src=n[s],i.drawImage(r[s],s*Openscad.rpicSize[0],0)}return o.toDataURL("image/jpeg")}},Openscad.pathToPoints=function(e,t){var n,r,o,i,s,a,l=[],h=[],c=[],u=2;if(t>2&&(u=t),u>10&&(u=10),e&&e.commands&&e.commands.length>0)for(var p=0,f=[],d=0;d<e.commands.length;d++)switch(e.commands[d].type){case"M":c.length>2&&h.push(c),c=[],l.push([e.commands[d].x,-1*e.commands[d].y]),c.push(p++),f=[e.commands[d].x,-1*e.commands[d].y];break;case"L":l.push([e.commands[d].x,-1*e.commands[d].y]),c.push(p++),f=[e.commands[d].x,-1*e.commands[d].y];break;case"C":n=[e.commands[d].x,-1*e.commands[d].y],r=[e.commands[d].x1,-1*e.commands[d].y1],o=[e.commands[d].x2,-1*e.commands[d].y2];for(var g=1;g<=u;g++)a=g/u,i=f[0]*Math.pow(1-a,3)+3*r[0]*Math.pow(1-a,2)*a+3*o[0]*Math.pow(1-a,1)*a*a+n[0]*Math.pow(a,3),i=f[1]*Math.pow(1-a,3)+3*r[1]*Math.pow(1-a,2)*a+3*o[1]*Math.pow(1-a,1)*a*a+n[1]*Math.pow(a,3),l.push([i,s]),c.push(p++);f=n;break;case"Q":n=[e.commands[d].x,-1*e.commands[d].y],r=[e.commands[d].x1,-1*e.commands[d].y1];for(g=1;g<=u;g++)a=g/u,i=f[0]*Math.pow(1-a,2)+2*r[0]*Math.pow(1-a,1)*a+n[0]*Math.pow(a,2),s=f[1]*Math.pow(1-a,2)+2*r[1]*Math.pow(1-a,1)*a+n[1]*Math.pow(a,2),l.push([i,s]),c.push(p++);f=n;break;case"Z":c.length>2&&(h.push(c),c=[])}return l.length<3&&(l=[]),[l,h]},function(e){function t(e,t){return e-t}var n=function(){this.polygons=[],this.properties=new n.Properties,this.isCanonicalized=!0,this.isRetesselated=!0};function r(e,t,n){for(var r=0,o=e.length;o>r;){var i=Math.floor((r+o)/2);n(t,e[i])>0?r=i+1:o=i}e.splice(r,0,t)}n.defaultResolution2D=32,n.defaultResolution3D=12,n.fromPolygons=function(e){var t=new n;return t.polygons=e,t.isCanonicalized=!1,t.isRetesselated=!1,t},n.fromSlices=function(e){return new n.Polygon.createFromPoints([[0,0,0],[1,0,0],[1,1,0],[0,1,0]]).solidFromSlices(e)},n.fromObject=function(e){var t=e.polygons.map(function(e){return n.Polygon.fromObject(e)}),r=n.fromPolygons(t);return r.isCanonicalized=e.isCanonicalized,r.isRetesselated=e.isRetesselated,r},n.uniqBy=function(e,t){var n={};return e.filter(function(e){var r=t(e);return!n.hasOwnProperty(r)&&(n[r]=!0)})},n.fromCompactBinary=function(e){if("CSG"!=e.class)throw new Error("Not a CSG");for(var t,r,o,i,s,a,l=[],h=e.planeData,c=h.length/4,u=0,p=0;p<c;p++)t=h[u++],r=h[u++],o=h[u++],i=h[u++],s=n.Vector3D.Create(t,r,o),a=new n.Plane(s,i),l.push(a);var f,d,g=[],m=e.vertexData,v=m.length/3;u=0;for(var x=0;x<v;x++)t=m[u++],r=m[u++],o=m[u++],f=n.Vector3D.Create(t,r,o),d=new n.Vertex(f),g.push(d);var y,w,P,_,V=e.shared.map(function(e){return n.Polygon.Shared.fromObject(e)}),D=[],b=e.numPolygons,C=e.numVerticesPerPolygon,S=e.polygonVertices,O=e.polygonPlaneIndexes,M=e.polygonSharedIndexes;u=0;for(var T=0;T<b;T++){y=C[T],w=[];for(var A=0;A<y;A++)w.push(g[S[u++]]);a=l[O[T]],P=V[M[T]],_=new n.Polygon(w,P,a),D.push(_)}var z=n.fromPolygons(D);return z.isCanonicalized=!0,z.isRetesselated=!0,z},n.prototype={toPolygons:function(){return this.polygons},union:function(e){var t;e instanceof Array?(t=e.slice(0)).push(this):t=[this,e];for(var n=1;n<t.length;n+=2)t.push(t[n-1].unionSub(t[n]));return t[n-1].reTesselated().canonicalized()},unionSub:function(e,t,r){if(this.mayOverlap(e)){var o=new n.Tree(this.polygons),i=new n.Tree(e.polygons);o.clipTo(i,!1),i.clipTo(o),i.invert(),i.clipTo(o),i.invert();var s=o.allPolygons().concat(i.allPolygons()),a=n.fromPolygons(s);return a.properties=this.properties._merge(e.properties),t&&(a=a.reTesselated()),r&&(a=a.canonicalized()),a}return this.unionForNonIntersecting(e)},unionForNonIntersecting:function(e){var t=this.polygons.concat(e.polygons),r=n.fromPolygons(t);return r.properties=this.properties._merge(e.properties),r.isCanonicalized=this.isCanonicalized&&e.isCanonicalized,r.isRetesselated=this.isRetesselated&&e.isRetesselated,r},subtract:function(e){var t;t=e instanceof Array?e:[e];for(var n=this,r=0;r<t.length;r++){var o=r==t.length-1;n=n.subtractSub(t[r],o,o)}return n},subtractSub:function(e,t,r){var o=new n.Tree(this.polygons),i=new n.Tree(e.polygons);o.invert(),o.clipTo(i),i.clipTo(o,!0),o.addPolygons(i.allPolygons()),o.invert();var s=n.fromPolygons(o.allPolygons());return s.properties=this.properties._merge(e.properties),t&&(s=s.reTesselated()),r&&(s=s.canonicalized()),s},intersect:function(e){var t;t=e instanceof Array?e:[e];for(var n=this,r=0;r<t.length;r++){var o=r==t.length-1;n=n.intersectSub(t[r],o,o)}return n},intersectSub:function(e,t,r){var o=new n.Tree(this.polygons),i=new n.Tree(e.polygons);o.invert(),i.clipTo(o),i.invert(),o.clipTo(i),i.clipTo(o),o.addPolygons(i.allPolygons()),o.invert();var s=n.fromPolygons(o.allPolygons());return s.properties=this.properties._merge(e.properties),t&&(s=s.reTesselated()),r&&(s=s.canonicalized()),s},hull:function(e){var t=e,r=[];r.push(this);for(var o=0;o<t.length;o++)r.push(t[o]);for(o=0;o<r.length;o++){if(!(r[o]instanceof n))throw"ERROR: don't mix 2D and 3D shapes in hull"}var i=function(e){Array.isArray(e)||(e=[e]);for(var t=[],r=0;r<e.length;r++)for(var o=0;o<e[r].polygons.length;o++)for(var i=0;i<e[r].polygons[o].vertices.length;i++)t.push([e[r].polygons[o].vertices[i].pos._x,e[r].polygons[o].vertices[i].pos._y,e[r].polygons[o].vertices[i].pos._z]);var s=n.uniqBy(t,JSON.stringify),a=[];for(r=0;r<s.length;r++)a.push(n.Vector3D.Create(s[r][0],s[r][1],s[r][2]));return a}(r),s=function(e){return e[0].polygons[0].shared?e[0].polygons[0].shared.color:null}(r),a=(new n.quickHull3D).build(i),l=[];for(o=0;o<a.length;o++){for(var h=[],c=0;c<a[o].length;c++)h.push(i[a[o][c]]);var u=new n.Polygon.createFromPoints(h);s&&u.sC(s),l.push(u)}var p=n.fromPolygons(l);return p.isCanonicalized=!0,p.isRetesselated=!0,n.fromPolygons(l)},invert:function(){var e=this.polygons.map(function(e){return e.flipped()});return n.fromPolygons(e)},transform1:function(e){var t=this.polygons.map(function(t){return t.transform(e)}),r=n.fromPolygons(t);return r.properties=this.properties._transform(e),r.isRetesselated=this.isRetesselated,r},transform:function(e){var t=e.isMirroring(),r={},o={},i=this.polygons.map(function(i){var s,a=i.plane,l=a.getTag();l in o?s=o[l]:(s=a.transform(e),o[l]=s);var h=i.vertices.map(function(t){var n,o=t.getTag();return o in r?n=r[o]:(n=t.transform(e),r[o]=n),n});return t&&h.reverse(),new n.Polygon(h,i.shared,s)}),s=n.fromPolygons(i);return s.properties=this.properties._transform(e),s.isRetesselated=this.isRetesselated,s.isCanonicalized=this.isCanonicalized,s},taper:function(e,t){t<=0&&(t=1e-4);var r=this.getBounds(),o=0,i=0;e[0]?(o=r[1].x-r[0].x,i=r[0].x):e[1]?(o=r[1].y-r[0].y,i=r[0].y):e[2]&&(o=r[1].z-r[0].z,i=r[0].z);for(var s=[],a=[],l=[],h=null,c=0;c<this.polygons.length;c++)if(h=this.polygons[c].shared?this.polygons[c].shared.color:null,this.polygons[c].vertices.length>3){var u=[(g=this.polygons[c].vertices)[0].pos.x,g[0].pos.y,g[0].pos.z];a=[],l=[];for(var p=1;p<this.polygons[c].vertices.length-1;p++)l=[],(a=[])[0]=u,a[1]=[g[p].pos.x,g[p].pos.y,g[p].pos.z],a[2]=[g[p+1].pos.x,g[p+1].pos.y,g[p+1].pos.z],l=new n.Polygon.createFromPoints(a),h&&l.sC(h),s.push(l)}else s.push(this.polygons[c]);var f=[],d=[];for(c=0;c<s.length;c++){h=s[c].shared?s[c].shared.color:null,d=[];for(p=0;p<s[c].vertices.length;p++){s[c].vertices.length>3&&console.log("bad facet - more than 3 vertices!");var g=s[c].vertices[p].pos;if(e[0])var m=g.x,v=g.y*(1+(t-1)*(g.x-i)/o),x=g.z*(1+(t-1)*(g.x-i)/o);else if(e[1])v=g.y,m=g.x*(1+(t-1)*(g.y-i)/o),x=g.z*(1+(t-1)*(g.y-i)/o);else x=g.z,v=g.y*(1+(t-1)*(g.z-i)/o),m=g.x*(1+(t-1)*(g.z-i)/o);d[p]=[m,v,x]}f[c]=new n.Polygon.createFromPoints(d),h&&f[c].sC(h)}return n.fromPolygons(f)},toString:function(){var e="CSG solid:\n";return this.polygons.map(function(t){e+=t.toString()}),e},expand:function(e,t){var n=this.expandedShell(e,t,!0);return(n=n.reTesselated()).properties=this.properties,n},contract:function(e,t){var n=this.expandedShell(e,t,!1),r=this.subtract(n);return(r=r.reTesselated()).properties=this.properties,r},stretchAtPlane:function(e,t,r){var o=n.Plane.fromNormalAndPoint(e,t),i=new n.OrthoNormalBasis(o),s=this.sectionCut(i).extrudeInOrthonormalBasis(i,r),a=this.cutByPlane(o),l=this.cutByPlane(o.flipped());return a.union([s,l.tr(o.normal.times(r))])},expandedShell:function(e,r,o){var i,s=this.reTesselated();i=o?s:new n,s.polygons.map(function(t){var n=t.plane.normal.unit().times(2*e),r=t.tr(n.times(-.5)).extrude(n);i=i.unionSub(r,!1,!1)});var a={};for(var l in s.polygons.map(function(e){for(var t=e.vertices.length,n=e.vertices[t-1],r=n.getTag(),o=0;o<t;o++){var i,s,l=e.vertices[o],h=l.getTag();(i=h<r?h+"-"+r:r+"-"+h)in a?s=a[i]:(s={v1:n,v2:l,planenormals:[]},a[i]=s),s.planenormals.push(e.plane.normal),r=h,n=l}}),a){for(var h=a[l],c=h.v1.pos,u=h.v2.pos,p=u.minus(c).unit(),f=h.planenormals[0].unit(),d=f.cross(p),g=[],m=0;m<r;m++)g.push(m*Math.PI*2/r);m=0;for(var v=h.planenormals.length;m<v;m++){var x=h.planenormals[m],y=d.dot(x),w=f.dot(x);(S=Math.atan2(y,w))<0&&(S+=2*Math.PI),g.push(S),(S=Math.atan2(-y,-w))<0&&(S+=2*Math.PI),g.push(S)}var P,_,V=(g=g.sort(t)).length,D=[],b=[],C=[];for(m=-1;m<V;m++){var S=g[m<0?m+V:m],O=(y=Math.sin(S),w=Math.cos(S),f.times(w*e).plus(d.times(y*e))),M=c.plus(O),T=u.plus(O),A=!1;if(m>=0&&M.distanceTo(P)<1e-5&&(A=!0),!A){if(m>=0){D.push(new n.Vertex(M)),b.push(new n.Vertex(T));var z=[new n.Vertex(_),new n.Vertex(T),new n.Vertex(M),new n.Vertex(P)],E=new n.Polygon(z);C.push(E)}P=M,_=T}}b.reverse(),C.push(new n.Polygon(D)),C.push(new n.Polygon(b));var F=n.fromPolygons(C);i=i.unionSub(F,!1,!1)}var B={};for(var I in s.polygons.map(function(e){e.vertices.map(function(t){var n,r=t.getTag();r in B?n=B[r]:(n={pos:t.pos,normals:[]},B[r]=n),n.normals.push(e.plane.normal)})}),B){var N=B[I],L=N.normals[0].unit(),k=null,R=0;for(m=1;m<N.normals.length;m++){var j=N.normals[m].unit(),G=L.cross(j).length();G>.05&&G>R&&(R=G,k=j)}k||(k=L.randomNonParallelVector());var Z=L.cross(k).unit(),Y=Z.cross(L),X=n.sphere({center:N.pos,radius:e,resolution:r,axes:[L,Z,Y]});i=i.unionSub(X,!1,!1)}return i},canonicalized:function(){if(this.isCanonicalized)return this;var e=(new n.fuzzyCSGFactory).getCSG(this);return e.isCanonicalized=!0,e.isRetesselated=this.isRetesselated,e.properties=this.properties,e},reTesselated:function(){if(this.isRetesselated)return this;var e={},t=this.isCanonicalized,r=new n.fuzzyCSGFactory;this.polygons.map(function(n){var o=n.plane,i=n.shared;t||(o=r.getPlane(o),i=r.getPolygonShared(i));var s=o.getTag()+"/"+i.getTag();s in e?e[s].push(n):e[s]=[n]});var o=[];for(var i in e){var s=e[i];if(s.length<2)o=o.concat(s);else{var a=[];n.reTesselateCoplanarPolygons(s,a),o=o.concat(a)}}var l=n.fromPolygons(o);return l.isRetesselated=!0,l.properties=this.properties,l},getBounds:function(){if(!this.cachedBoundingBox){for(var e=new n.Vector3D(0,0,0),t=new n.Vector3D(0,0,0),r=this.polygons,o=r.length,i=0;i<o;i++){var s=r[i].boundingBox();0===i?(e=s[0],t=s[1]):(e=e.min(s[0]),t=t.max(s[1]))}this.cachedBoundingBox=[e,t]}return this.cachedBoundingBox},getBoundingSphere:function(){if(!this.cachedBoundingSphere){for(var e,t={center:(e=this.cachedBoundingBox?this.cachedBoundingBox:this.getBounds())[0].plus(e[1]).dividedBy(2),radius:0},r=0;r<this.polygons.length;r++)for(var o=0;o<this.polygons[r].vertices.length;o++){var i=this.polygons[r].vertices[o];t.radius=Math.max(t.radius,new n.Vector3D(i.pos.x,i.pos.y,i.pos.z).minus(t.center).lengthSquared())}t.radius=Math.sqrt(t.radius),this.cachedBoundingSphere=t}return this.cachedBoundingSphere},mayOverlap:function(e){if(0===this.polygons.length||0===e.polygons.length)return!1;var t=this.getBounds(),n=e.getBounds();return!(t[1].x<n[0].x)&&(!(t[0].x>n[1].x)&&(!(t[1].y<n[0].y)&&(!(t[0].y>n[1].y)&&(!(t[1].z<n[0].z)&&!(t[0].z>n[1].z)))))},cutByPlane:function(e){if(0===this.polygons.length)return new n;var t=e.normal.times(e.w),r=0;this.polygons.map(function(e){e.vertices.map(function(e){var n=e.pos.distanceToSquared(t);n>r&&(r=n)})}),r=Math.sqrt(r),r*=1.01;var o=[],i=new n.OrthoNormalBasis(e);o.push(new n.Vertex(i.to3D(new n.Vector2D(r,-r)))),o.push(new n.Vertex(i.to3D(new n.Vector2D(-r,-r)))),o.push(new n.Vertex(i.to3D(new n.Vector2D(-r,r)))),o.push(new n.Vertex(i.to3D(new n.Vector2D(r,r))));var s=new n.Polygon(o,null,e.flipped()).extrude(e.normal.times(-r)),a=this.intersect(s);return a.properties=this.properties,a},connectTo:function(e,t,n,r){var o=e.getTransformationTo(t,n,r);return this.transform(o)},setShared:function(e){var t=this.polygons.map(function(t){return new n.Polygon(t.vertices,e,t.plane)}),r=n.fromPolygons(t);return r.properties=this.properties,r.isRetesselated=this.isRetesselated,r.isCanonicalized=this.isCanonicalized,r},sC:function(e){var t=n.Polygon.Shared.fromColor.apply(this,arguments);return this.setShared(t)},toCompactBinary:function(){var e=this.canonicalized(),t=e.polygons.length,n=0,r=0,o={},i=[],s=0,a={},l=0,h=[],c=[],u={},p=0;e.polygons.map(function(e){e.vertices.map(function(e){++n;var t=e.getTag();t in o||(o[t]=r++,i.push(e))});var t=e.plane.getTag();t in a||(a[t]=s++,h.push(e.plane));var l=e.shared.getTag();l in u||(u[l]=p++,c.push(e.shared))});var f=new Uint32Array(t),d=new Uint32Array(t),g=new Uint32Array(n),m=new Uint32Array(t),v=new Float64Array(3*r),x=new Float64Array(4*s),y=0;for(l=0;l<t;++l){var w=e.polygons[l];f[l]=w.vertices.length,w.vertices.map(function(e){var t=e.getTag(),n=o[t];g[y++]=n});var P=w.plane.getTag(),_=a[P];m[l]=_;var V=w.shared.getTag(),D=u[V];d[l]=D}var b=0;i.map(function(e){var t=e.pos;v[b++]=t._x,v[b++]=t._y,v[b++]=t._z});var C=0;return h.map(function(e){var t=e.normal;x[C++]=t._x,x[C++]=t._y,x[C++]=t._z,x[C++]=e.w}),{class:"CSG",numPolygons:t,numVerticesPerPolygon:f,polygonPlaneIndexes:m,polygonSharedIndexes:d,polygonVertices:g,vertexData:v,planeData:x,shared:c}},toPointCloud:function(e){var t=this.reTesselated(),r=new n,o={};for(var i in t.polygons.map(function(e){e.vertices.map(function(e){o[e.getTag()]=e.pos})}),o){var s=o[i],a=n.cube({center:s,radius:e});r=r.unionSub(a,!1,!1)}return r=r.reTesselated()},getTransformationAndInverseTransformationToFlatLying:function(){if(0===this.polygons.length){var e=new n.Matrix4x4;return[e,e]}var t=this.canonicalized(),r={};t.polygons.map(function(e){r[e.plane.getTag()]=e.plane});var o,i,s=new n.Vector3D(1,0,0),a=new n.Vector3D(0,1,0),l=new n.Vector3D(0,0,1),h=new n.Connector([0,0,0],[0,0,-1],s),c=new n.Connector([0,0,0],[0,0,-1],a),u=!0,p=0,f=0;for(var d in r){var g,m,v,x=r[d],y=x.normal.times(x.w);if(x.normal.cross(s).length()>x.normal.cross(a).length())g=(v=new n.Connector(y,x.normal,s)).getTransformationTo(h,!1,0),m=h.getTransformationTo(v,!1,0);else g=(v=new n.Connector(y,x.normal,a)).getTransformationTo(c,!1,0),m=c.getTransformationTo(v,!1,0);var w=t.transform(g),P=-x.normal.dot(l),_=w.getBounds(),V=_[1].z-_[0].z,D=u;if(D||(V<p||V==p&&P>f)&&(D=!0),D){var b=new n.Vector3D([-.5*(_[1].x+_[0].x),-.5*(_[1].y+_[0].y),-_[0].z]);p=V,f=P,o=g=g.multiply(n.Matrix4x4.translation(b)),i=m=n.Matrix4x4.translation(b.negated()).multiply(m)}u=!1}return[o,i]},getTransformationToFlatLying:function(){return this.getTransformationAndInverseTransformationToFlatLying()[0]},lieFlat:function(){var e=this.getTransformationToFlatLying();return this.transform(e)},projectToOrthoNormalBasis:function(e){var t=1e-5,n=[];return this.polygons.filter(function(n){return n.plane.normal.minus(e.plane.normal).lengthSquared()<t*t}).map(function(t){var r=t.projectToOrthoNormalBasis(e);r.sides.length>0&&n.push(r)}),(new o).union(n)},sectionCut:function(e){var t=e.plane,r=e.plane.flipped();t=new n.Plane(t.normal,t.w),r=new n.Plane(r.normal,r.w+5e-5);var o=this.cutByPlane(t);return(o=o.cutByPlane(r)).projectToOrthoNormalBasis(e)},toTriangles:function(){var e=[];return this.polygons.forEach(function(t){for(var r=t.vertices[0],o=t.vertices.length-3;o>=0;o--)e.push(new n.Polygon([r,t.vertices[o+1],t.vertices[o+2]],t.shared,t.plane))}),e},getFeatures:function(e){e instanceof Array||(e=[e]);var t=this.toTriangles().map(function(t){return t.getTetraFeatures(e)}).reduce(function(e,t){return t.map(function(t,n){return t+(0===e?0:e[n])})},0);return 1==t.length?t[0]:t}},n.parseOption=function(e,t,n){var r=n;return e&&t in e&&(r=e[t]),r},n.parseOptionAs3DVector=function(e,t,r){var o=n.parseOption(e,t,r);return o=new n.Vector3D(o)},n.parseOptionAs3DVectorList=function(e,t,r){return n.parseOption(e,t,r).map(function(e){return new n.Vector3D(e)})},n.parseOptionAs2DVector=function(e,t,r){var o=n.parseOption(e,t,r);return o=new n.Vector2D(o)},n.parseOptionAsFloat=function(e,t,r){var o=n.parseOption(e,t,r);if("string"==typeof o&&(o=Number(o)),isNaN(o)||"number"!=typeof o)throw new Error("Parameter "+t+" should be a number");return o},n.parseOptionAsInt=function(e,t,r){var o=n.parseOption(e,t,r);if(o=Number(Math.floor(o)),isNaN(o))throw new Error("Parameter "+t+" should be a number");return o},n.parseOptionAsBool=function(e,t,r){var o=n.parseOption(e,t,r);return"string"==typeof o&&("true"==o?o=!0:("false"==o||0==o)&&(o=!1)),o=!!o},n.cube=function(e){var t,r;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("cube: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs3DVector(e,"corner1",[0,0,0]),corner2=n.parseOptionAs3DVector(e,"corner2",[1,1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs3DVector(e,"center",[0,0,0]),r=n.parseOptionAs3DVector(e,"radius",[1,1,1]);if(r.x<0||r.y<0||r.z<0)throw new Error("Dimension should be positive");if(r.x<5e-4||r.y<5e-4||r.z<5e-4)return console.log("Throwing out a zero-length cube."),new n;var o=n.fromPolygons([[[0,4,6,2],[-1,0,0]],[[1,3,7,5],[1,0,0]],[[0,1,5,4],[0,-1,0]],[[2,6,7,3],[0,1,0]],[[0,2,3,1],[0,0,-1]],[[4,5,7,6],[0,0,1]]].map(function(e){var o=e[0].map(function(e){var o=new n.Vector3D(t.x+r.x*(2*!!(1&e)-1),t.y+r.y*(2*!!(2&e)-1),t.z+r.z*(2*!!(4&e)-1));return new n.Vertex(o)});return new n.Polygon(o,null)}));return o.properties.cube=new n.Properties,o.properties.cube.center=new n.Vector3D(t),o.properties.cube.facecenters=[new n.Connector(new n.Vector3D([r.x,0,0]).plus(t),[1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([-r.x,0,0]).plus(t),[-1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([0,r.y,0]).plus(t),[0,1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,-r.y,0]).plus(t),[0,-1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,0,r.z]).plus(t),[0,0,1],[1,0,0]),new n.Connector(new n.Vector3D([0,0,-r.z]).plus(t),[0,0,-1],[1,0,0])],o},n.sphere=function(e){e=e||{};var t,r,o,i=n.parseOptionAs3DVector(e,"center",[0,0,0]),s=n.parseOptionAsFloat(e,"radius",1),a=n.parseOptionAsInt(e,"res",n.defaultResolution3D);if(s<0)throw new Error("Radius should be positive");if(s<1e-6)return console.log("Throwing out a zero-radius sphere."),new n;"axes"in e?(t=e.axes[0].unit().times(s),r=e.axes[1].unit().times(s),o=e.axes[2].unit().times(s)):(t=new n.Vector3D([1,0,0]).times(s),r=new n.Vector3D([0,-1,0]).times(s),o=new n.Vector3D([0,0,1]).times(s)),a<4&&(a=4);for(var l,h=Math.round(a/4),c=[],u=0;u<=a;u++){var p=2*Math.PI*u/a,f=t.times(Math.cos(p)).plus(r.times(Math.sin(p)));if(u>0)for(var d,g,m=[],v=0;v<=h;v++){var x=.5*Math.PI*v/h,y=Math.cos(x),w=Math.sin(x);v>0&&((m=[]).push(new n.Vertex(i.plus(l.times(d).minus(o.times(g))))),m.push(new n.Vertex(i.plus(f.times(d).minus(o.times(g))))),v<h&&m.push(new n.Vertex(i.plus(f.times(y).minus(o.times(w))))),m.push(new n.Vertex(i.plus(l.times(y).minus(o.times(w))))),c.push(new n.Polygon(m)),(m=[]).push(new n.Vertex(i.plus(l.times(d).plus(o.times(g))))),m.push(new n.Vertex(i.plus(f.times(d).plus(o.times(g))))),v<h&&m.push(new n.Vertex(i.plus(f.times(y).plus(o.times(w))))),m.push(new n.Vertex(i.plus(l.times(y).plus(o.times(w))))),m.reverse(),c.push(new n.Polygon(m))),d=y,g=w}l=f}var P=n.fromPolygons(c);return P.properties.sphere=new n.Properties,P.properties.sphere.center=new n.Vector3D(i),P.properties.sphere.facepoint=i.plus(t),P},n.cylinder=function(e){var t=n.parseOptionAs3DVector(e,"start",[0,-1,0]),r=n.parseOptionAs3DVector(e,"end",[0,1,0]),o=n.parseOptionAsFloat(e,"radius",1),i=n.parseOptionAsFloat(e,"radiusEnd",o),s=n.parseOptionAsFloat(e,"radiusStart",o),a=n.parseOptionAsFloat(e,"sectorAngle",360);if(a=a>360?a%360:a,i<0||s<0)throw new Error("Radius should be non-negative");if(Math.abs(r.z-t.z)<5e-4||i<5e-4&&s<5e-4)return console.log("throwing out a zero-height cylinder or a cylinder with both ends < 0.0005"),new n;var l=n.parseOptionAsInt(e,"res",n.defaultResolution2D),h=r.minus(t),c=h.unit(),u=c.randomNonParallelVector().unit(),p=u.cross(c).unit(),f=new n.Vertex(t),d=new n.Vertex(r),g=[];function m(e,r,o){var i=r*Math.PI*a/180,s=u.times(Math.cos(i)).plus(p.times(Math.sin(i))),l=t.plus(h.times(e)).plus(s.times(o));return new n.Vertex(l)}if(a>0){for(var v=0;v<l;v++){var x=v/l,y=(v+1)/l;i==s?(g.push(new n.Polygon([f,m(0,x,i),m(0,y,i)])),g.push(new n.Polygon([m(0,y,i),m(0,x,i),m(1,x,i),m(1,y,i)])),g.push(new n.Polygon([d,m(1,y,i),m(1,x,i)]))):(s>0&&(g.push(new n.Polygon([f,m(0,x,s),m(0,y,s)])),g.push(new n.Polygon([m(0,x,s),m(1,x,i),m(0,y,s)]))),i>0&&(g.push(new n.Polygon([d,m(1,y,i),m(1,x,i)])),g.push(new n.Polygon([m(1,x,i),m(1,y,i),m(0,y,s)]))))}a<360&&(g.push(new n.Polygon([f,d,m(0,0,s)])),g.push(new n.Polygon([m(0,0,s),d,m(1,0,i)])),g.push(new n.Polygon([f,m(0,1,s),d])),g.push(new n.Polygon([m(0,1,s),m(1,1,i),d])))}var w=n.fromPolygons(g);w.properties.cylinder=new n.Properties,w.properties.cylinder.start=new n.Connector(t,c.negated(),u),w.properties.cylinder.end=new n.Connector(r,c,u);var P=t.plus(h.times(.5)),_=u.rotate(t,c,-a/2).times((s+i)/2),V=_.cross(c);return w.properties.cylinder.facepointH=new n.Connector(P.plus(_),_,c),w.properties.cylinder.facepointH90=new n.Connector(P.plus(V),V,c),w},n.roundedCylinder=function(e){var t,r=n.parseOptionAs3DVector(e,"start",[0,-1,0]),o=n.parseOptionAs3DVector(e,"end",[0,1,0]),i=n.parseOptionAsFloat(e,"radius",1),s=o.minus(r);t=Math.abs(s.x)>Math.abs(s.y)?new n.Vector3D(0,1,0):new n.Vector3D(1,0,0);var a=n.parseOptionAs3DVector(e,"normal",t),l=n.parseOptionAsInt(e,"resolution",n.defaultResolution3D);l<4&&(l=4);var h=[],c=Math.floor(.25*l);if(s.length()<1e-10)return n.sphere({center:r,radius:i,resolution:l});for(var u,p=s.unit().times(i),f=p.cross(a).unit().times(i),d=f.cross(p).unit().times(i),g=0;g<=l;g++){var m=2*Math.PI*g/l,v=f.times(Math.cos(m)).plus(d.times(Math.sin(m)));if(g>0){var x,y,w=[];w.push(new n.Vertex(r.plus(v))),w.push(new n.Vertex(r.plus(u))),w.push(new n.Vertex(o.plus(u))),w.push(new n.Vertex(o.plus(v))),h.push(new n.Polygon(w));for(var P=0;P<=c;P++){var _=.5*Math.PI*P/c,V=Math.cos(_),D=Math.sin(_);P>0&&((w=[]).push(new n.Vertex(r.plus(u.times(x).minus(p.times(y))))),w.push(new n.Vertex(r.plus(v.times(x).minus(p.times(y))))),P<c&&w.push(new n.Vertex(r.plus(v.times(V).minus(p.times(D))))),w.push(new n.Vertex(r.plus(u.times(V).minus(p.times(D))))),h.push(new n.Polygon(w)),(w=[]).push(new n.Vertex(o.plus(u.times(x).plus(p.times(y))))),w.push(new n.Vertex(o.plus(v.times(x).plus(p.times(y))))),P<c&&w.push(new n.Vertex(o.plus(v.times(V).plus(p.times(D))))),w.push(new n.Vertex(o.plus(u.times(V).plus(p.times(D))))),w.reverse(),h.push(new n.Polygon(w))),x=V,y=D}}u=v}var b=n.fromPolygons(h),C=p.unit(),S=f.unit();return b.properties.roundedCylinder=new n.Properties,b.properties.roundedCylinder.start=new n.Connector(r,C.negated(),S),b.properties.roundedCylinder.end=new n.Connector(o,C,S),b.properties.roundedCylinder.facepoint=r.plus(f),b},n.roundedCube=function(e){var t,r,o=1e-5,i=.01;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("roundedCube: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs3DVector(e,"corner1",[0,0,0]),corner2=n.parseOptionAs3DVector(e,"corner2",[1,1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs3DVector(e,"center",[0,0,0]),r=n.parseOptionAs3DVector(e,"radius",[1,1,1]);r=r.abs();var s=n.parseOptionAsInt(e,"resolution",n.defaultResolution3D);s<4&&(s=4),s%2==1&&s<8&&(s=8);var a=n.parseOptionAs3DVector(e,"roundradius",[.2,.2,.2]);a=n.Vector3D.Create(Math.max(a.x,i),Math.max(a.y,i),Math.max(a.z,i));var l=r.minus(a);if(l.x<0||l.y<0||l.z<0)throw"roundradius <= radius!";var h=n.sphere({radius:1,resolution:s});return h=h.scale(a),l.x>o&&(h=h.stretchAtPlane([1,0,0],[0,0,0],2*l.x)),l.y>o&&(h=h.stretchAtPlane([0,1,0],[0,0,0],2*l.y)),l.z>o&&(h=h.stretchAtPlane([0,0,1],[0,0,0],2*l.z)),(h=(h=h.tr([-l.x+t.x,-l.y+t.y,-l.z+t.z])).reTesselated()).properties.roundedCube=new n.Properties,h.properties.roundedCube.center=new n.Vertex(t),h.properties.roundedCube.facecenters=[new n.Connector(new n.Vector3D([r.x,0,0]).plus(t),[1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([-r.x,0,0]).plus(t),[-1,0,0],[0,0,1]),new n.Connector(new n.Vector3D([0,r.y,0]).plus(t),[0,1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,-r.y,0]).plus(t),[0,-1,0],[0,0,1]),new n.Connector(new n.Vector3D([0,0,r.z]).plus(t),[0,0,1],[1,0,0]),new n.Connector(new n.Vector3D([0,0,-r.z]).plus(t),[0,0,-1],[1,0,0])],h},n.polyhedron=function(e){if("points"in(e=e||{})!="faces"in e)throw new Error("polyhedron needs 'points' and 'faces' arrays");var t=n.parseOptionAs3DVectorList(e,"points",[[1,1,0],[1,-1,0],[-1,-1,0],[-1,1,0],[0,0,1]]).map(function(e){return new n.Vertex(e)}),r=n.parseOption(e,"faces",[[0,1,4],[1,2,4],[2,3,4],[3,0,4],[1,0,3],[2,1,3]]);r.forEach(function(e){e.reverse()});var o=r.map(function(e){return new n.Polygon(e.map(function(e){return t[e]}))});return n.fromPolygons(o).reTesselated()},n.IsFloat=function(e){return!isNaN(e)||e===1/0||e===-1/0},n.solve2Linear=function(e,t,n,r,o,i){var s=1/(e*r-t*n),a=o*r-t*i,l=-o*n+e*i;return[a*=s,l*=s]},n.Vector3D=function(e,t,r){if(3==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t),this._z=parseFloat(r);else if(2==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t),this._z=0;else{var o=!0;if(1==arguments.length)if("object"==typeof e)e instanceof n.Vector3D?(this._x=e._x,this._y=e._y,this._z=e._z):e instanceof n.Vector2D?(this._x=e._x,this._y=e._y,this._z=0):e instanceof Array?e.length<2||e.length>3?o=!1:(this._x=parseFloat(e[0]),this._y=parseFloat(e[1]),3==e.length?this._z=parseFloat(e[2]):this._z=0):"_x"in e&&"_y"in e?(this._x=parseFloat(e._x),this._y=parseFloat(e._y),this._z="_z"in e?parseFloat(e._z):0):o=!1;else{var i=parseFloat(e);this._x=i,this._y=i,this._z=i}else o=!1;if(o&&(n.IsFloat(this._x)&&n.IsFloat(this._y)&&n.IsFloat(this._z)||(o=!1)),!o)throw new Error("wrong arguments")}},n.Vector3D.Create=function(e,t,r){var o=Object.create(n.Vector3D.prototype);return o._x=e,o._y=t,o._z=r,o},n.Vector3D.prototype={get x(){return this._x},get y(){return this._y},get z(){return this._z},set x(e){throw new Error("Vector3D is immutable")},set y(e){throw new Error("Vector3D is immutable")},set z(e){throw new Error("Vector3D is immutable")},clone:function(){return n.Vector3D.Create(this._x,this._y,this._z)},negated:function(){return n.Vector3D.Create(-this._x,-this._y,-this._z)},abs:function(){return n.Vector3D.Create(Math.abs(this._x),Math.abs(this._y),Math.abs(this._z))},plus:function(e){return n.Vector3D.Create(this._x+e._x,this._y+e._y,this._z+e._z)},minus:function(e){return n.Vector3D.Create(this._x-e._x,this._y-e._y,this._z-e._z)},times:function(e){return n.Vector3D.Create(this._x*e,this._y*e,this._z*e)},dividedBy:function(e){return n.Vector3D.Create(this._x/e,this._y/e,this._z/e)},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z},lerp:function(e,t){return this.plus(e.minus(this).times(t))},lengthSquared:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSquared())},unit:function(){return this.dividedBy(this.length())},cross:function(e){return n.Vector3D.Create(this._y*e._z-this._z*e._y,this._z*e._x-this._x*e._z,this._x*e._y-this._y*e._x)},distanceTo:function(e){return this.minus(e).length()},distanceToSquared:function(e){return this.minus(e).lengthSquared()},equals:function(e){return this._x==e._x&&this._y==e._y&&this._z==e._z},multiply4x4:function(e){return e.leftMultiply1x3Vector(this)},transform:function(e){return e.leftMultiply1x3Vector(this)},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+", "+this._z.toFixed(2)+")"},randomNonParallelVector:function(){var e=this.abs();return e._x<=e._y&&e._x<=e._z?n.Vector3D.Create(1,0,0):e._y<=e._x&&e._y<=e._z?n.Vector3D.Create(0,1,0):n.Vector3D.Create(0,0,1)},min:function(e){return n.Vector3D.Create(Math.min(this._x,e._x),Math.min(this._y,e._y),Math.min(this._z,e._z))},max:function(e){return n.Vector3D.Create(Math.max(this._x,e._x),Math.max(this._y,e._y),Math.max(this._z,e._z))},setZero:function(){this._x=0,this._y=0,this._z=0},hAdd:function(e,t){e._x+=t._x,e._y+=t._y,e._z+=t._z},hTimes:function(e,t){e._x*=t,e._y*=t,e._z*=t},normalize:function(){var e=this.lengthSquared(),t=e-1,n=2220446049250313e-31;if(t>2*n||t<-2*n){var r=Math.sqrt(e);this._x/=r,this._y/=r,this._z/=r}},set:function(e,t,n){this._x=e,this._y=t,this._z=n}},n.Vertex=function(e){this.pos=e},n.Vertex.fromObject=function(e){var t=new n.Vector3D(e.pos);return new n.Vertex(t)},n.Vertex.prototype={flipped:function(){return this},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},interpolate:function(e,t){var r=this.pos.lerp(e.pos,t);return new n.Vertex(r)},transform:function(e){var t=this.pos.multiply4x4(e);return new n.Vertex(t)},toString:function(){return this.pos.toString()}},n.hVertex=function(e,t,r,o){this.pnt=new n.Vector3D(e,t,r),4==arguments.length&&(this.index=o),this.next=null,this.prev=null,this.face=null},n.hVertex.prototype={clone:function(){return new n.hVertex(this._x,this._y,this._z,this.index)}},n.hVertexList=function(){this.head=null,this.tail=null},n.hVertexList.prototype={clear:function(){this.head=null,this.tail=null},add:function(e){null==this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e},addAll:function(e){for(null==this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!=e.next;)e=e.next;this.tail=e},delete:function(e,t){1==arguments.length?(null==e.prev?this.head=e.next:e.prev.next=e.next,null==e.next?this.tail=e.prev:e.next.prev=e.prev):2==arguments.length&&(null==e.prev?this.head=t.next:e.prev.next=t.next,null==t.next?this.tail=e.prev:t.next.prev=e.prev)},insertBefore:function(e,t){e.prev=t.prev,null==t.prev?this.head=e:t.prev.next=e,e.next=t,t.prev=e},first:function(){return this.head},isEmpty:function(){return null==this.head}},n.HalfEdge=function(e,t){2==arguments.length?(this.vertex=e,this.face=t):(this.vertex=null,this.face=null),this.prev=null,this.next=null,this.opposite=null},n.HalfEdge.prototype={setNext:function(e){this.next=e},getNext:function(){return this.next},setPrev:function(e){this.prev=e},getPrev:function(){return this.prev},getFace:function(){return this.face},getOpposite:function(){return this.opposite},setOpposite:function(e){this.opposite=e,e.opposite=this},head:function(){return this.vertex},tail:function(){return null!=this.prev?this.prev.vertex:null},oppositeFace:function(){return null!=this.opposite?this.opposite.face:null},getVertexString:function(){return null!=this.tail()?this.tail().index+"-"+this.head().index:"? -"+this.head().index},length:function(){return null!=this.tail()?this.head().pnt.distanceTo(this.tail().pnt):-1},lengthSquared:function(){return null!=this.tail()?this.head().pnt.distanceToSquared(this.tail().pnt):-1}},n.Face=function(){this.normal=new n.Vector3D(0,0,0),this.centroid=new n.Vector3D(0,0,0),this.mark=1,this.he0=null,this.area=-1,this.planeOffset=-1,this.index=-1,this.numVerts=-1,this.next=null,this.outside=null},n.Face.prototype={computeCentroid:function(e){e.setZero();var t=this.he0;do{e.hAdd(e,t.head().pnt),t=t.next}while(t!=this.he0);e.hTimes(e,1/this.numVerts)},computeNormal:function(e,t){var n=this.he0.next,r=n.next,o=this.he0.head().pnt,i=n.head().pnt,s=i._x-o._x,a=i._y-o._y,l=i._z-o._z;for(this.normal.setZero(),this.numVerts=2;r!=this.he0;){var h=s,c=a,u=l;s=(i=r.head().pnt)._x-o._x,a=i._y-o._y,l=i._z-o._z,this.normal._x+=c*l-u*a,this.normal._y+=u*s-h*l,this.normal._z+=h*a-c*s,n=r,r=r.next,this.numVerts++}if(this.area=this.normal.length(),this.normal.hTimes(this.normal,1/this.area),2==arguments.length&&this.area<t){var p=null,f=0,d=this.he0;do{var g=d.lengthSquared();g>f&&(p=d,f=g)}while(d!=this.he0);i=p.head().pnt,p1=p.tail().pnt;var m=Math.sqrt(f),v=(i._x-p1._x)/m,x=(i._y-p1._y)/m,y=(i._z-p1._z)/m,w=this.normal._x*v+this.normal._y*x+this.normal._z*y;this.normal._x-=w*v,this.normal._y-=w*x,this.normal._z-=w*y,this.normal.normalize()}},computeNormalAndCentroid:function(e){1==arguments.length?this.computeNormal(this.normal,e):this.computeNormal(this.normal),this.computeCentroid(this.centroid),this.planeOffset=this.normal.dot(this.centroid)},createTriangle:function(e,t,r,o){var i=new n.Face,s=new n.HalfEdge(e,i),a=new n.HalfEdge(t,i),l=new n.HalfEdge(r,i);return s.prev=l,s.next=a,a.prev=s,a.next=l,l.prev=a,l.next=s,i.he0=s,o?i.computeNormalAndCentroid(o):i.computeNormalAndCentroid(0),i},create:function(e,t){for(var r=new n.Face,o=null,i=0;i<t.length;i++){var s=new n.HalfEdge(e[t[i]],r);null!=o?(s.setPrev(o),o.setNext(s)):r.he0=s,o=s}return r.he0.setPrev(o),o.setNext(r.he0),r.computeNormalAndCentroid(),r},getEdge:function(e){for(var t=this.he0;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t},getFirstEdge:function(){return this.he0},findEdge:function(e,t){var n=this.he0;do{if(n.head()==t&&n.tail()==e)return n;n=n.next}while(n!=this.he0);return null},distanceToPlane:function(e){return this.normal._x*e._x+this.normal._y*e._y+this.normal._z*e._z-this.planeOffset},getNormal:function(){return this.normal},getCentroid:function(){return this.centroid},numVertices:function(){return this.numVerts},getVertexString:function(){var e="",t=this.he0;do{0==e.length?e+=t.head().index:e+=" "+t.head().index,t=t.next}while(t!=this.he0);return e},getVertexIndices:function(e){var t=this.he0,n=0;do{e[n++]=t.head().index,t=t.next}while(t!=this.he0)},connectHalfEdges:function(e,t){var n=null;if(e.oppositeFace()==t.oppositeFace()){var r,o=t.oppositeFace();e==this.he0&&(this.he0=t),3==o.numVertices()?(r=t.getOpposite().prev.getOpposite(),o.mark=3,n=o):(r=t.getOpposite().next,o.he0==r.prev&&(o.he0=r),r.prev=r.prev.prev,r.prev.next=r),t.prev=e.prev,t.prev.next=t,t.opposite=r,r.opposite=t,o.computeNormalAndCentroid()}else e.next=t,t.prev=e;return n},checkConsistency:function(){var e=this.he0,t=0,n=0;if(this.numVerts<3)throw"face"+this.getVertexString()+": unreflected half edge "+e.getVertexString();do{var r=e.getOpposite();if(null==r)throw"face "+this.getVertexString()+": unreflected half edge "+e.getVertexString();if(r.getOpposite()!=e)throw"face "+this.getVertexString()+": opposite half edge "+r.getVertexString()+" has opposite "+r.getOpposite().getVertexString();if(r.head()!=e.tail()||e.head()!=r.tail())throw"face "+this.getVertexString()+": half edge "+e.getVertexString()+" reflected by "+r.getVertexString();var o=r.face;if(null==o)throw"face "+this.getVertexString()+": no face on half edge "+r.getVertexString();if(3==o.mark)throw"face "+this.getVertexString()+": opposite face "+o.getVertexString()+" not on hull";var i=Math.abs(this.distanceToPlane(e.head().pnt));i>t&&(t=i),n++,e=e.next}while(e!=this.he0);if(n!=this.numVerts)throw"face "+this.getVertexString()+" numVerts="+this.numVerts+" should be "+n},mergeAdjacentFace:function(e,t){var n=e.oppositeFace(),r=0;t[r++]=n,n.mark=3;for(var o,i,s=e.getOpposite(),a=e.prev,l=e.next,h=s.prev,c=s.next;a.oppositeFace()==n;)a=a.prev,c=c.next;for(;l.oppositeFace()==n;)h=h.prev,l=l.next;for(o=c;o!=h.next;o=o.next)o.face=this;return e==this.he0&&(this.he0=l),null!=(i=this.connectHalfEdges(h,l))&&(t[r++]=i),null!=(i=this.connectHalfEdges(a,c))&&(t[r++]=i),this.computeNormalAndCentroid(),this.checkConsistency(),r},areaSquared:function(e,t){var n=e.tail().pnt,r=e.head().pnt,o=t.head().pnt,i=r._x-n._x,s=r._y-n._y,a=r._z-n._z,l=o._x-n._x,h=o._y-n._y,c=o._z-n._z,u=s*c-a*h,p=a*l-i*c,f=i*h-s*l;return u*u+p*p+f*f},triangulate:function(e,t){var r;if(!(this.numVertices<4)){var o=this.he0.head(),i=(r=this.he0.next).opposite,s=null;for(r=r.next;r!=this.he0.prev;r=r.next){(a=createTriangle(o,r.prev.head(),r.head(),t)).he0.next.setOpposite(i),a.he0.prev.setOpposite(r.opposite),i=a.he0,e.add(a),null==s&&(s=a)}(r=new n.HalfEdge(this.he0.prev.prev.head(),this)).setOpposite(i),r.prev=this.he0,r.prev.next=r,r.next=this.he0.prev,r.next.prev=r,computeNormalAndCentroid(t),checkConsistency();for(var a=s;null!=a;a=a.next)a.checkConsistency()}}},n.FaceList=function(){this.head=null,this.tail=null},n.FaceList.prototype={clear:function(){this.head=null,this.tail=null},add:function(e){null==this.head?this.head=e:this.tail.next=e,e.next=null,this.tail=e},first:function(){return this.head},isEmpty:function(){return null==this.head}},n.quickHull3D=function(){this.AUTOMATIC_TOLERANCE=-1,this.DOUBLE_PREC=2220446049250313e-31,this.findIndex=-1,this.debug=!0,this.charLength=0,this.pointBuffer=[],this.vertexPointIndices=[],this.discardedFaces=[],this.maxVtxs=[],this.minVtxs=[];for(var e=0;e<3;e++)this.maxVtxs.push(new n.hVertex(0,0,0,e)),this.minVtxs.push(new n.hVertex(0,0,0,e)),this.discardedFaces.push(new n.Face);this.faces=[],this.horizon=[],this.newFaces=new n.FaceList,this.unclaimed=new n.hVertexList,this.claimed=new n.hVertexList,this.numVertices=0,this.numFaces=0,this.numPoints=0,this.explicitTolerance=this.AUTOMATIC_TOLERANCE,this.tolerance=0},n.quickHull3D.prototype={build:function(e){return e.length<4?(console.log("cannot build hull - fewer than four points"),null):(this.initBuffers(e,e.length),this.buildHull())},initBuffers:function(e,t){this.pointBuffer=[];for(var r=0;r<t;r++)this.pointBuffer.push(new n.hVertex(e[r]._x,e[r]._y,e[r]._z,r)),this.vertexPointIndices.push(0);this.faces=[],this.claimed.clear(),this.numVertices=t,this.numFaces=0,this.numPoints=t},buildHull:function(){var e;for(this.computeMaxAndMin(),this.createInitialSimplex();null!=(e=this.nextPointToAdd());)this.addPointToHull(e);return this.reindexFacesAndVertices(),this.getFaces()},computeMaxAndMin:function(){for(var e=this.pointBuffer[0],t=0;t<3;t++)this.maxVtxs[t]=this.pointBuffer[0],this.minVtxs[t]=this.pointBuffer[0];var n=[e.pnt._x,e.pnt._y,e.pnt._z],r=[e.pnt._x,e.pnt._y,e.pnt._z];for(t=0;t<this.numPoints;t++){var o=this.pointBuffer[t].pnt;o._x>n[0]?(n[0]=o._x,this.maxVtxs[0]=this.pointBuffer[t]):o._x<r[0]&&(r[0]=o._x,this.minVtxs[0]=this.pointBuffer[t]),o._y>n[1]?(n[1]=o._y,this.maxVtxs[1]=this.pointBuffer[t]):o._y<r[1]&&(r[1]=o._y,this.minVtxs[1]=this.pointBuffer[t]),o._z>n[2]?(n[2]=o._z,this.maxVtxs[2]=this.pointBuffer[t]):o._z<r[2]&&(r[2]=o._z,this.minVtxs[2]=this.pointBuffer[t])}this.charLength=Math.max(n[0]-r[0],n[1]-r[1],n[2]-r[2]),this.explicitTolerance==this.AUTOMATIC_TOLERANCE?this.tolerance=3*this.DOUBLE_PREC*(Math.max(Math.abs(n[0]),Math.abs(r[0]))+Math.max(Math.abs(n[1]),Math.abs(r[1]))+Math.max(Math.abs(n[2]),Math.abs(r[2]))):this.tolerance=this.explicitTolerance},createInitialSimplex:function(){var e=0,t=0,r=this.maxVtxs[0].pnt._x-this.minVtxs[0].pnt._x,o=this.maxVtxs[1].pnt._y-this.minVtxs[1].pnt._y,i=this.maxVtxs[2].pnt._z-this.minVtxs[2].pnt._z;if(r>e&&(e=r,t=0),o>e&&(e=o,t=1),i>e&&(e=i,t=2),e<=this.tolerance)throw"hull points are all coincident - fail!";var s=[];s[0]=this.maxVtxs[t],s[1]=this.minVtxs[t];var a=new n.Vector3D(s[1].pnt._x,s[1].pnt._y,s[1].pnt._z);(a=a.minus(s[0].pnt)).normalize();for(var l=new n.Vector3D(0,0,0),h=0,c=0;c<this.numPoints;c++){var u=this.pointBuffer[c],p=n.Vector3D.Create(u.pnt._x,u.pnt._y,u.pnt._z);p=p.minus(s[0].pnt);var f=n.Vector3D.Create(a._x,a._y,a._z),d=(f=f.cross(p)).lengthSquared();d>h&&this.pointBuffer[c]!=s[0]&&this.pointBuffer[c]!=s[1]&&(h=d,s[2]=this.pointBuffer[c],l.set(f._x,f._y,f._z))}if(Math.sqrt(h)<=100*this.tolerance)throw"Input points to hull appear to be co-linear";l.normalize();var g=0,m=s[2].pnt.dot(l);for(c=0;c<this.numPoints;c++){(P=Math.abs(this.pointBuffer[c].pnt.dot(l)-m))>g&&this.pointBuffer[c]!=s[0]&&this.pointBuffer[c]!=s[1]&&this.pointBuffer[c]!=s[2]&&(g=P,s[3]=this.pointBuffer[c])}if(Math.abs(g)<=100*this.tolerance)throw"Input points appear to be coplanar";var v=[new n.Face,new n.Face,new n.Face,new n.Face];if(s[3].pnt.dot(l)-m<0){v[0]=v[0].createTriangle(s[0],s[1],s[2]),v[1]=v[1].createTriangle(s[3],s[1],s[0]),v[2]=v[2].createTriangle(s[3],s[2],s[1]),v[3]=v[3].createTriangle(s[3],s[0],s[2]);for(c=0;c<3;c++){var x=(c+1)%3;v[c+1].getEdge(1).setOpposite(v[x+1].getEdge(0)),v[c+1].getEdge(2).setOpposite(v[0].getEdge(x))}}else{v[0]=v[0].createTriangle(s[0],s[2],s[1]),v[1]=v[1].createTriangle(s[3],s[0],s[1]),v[2]=v[2].createTriangle(s[3],s[1],s[2]),v[3]=v[3].createTriangle(s[3],s[2],s[0]);for(c=0;c<3;c++){x=(c+1)%3;v[c+1].getEdge(0).setOpposite(v[x+1].getEdge(1)),v[c+1].getEdge(2).setOpposite(v[0].getEdge((3-c)%3))}}for(c=0;c<4;c++)this.faces.push(v[c]);for(c=0;c<this.numPoints;c++){var y=this.pointBuffer[c];if(y!=s[0]&&y!=s[1]&&y!=s[2]&&y!=s[3]){g=this.tolerance;var w=null;for(x=0;x<4;x++){var P;(P=v[x].distanceToPlane(y.pnt))>g&&(w=v[x],g=P)}null!=w&&this.addPointToFace(y,w)}}},addPointToFace:function(e,t){e.face=t,null==t.outside?this.claimed.add(e):this.claimed.insertBefore(e,t.outside),t.outside=e},nextPointToAdd:function(){if(this.claimed.isEmpty())return null;for(var e=this.claimed.first().face,t=null,n=0,r=e.outside;null!=r&&r.face==e;r=r.next){var o=e.distanceToPlane(r.pnt);o>n&&(n=o,t=r)}return t},addPointToHull:function(e){this.horizon=[],this.unclaimed.clear(),this.removePointFromFace(e,e.face),this.calculateHorizon(e.pnt,null,e.face,this.horizon),this.newFaces.clear(),this.addNewFaces(this.newFaces,e,this.horizon);for(var t=this.newFaces.first();null!=t;t=t.next)if(1==t.mark)for(;this.doAdjacentMerge(t,1););for(t=this.newFaces.first();null!=t;t=t.next)if(2==t.mark)for(t.mark=1;this.doAdjacentMerge(t,2););this.resolveUnclaimedPoints(this.newFaces)},removePointFromFace:function(e,t){e==t.outside&&(null!=e.next&&e.next.face==t?t.outside=e.next:t.outside=null),this.claimed.delete(e)},calculateHorizon:function(e,t,n,r){var o;this.deleteFacePoints(n,null),n.mark=3,o=null==t?t=n.getEdge(0):t.getNext();do{var i=o.oppositeFace();1==i.mark&&(i.distanceToPlane(e)>this.tolerance?this.calculateHorizon(e,o.getOpposite(),i,r):r.push(o)),o=o.getNext()}while(o!=t)},oppFaceDistance:function(e){return e.face.distanceToPlane(e.opposite.face.getCentroid())},doAdjacentMerge:function(e,t){var n=e.he0,r=!0;do{var o=n.oppositeFace(),i=!1;if(2==t?(this.oppFaceDistance(n)>-1*this.tolerance||this.oppFaceDistance(n.opposite)>-1*this.tolerance)&&(i=!0):e.area>o.area?this.oppFaceDistance(n)>-this.tolerance?i=!0:this.oppFaceDistance(n.opposite)>-this.tolerance&&(r=!1):this.oppFaceDistance(n.opposite)>-this.tolerance?i=!0:this.oppFaceDistance(n)>-this.tolerance&&(r=!1),i){for(var s=e.mergeAdjacentFace(n,this.discardedFaces),a=0;a<s;a++)this.deleteFacePoints(this.discardedFaces[a],e);return!0}n=n.next}while(n!=e.he0);return r||(e.mark=2),!1},deleteFacePoints:function(e,t){var n=this.removeAllPointsFromFace(e);if(null!=n)if(null==t)this.unclaimed.addAll(n);else for(var r=n,o=r;null!=o;o=r){r=o.next,t.distanceToPlane(o.pnt)>this.tolerance?this.addPointToFace(o,t):this.unclaimed.add(o)}},removeAllPointsFromFace:function(e){if(null!=e.outside){for(var t=e.outside;null!=t.next&&t.next.face==e;)t=t.next;return this.claimed.delete(e.outside,t),t.next=null,e.outside}return null},addNewFaces:function(e,t,n){e.clear();for(var r=null,o=null,i=0;i<n.length;i++){var s=n[i],a=this.addAdjoiningFace(t,s);null!=r?a.next.setOpposite(r):o=a,e.add(a.getFace()),r=a}o.next.setOpposite(r)},addAdjoiningFace:function(e,t){var r=new n.Face;return r=r.createTriangle(e,t.tail(),t.head()),this.faces.push(r),r.getEdge(-1).setOpposite(t.getOpposite()),r.getEdge(0)},resolveUnclaimedPoints:function(e){for(var t=this.unclaimed.first(),n=t;null!=n;n=t){t=n.next;for(var r=this.tolerance,o=null,i=e.first();null!=i;i=i.next)if(1==i.mark){var s=i.distanceToPlane(n.pnt);if(s>r&&(r=s,o=i),r>1e3*this.tolerance)break}null!=o&&this.addPointToFace(n,o)}},reindexFacesAndVertices:function(){for(var e=0;e<this.numPoints;e++)this.pointBuffer[e].index=-1;this.numFaces=0;var t=[];for(e=0;e<this.faces.length;e++){var n=this.faces[e];1==n.mark&&(this.markFaceVertices(n,0),this.numFaces++,t.push(n))}this.faces=t,this.numVertices=0;for(e=0;e<this.numPoints;e++){var r=this.pointBuffer[e];0==r.index&&(this.vertexPointIndices[this.numVertices]=e,r.index=this.numVertices++)}},markFaceVertices:function(e,t){var n=e.getFirstEdge(),r=n;do{r.head().index=t,r=r.next}while(r!=n)},getFaces:function(){for(var e=[],t=0;t<this.faces.length;t++){var n=this.faces[t];e.push([]),this.getFaceIndices(e[t],n)}return e},getFaceIndices:function(e,t){var n=t.he0,r=0;do{var o=n.head().index;o=this.vertexPointIndices[o],e[r++]=o,n=n.next}while(n!=t.he0)},getVertices:function(){for(var e=[],t=0;t<this.numVertices;t++){var n=this.pointBuffer[this.vertexPointIndices[t]].pnt;e.push([n._x,n._y,n._z])}return e},printPoints:function(){for(var e=0;e<this.pointBuffer.length;e++){var t=this.pointBuffer[e].pnt;console.log(e+": "+t._x+", "+t._y+", "+t._z)}}},n.Plane=function(e,t){this.normal=e,this.w=t},n.Plane.fromObject=function(e){var t=new n.Vector3D(e.normal),r=parseFloat(e.w);return new n.Plane(t,r)},n.Plane.EPSILON=1e-5,n.Plane.fromVector3Ds=function(e,t,r){var o=t.minus(e).cross(r.minus(e)).unit();return new n.Plane(o,o.dot(e))},n.Plane.anyPlaneFromVector3Ds=function(e,t,r){var o=t.minus(e),i=r.minus(e);o.length()<1e-5&&(o=i.randomNonParallelVector()),i.length()<1e-5&&(i=o.randomNonParallelVector());var s=o.cross(i);return s.length()<1e-5&&(i=o.randomNonParallelVector(),s=o.cross(i)),s=s.unit(),new n.Plane(s,s.dot(e))},n.Plane.fromPoints=function(e,t,r){return e=new n.Vector3D(e),t=new n.Vector3D(t),r=new n.Vector3D(r),n.Plane.fromVector3Ds(e,t,r)},n.Plane.fromNormalAndPoint=function(e,t){e=new n.Vector3D(e),t=new n.Vector3D(t),e=e.unit();var r=t.dot(e);return new n.Plane(e,r)},n.Plane.prototype={flipped:function(){return new n.Plane(this.normal.negated(),-this.w)},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},equals:function(e){return this.normal.equals(e.normal)&&this.w==e.w},transform:function(e){var t=e.isMirroring(),r=this.normal.randomNonParallelVector(),o=this.normal.cross(r),i=this.normal.cross(o),s=this.normal.times(this.w),a=s.plus(o),l=s.plus(i);s=s.multiply4x4(e),a=a.multiply4x4(e),l=l.multiply4x4(e);var h=n.Plane.fromVector3Ds(s,a,l);return t&&(h=h.flipped()),h},splitPolygon:function(e){var t={type:null,front:null,back:null},r=this.normal,o=e.vertices,i=o.length;if(e.plane.equals(this))t.type=0;else{for(var s=n.Plane.EPSILON,a=this.w,l=!1,h=!1,c=[],u=-s,p=0;p<i;p++){var f=(C=r.dot(o[p].pos)-a)<0;c.push(f),C>s&&(l=!0),C<u&&(h=!0)}if(l||h)if(h)if(l){t.type=4;for(var d=[],g=[],m=(f=c[0],0);m<i;m++){var v=o[m],x=m+1;x>=i&&(x=0);var y=c[x];if(f==y)f?g.push(v):d.push(v);else{var w=v.pos,P=o[x].pos,_=this.splitLineBetweenPoints(w,P),V=new n.Vertex(_);f?(g.push(v),g.push(V),d.push(V)):(d.push(v),d.push(V),g.push(V))}f=y}var D=n.Plane.EPSILON*n.Plane.EPSILON;if(g.length>=3){var b=g[g.length-1];for(m=0;m<g.length;m++){(v=g[m]).pos.distanceToSquared(b.pos)<D&&(g.splice(m,1),m--),b=v}}if(d.length>=3)for(b=d[d.length-1],m=0;m<d.length;m++){(v=d[m]).pos.distanceToSquared(b.pos)<D&&(d.splice(m,1),m--),b=v}d.length>=3&&(t.front=new n.Polygon(d,e.shared,e.plane)),g.length>=3&&(t.back=new n.Polygon(g,e.shared,e.plane))}else t.type=3;else t.type=2;else{var C=r.dot(e.plane.normal);t.type=C>=0?0:1}}return t},splitLineBetweenPoints:function(e,t){var n=t.minus(e),r=(this.w-this.normal.dot(e))/this.normal.dot(n);return isNaN(r)&&(r=0),r>1&&(r=1),r<0&&(r=0),e.plus(n.times(r))},intersectWithLine:function(e){return e.intersectWithPlane(this)},intersectWithPlane:function(e){return n.Line3D.fromPlanes(this,e)},signedDistanceToPoint:function(e){return this.normal.dot(e)-this.w},toString:function(){return"[normal: "+this.normal.toString()+", w: "+this.w+"]"},mirrorPoint:function(e){var t=this.signedDistanceToPoint(e);return e.minus(this.normal.times(2*t))}},n.Polygon=function(e,t,r){this.vertices=e,t||(t=n.Polygon.defaultShared),this.shared=t,this.plane=arguments.length>=3?r:n.Plane.fromVector3Ds(e[0].pos,e[1].pos,e[2].pos)},n.Polygon.fromObject=function(e){var t=e.vertices.map(function(e){return n.Vertex.fromObject(e)}),r=n.Polygon.Shared.fromObject(e.shared),o=n.Plane.fromObject(e.plane);return new n.Polygon(t,r,o)},n.Polygon.prototype={checkIfConvex:function(){if(!n.Polygon.verticesConvex(this.vertices,this.plane.normal))throw n.Polygon.verticesConvex(this.vertices,this.plane.normal),new Error("Not convex!")},sC:function(e){var t=n.Polygon.Shared.fromColor.apply(this,arguments);return this.shared=t,this},getSignedVolume:function(){for(var e=0,t=0;t<this.vertices.length-2;t++)e+=this.vertices[0].pos.dot(this.vertices[t+1].pos.cross(this.vertices[t+2].pos));return e/=6},getArea:function(){for(var e=0,t=0;t<this.vertices.length-2;t++)e+=this.vertices[t+1].pos.minus(this.vertices[0].pos).cross(this.vertices[t+2].pos.minus(this.vertices[t+1].pos)).length();return e/=2},getTetraFeatures:function(e){var t=[];return e.forEach(function(e){"volume"==e?t.push(this.getSignedVolume()):"area"==e&&t.push(this.getArea())},this),t},extrude:function(e){var t=[],r=this;r.plane.normal.dot(e)>0&&(r=r.flipped()),t.push(r);for(var o=r.tr(e),i=this.vertices.length,s=0;s<i;s++){var a=[],l=s<i-1?s+1:0;a.push(r.vertices[s].pos),a.push(o.vertices[s].pos),a.push(o.vertices[l].pos),a.push(r.vertices[l].pos);var h=n.Polygon.createFromPoints(a,this.shared);t.push(h)}return o=o.flipped(),t.push(o),n.fromPolygons(t)},tr:function(e){return this.transform(n.Matrix4x4.translation(e))},boundingSphere:function(){if(!this.cachedBoundingSphere){var e=this.boundingBox(),t=e[0].plus(e[1]).times(.5),n=e[1].minus(t).length();this.cachedBoundingSphere=[t,n]}return this.cachedBoundingSphere},boundingBox:function(){if(!this.cachedBoundingBox){var e,t,r=this.vertices,o=r.length;t=e=0===o?new n.Vector3D(0,0,0):r[0].pos;for(var i=1;i<o;i++){var s=r[i].pos;e=e.min(s),t=t.max(s)}this.cachedBoundingBox=[e,t]}return this.cachedBoundingBox},flipped:function(){var e=this.vertices.map(function(e){return e.flipped()});e.reverse();var t=this.plane.flipped();return new n.Polygon(e,this.shared,t)},transform:function(e){var t=this.vertices.map(function(t){return t.transform(e)}),r=this.plane.transform(e);return e.isMirroring()&&t.reverse(),new n.Polygon(t,this.shared,r)},toString:function(){var e="Polygon plane: "+this.plane.toString()+"\n";return this.vertices.map(function(t){e+="  "+t.toString()+"\n"}),e},projectToOrthoNormalBasis:function(e){var t=this.vertices.map(function(t){return e.to2D(t.pos)}),n=o.fromPointsNoCheck(t),r=n.area();return Math.abs(r)<1e-5?n=new o:r<0&&(n=n.flipped()),n},solidFromSlices:function(e){var t,r=[],o=null,i=null,s=null,a=null,l=2,h=!1,c=null;if(e&&(h=Boolean(e.loop),e.numslices&&(l=e.numslices),e.callback&&(t=e.callback)),!t){var u=new n.Polygon.createFromPoints([[0,0,0],[1,0,0],[1,1,0],[0,1,0]]);t=function(e,t){return 0==e||1==e?u.tr([0,0,e]):null}}for(var p=0,f=l-1;p<=f;p++)if(o=t.call(this,p/f,p)){if(!(o instanceof n.Polygon))throw new Error("CSG.Polygon.solidFromSlices callback error: CSG.Polygon expected");o.checkIfConvex(),i?(null===c&&(c=i.plane.signedDistanceToPoint(o.vertices[0].pos)<0),this._addWalls(r,i,o,c)):s=o,i=o}(a=o,h)?s.vertices.length==a.vertices.length&&s.vertices.every(function(e,t){return e.pos.equals(a.vertices[t].pos)})||this._addWalls(r,a,s,c):(r.unshift(c?s:s.flipped()),r.push(c?a.flipped():a));return n.fromPolygons(r)},_addWalls:function(e,t,r,o){var s=t.vertices.slice(0),a=r.vertices.slice(0),l=r.shared||null;s[0].pos.equals(s[s.length-1].pos)||s.push(s[0]),a[0].pos.equals(a[a.length-1].pos)||a.push(a[0]),o&&(s=s.reverse(),a=a.reverse());for(var h,c=a.length-1,u=s.length-1,p=c-u,f=p>0,d=p<0,g=[],m=Math.abs(p);m>0;m--)g.push({len:1/0,index:-1});if(d)for(m=0;m<u;m++){h=s[m].pos.distanceToSquared(s[m+1].pos);for(var v=g.length-1;v>=0;v--)if(g[v].len>h){g[v].len=h,g.index=v;break}}else if(f)for(m=0;m<c;m++){h=a[m].pos.distanceToSquared(a[m+1].pos);for(v=g.length-1;v>=0;v--)if(g[v].len>h){g[v].len=h,g.index=v;break}}g.sort(i);for(var x,y=function(e,t,r,o){return new n.Polygon([e,t,r],o)},w=s[0],P=a[0],_=0,V=0,D=c+u;_+V<D;){if(g.length){if(f&&V==g[0].index){x=a[++V],e.push(y(x,P,w,l)),P=x,g.shift();continue}if(d&&_==g[0].index){x=s[++_],e.push(y(P,w,x,l)),w=x,g.shift();continue}}(_<u?P.pos.distanceToSquared(s[_+1].pos):1/0)<=(V<c?w.pos.distanceToSquared(a[V+1].pos):1/0)?(x=s[++_],e.push(y(P,w,x,l)),w=x):V<c&&(x=a[++V],e.push(y(x,P,w,l)),P=x)}return e}},n.Polygon.verticesConvex=function(e,t){var r=e.length;if(r>2)for(var o=e[r-2].pos,i=e[r-1].pos,s=0;s<r;s++){var a=e[s].pos;if(!n.Polygon.isConvexPoint(o,i,a,t))return!1;o=i,i=a}return!0},n.Polygon.createFromPoints=function(e,t,r){arguments.length<3?new n.Vector3D(0,0,0):r.normal;var o=[];return e.map(function(e){var t=new n.Vector3D(e),r=new n.Vertex(t);o.push(r)}),arguments.length<3?new n.Polygon(o,t):new n.Polygon(o,t,r)},n.Polygon.isConvexPoint=function(e,t,n,r){return t.minus(e).cross(n.minus(t)).dot(r)>=0},n.Polygon.isStrictlyConvexPoint=function(e,t,n,r){return t.minus(e).cross(n.minus(t)).dot(r)>=1e-5},n.Polygon.Shared=function(e){if(null!==e&&4!=e.length)throw new Error("Expecting 4 element array");this.color=e},n.Polygon.Shared.fromObject=function(e){return new n.Polygon.Shared(e.color)},n.Polygon.Shared.fromColor=function(e){var t;if(1==arguments.length)t=arguments[0].slice();else{t=[];for(var r=0;r<arguments.length;r++)t.push(arguments[r])}if(3==t.length)t.push(1);else if(4!=t.length)throw new Error("setColor expects either an array with 3 or 4 elements, or 3 or 4 parameters.");return new n.Polygon.Shared(t)},n.Polygon.Shared.prototype={getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},getHash:function(){return this.color?this.color.join("/"):"null"}},n.Polygon.defaultShared=new n.Polygon.Shared(null),n.PolygonTreeNode=function(){this.parent=null,this.children=[],this.polygon=null,this.removed=!1},n.PolygonTreeNode.prototype={addPolygons:function(e){if(!this.isRootNode())throw new Error("Assertion failed");var t=this;e.map(function(e){t.addChild(e)})},remove:function(){if(!this.removed){this.removed=!0;var e=this.parent.children,t=e.indexOf(this);if(t<0)throw new Error("Assertion failed");e.splice(t,1),this.parent.recursivelyInvalidatePolygon()}},isRemoved:function(){return this.removed},isRootNode:function(){return!this.parent},invert:function(){if(!this.isRootNode())throw new Error("Assertion failed");this.invertSub()},getPolygon:function(){if(!this.polygon)throw new Error("Assertion failed");return this.polygon},getPolygons:function(e){var t,n,r,o,i=[this],s=[i];for(t=0;t<s.length;++t)for(n=0,r=(i=s[t]).length;n<r;n++)(o=i[n]).polygon?e.push(o.polygon):s.push(o.children)},splitByPlane:function(e,t,n,r,o){if(this.children.length){var i,s,a,l,h,c=[this.children];for(i=0;i<c.length;i++)for(s=0,a=(h=c[i]).length;s<a;s++)(l=h[s]).children.length?c.push(l.children):l._splitByPlane(e,t,n,r,o)}else this._splitByPlane(e,t,n,r,o)},_splitByPlane:function(e,t,n,r,o){var i=this.polygon;if(i){var s=i.boundingSphere(),a=s[1]+1e-4,l=e.normal,h=s[0],c=l.dot(h)-e.w;if(c>a)r.push(this);else if(c<-a)o.push(this);else{var u=e.splitPolygon(i);switch(u.type){case 0:t.push(this);break;case 1:n.push(this);break;case 2:r.push(this);break;case 3:o.push(this);break;case 4:if(u.front){var p=this.addChild(u.front);r.push(p)}if(u.back){var f=this.addChild(u.back);o.push(f)}}}}},addChild:function(e){var t=new n.PolygonTreeNode;return t.parent=this,t.polygon=e,this.children.push(t),t},invertSub:function(){var e,t,n,r,o=[this],i=[o];for(e=0;e<i.length;e++)for(t=0,n=(o=i[e]).length;t<n;t++)(r=o[t]).polygon&&(r.polygon=r.polygon.flipped()),i.push(r.children)},recursivelyInvalidatePolygon:function(){for(var e=this;e.polygon;)e.polygon=null,e.parent&&(e=e.parent)}},n.Tree=function(e){this.polygonTree=new n.PolygonTreeNode,this.rootnode=new n.Node(null),e&&this.addPolygons(e)},n.Tree.prototype={invert:function(){this.polygonTree.invert(),this.rootnode.invert()},clipTo:function(e,t){t=!!t,this.rootnode.clipTo(e,t)},allPolygons:function(){var e=[];return this.polygonTree.getPolygons(e),e},addPolygons:function(e){var t=this,n=e.map(function(e){return t.polygonTree.addChild(e)});this.rootnode.addPolygonTreeNodes(n)}},n.Node=function(e){this.plane=null,this.front=null,this.back=null,this.polygontreenodes=[],this.parent=e},n.Node.prototype={invert:function(){for(var e,t=[this],n=0;n<t.length;n++){(e=t[n]).plane&&(e.plane=e.plane.flipped()),e.front&&t.push(e.front),e.back&&t.push(e.back);var r=e.front;e.front=e.back,e.back=r}},clipPolygons:function(e,t){var n,r={node:this,polygontreenodes:e},o=[];do{if(n=r.node,e=r.polygontreenodes,n.plane){var i=[],s=[],a=t?i:s,l=n.plane,h=e.length;for(p=0;p<h;p++){var c=e[p];c.isRemoved()||c.splitByPlane(l,a,i,s,i)}n.front&&s.length>0&&o.push({node:n.front,polygontreenodes:s});var u=i.length;if(n.back&&u>0)o.push({node:n.back,polygontreenodes:i});else for(var p=0;p<u;p++)i[p].remove()}r=o.pop()}while(void 0!==r)},clipTo:function(e,t){var n=this,r=[];do{n.polygontreenodes.length>0&&e.rootnode.clipPolygons(n.polygontreenodes,t),n.front&&r.push(n.front),n.back&&r.push(n.back),n=r.pop()}while(void 0!==n)},addPolygonTreeNodes:function(e){var t,r={node:this,polygontreenodes:e},o=[];do{if(t=r.node,0!==(e=r.polygontreenodes).length){var i=t;if(!t.plane){var s=e[0].getPolygon().plane;t.plane=s}for(var a=[],l=[],h=0,c=e.length;h<c;++h)e[h].splitByPlane(i.plane,i.polygontreenodes,l,a,l);a.length>0&&(t.front||(t.front=new n.Node(t)),o.push({node:t.front,polygontreenodes:a})),l.length>0&&(t.back||(t.back=new n.Node(t)),o.push({node:t.back,polygontreenodes:l})),r=o.pop()}else r=o.pop()}while(void 0!==r)},getParentPlaneNormals:function(e,t){t>0&&this.parent&&(e.push(this.parent.plane.normal),this.parent.getParentPlaneNormals(e,t-1))}},n.Matrix4x4=function(e){this.elements=arguments.length>=1?e:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},n.Matrix4x4.prototype={plus:function(e){for(var t=[],r=0;r<16;r++)t[r]=this.elements[r]+e.elements[r];return new n.Matrix4x4(t)},minus:function(e){for(var t=[],r=0;r<16;r++)t[r]=this.elements[r]-e.elements[r];return new n.Matrix4x4(t)},multiply:function(e){var t=this.elements[0],r=this.elements[1],o=this.elements[2],i=this.elements[3],s=this.elements[4],a=this.elements[5],l=this.elements[6],h=this.elements[7],c=this.elements[8],u=this.elements[9],p=this.elements[10],f=this.elements[11],d=this.elements[12],g=this.elements[13],m=this.elements[14],v=this.elements[15],x=e.elements[0],y=e.elements[1],w=e.elements[2],P=e.elements[3],_=e.elements[4],V=e.elements[5],D=e.elements[6],b=e.elements[7],C=e.elements[8],S=e.elements[9],O=e.elements[10],M=e.elements[11],T=e.elements[12],A=e.elements[13],z=e.elements[14],E=e.elements[15],F=[];return F[0]=t*x+r*_+o*C+i*T,F[1]=t*y+r*V+o*S+i*A,F[2]=t*w+r*D+o*O+i*z,F[3]=t*P+r*b+o*M+i*E,F[4]=s*x+a*_+l*C+h*T,F[5]=s*y+a*V+l*S+h*A,F[6]=s*w+a*D+l*O+h*z,F[7]=s*P+a*b+l*M+h*E,F[8]=c*x+u*_+p*C+f*T,F[9]=c*y+u*V+p*S+f*A,F[10]=c*w+u*D+p*O+f*z,F[11]=c*P+u*b+p*M+f*E,F[12]=d*x+g*_+m*C+v*T,F[13]=d*y+g*V+m*S+v*A,F[14]=d*w+g*D+m*O+v*z,F[15]=d*P+g*b+m*M+v*E,new n.Matrix4x4(F)},clone:function(){var e=this.elements.map(function(e){return e});return new n.Matrix4x4(e)},rightMultiply1x3Vector:function(e){var t=e._x,r=e._y,o=e._z,i=t*this.elements[0]+r*this.elements[1]+o*this.elements[2]+1*this.elements[3],s=t*this.elements[4]+r*this.elements[5]+o*this.elements[6]+1*this.elements[7],a=t*this.elements[8]+r*this.elements[9]+o*this.elements[10]+1*this.elements[11],l=t*this.elements[12]+r*this.elements[13]+o*this.elements[14]+1*this.elements[15];if(1!=l){var h=1/l;i*=h,s*=h,a*=h}return new n.Vector3D(i,s,a)},leftMultiply1x3Vector:function(e){var t=e._x,r=e._y,o=e._z,i=t*this.elements[0]+r*this.elements[4]+o*this.elements[8]+1*this.elements[12],s=t*this.elements[1]+r*this.elements[5]+o*this.elements[9]+1*this.elements[13],a=t*this.elements[2]+r*this.elements[6]+o*this.elements[10]+1*this.elements[14],l=t*this.elements[3]+r*this.elements[7]+o*this.elements[11]+1*this.elements[15];if(1!=l){var h=1/l;i*=h,s*=h,a*=h}return new n.Vector3D(i,s,a)},rightMultiply1x2Vector:function(e){var t=e.x,r=e.y,o=t*this.elements[0]+r*this.elements[1]+0*this.elements[2]+1*this.elements[3],i=t*this.elements[4]+r*this.elements[5]+0*this.elements[6]+1*this.elements[7],s=(this.elements[8],this.elements[9],this.elements[10],this.elements[11],t*this.elements[12]+r*this.elements[13]+0*this.elements[14]+1*this.elements[15]);if(1!=s){var a=1/s;o*=a,i*=a}return new n.Vector2D(o,i)},leftMultiply1x2Vector:function(e){var t=e.x,r=e.y,o=t*this.elements[0]+r*this.elements[4]+0*this.elements[8]+1*this.elements[12],i=t*this.elements[1]+r*this.elements[5]+0*this.elements[9]+1*this.elements[13],s=(this.elements[2],this.elements[6],this.elements[10],this.elements[14],t*this.elements[3]+r*this.elements[7]+0*this.elements[11]+1*this.elements[15]);if(1!=s){var a=1/s;o*=a,i*=a}return new n.Vector2D(o,i)},isMirroring:function(){var e=new n.Vector3D(this.elements[0],this.elements[4],this.elements[8]),t=new n.Vector3D(this.elements[1],this.elements[5],this.elements[9]),r=new n.Vector3D(this.elements[2],this.elements[6],this.elements[10]);return e.cross(t).dot(r)<0}},n.Matrix4x4.unity=function(){return new n.Matrix4x4},n.Matrix4x4.rotationX=function(e){var t=e*Math.PI*(1/180),r=Math.cos(t),o=Math.sin(t),i=[1,0,0,0,0,r,o,0,0,-o,r,0,0,0,0,1];return new n.Matrix4x4(i)},n.Matrix4x4.rotationY=function(e){var t=e*Math.PI*(1/180),r=Math.cos(t),o=Math.sin(t),i=[r,0,-o,0,0,1,0,0,o,0,r,0,0,0,0,1];return new n.Matrix4x4(i)},n.Matrix4x4.rotationZ=function(e){var t=e*Math.PI*(1/180),r=Math.cos(t),o=Math.sin(t),i=[r,o,0,0,-o,r,0,0,0,0,1,0,0,0,0,1];return new n.Matrix4x4(i)},n.Matrix4x4.rotation=function(e,t,r){e=new n.Vector3D(e),t=new n.Vector3D(t);var o=n.Plane.fromNormalAndPoint(t,e),i=new n.OrthoNormalBasis(o),s=n.Matrix4x4.translation(e.negated());return s=(s=(s=(s=s.multiply(i.getProjectionMatrix())).multiply(n.Matrix4x4.rotationZ(r))).multiply(i.getInverseProjectionMatrix())).multiply(n.Matrix4x4.translation(e))},n.Matrix4x4.translation=function(e){var t=new n.Vector3D(e),r=[1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,t.z,1];return new n.Matrix4x4(r)},n.Matrix4x4.mirroring=function(e){var t=e.normal.x,r=e.normal.y,o=e.normal.z,i=e.w,s=[1-2*t*t,-2*r*t,-2*o*t,0,-2*t*r,1-2*r*r,-2*o*r,0,-2*t*o,-2*r*o,1-2*o*o,0,2*t*i,2*r*i,2*o*i,1];return new n.Matrix4x4(s)},n.Matrix4x4.scaling=function(e){var t=new n.Vector3D(e),r=[t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1];return new n.Matrix4x4(r)},n.Vector2D=function(e,t){if(2==arguments.length)this._x=parseFloat(e),this._y=parseFloat(t);else{var r=!0;if(1==arguments.length)if("object"==typeof e)e instanceof n.Vector2D?(this._x=e._x,this._y=e._y):e instanceof Array?(this._x=parseFloat(e[0]),this._y=parseFloat(e[1])):"x"in e&&"y"in e?(this._x=parseFloat(e.x),this._y=parseFloat(e.y)):r=!1;else{var o=parseFloat(e);this._x=o,this._y=o}else r=!1;if(r&&(n.IsFloat(this._x)&&n.IsFloat(this._y)||(r=!1)),!r)throw new Error("wrong arguments")}},n.Vector2D.fromAngle=function(e){return n.Vector2D.fromAngleRadians(e)},n.Vector2D.fromAngleDegrees=function(e){var t=Math.PI*e/180;return n.Vector2D.fromAngleRadians(t)},n.Vector2D.fromAngleRadians=function(e){return n.Vector2D.Create(Math.cos(e),Math.sin(e))},n.Vector2D.Create=function(e,t){var r=Object.create(n.Vector2D.prototype);return r._x=e,r._y=t,r},n.Vector2D.prototype={get x(){return this._x},get y(){return this._y},set x(e){throw new Error("Vector2D is immutable")},set y(e){throw new Error("Vector2D is immutable")},toVector3D:function(e){return new n.Vector3D(this._x,this._y,e)},equals:function(e){return this._x==e._x&&this._y==e._y},clone:function(){return n.Vector2D.Create(this._x,this._y)},negated:function(){return n.Vector2D.Create(-this._x,-this._y)},plus:function(e){return n.Vector2D.Create(this._x+e._x,this._y+e._y)},minus:function(e){return n.Vector2D.Create(this._x-e._x,this._y-e._y)},times:function(e){return n.Vector2D.Create(this._x*e,this._y*e)},dividedBy:function(e){return n.Vector2D.Create(this._x/e,this._y/e)},dot:function(e){return this._x*e._x+this._y*e._y},lerp:function(e,t){return this.plus(e.minus(this).times(t))},length:function(){return Math.sqrt(this.dot(this))},distanceTo:function(e){return this.minus(e).length()},distanceToSquared:function(e){return this.minus(e).lengthSquared()},lengthSquared:function(){return this.dot(this)},unit:function(){return this.dividedBy(this.length())},cross:function(e){return this._x*e._y-this._y*e._x},normal:function(){return n.Vector2D.Create(this._y,-this._x)},multiply4x4:function(e){return e.leftMultiply1x2Vector(this)},transform:function(e){return e.leftMultiply1x2Vector(this)},angle:function(){return this.angleRadians()},angleDegrees:function(){return 180*this.angleRadians()/Math.PI},angleRadians:function(){return Math.atan2(this._y,this._x)},min:function(e){return n.Vector2D.Create(Math.min(this._x,e._x),Math.min(this._y,e._y))},max:function(e){return n.Vector2D.Create(Math.max(this._x,e._x),Math.max(this._y,e._y))},toString:function(){return"("+this._x.toFixed(2)+", "+this._y.toFixed(2)+")"},abs:function(){return n.Vector2D.Create(Math.abs(this._x),Math.abs(this._y))}},n.Line2D=function(e,t){e=new n.Vector2D(e),t=parseFloat(t);var r=e.length();t*=r,e=e.times(1/r),this.normal=e,this.w=t},n.Line2D.fromPoints=function(e,t){e=new n.Vector2D(e);var r=(t=new n.Vector2D(t)).minus(e).normal().negated().unit(),o=e.dot(r);return new n.Line2D(r,o)},n.Line2D.prototype={reverse:function(){return new n.Line2D(this.normal.negated(),-this.w)},equals:function(e){return e.normal.equals(this.normal)&&e.w==this.w},origin:function(){return this.normal.times(this.w)},direction:function(){return this.normal.normal()},xAtY:function(e){return(this.w-this.normal._y*e)/this.normal.x},absDistanceToPoint:function(e){var t=(e=new n.Vector2D(e)).dot(this.normal);return Math.abs(t-this.w)},intersectWithLine:function(e){var t=n.solve2Linear(this.normal.x,this.normal.y,e.normal.x,e.normal.y,this.w,e.w);return t=new n.Vector2D(t)},transform:function(e){var t=new n.Vector2D(0,0),r=this.normal.times(this.w),o=t.multiply4x4(e),i=this.normal.multiply4x4(e).minus(o),s=r.multiply4x4(e),a=i.dot(s);return new n.Line2D(i,a)}},n.Line3D=function(e,t){e=new n.Vector3D(e),t=new n.Vector3D(t),this.point=e,this.direction=t.unit()},n.Line3D.fromPoints=function(e,t){e=new n.Vector3D(e);var r=(t=new n.Vector3D(t)).minus(e);return new n.Line3D(e,r)},n.Line3D.fromPlanes=function(e,t){var r=e.normal.cross(t.normal),o=r.length();if(o<1e-10)throw new Error("Parallel planes");r=r.times(1/o);var i,s=Math.abs(r.x),a=Math.abs(r.y),l=Math.abs(r.z);if(s>=a&&s>=l){var h=n.solve2Linear(e.normal.y,e.normal.z,t.normal.y,t.normal.z,e.w,t.w);i=new n.Vector3D(0,h[0],h[1])}else if(a>=s&&a>=l){h=n.solve2Linear(e.normal.x,e.normal.z,t.normal.x,t.normal.z,e.w,t.w);i=new n.Vector3D(h[0],0,h[1])}else{h=n.solve2Linear(e.normal.x,e.normal.y,t.normal.x,t.normal.y,e.w,t.w);i=new n.Vector3D(h[0],h[1],0)}return new n.Line3D(i,r)},n.Line3D.prototype={intersectWithPlane:function(e){var t=(e.w-e.normal.dot(this.point))/e.normal.dot(this.direction);return this.point.plus(this.direction.times(t))},clone:function(e){return new n.Line3D(this.point.clone(),this.direction.clone())},reverse:function(){return new n.Line3D(this.point.clone(),this.direction.negated())},transform:function(e){var t=this.point.multiply4x4(e),r=this.point.plus(this.direction).multiply4x4(e).minus(t);return new n.Line3D(t,r)},closestPointOnLine:function(e){var t=(e=new n.Vector3D(e)).minus(this.point).dot(this.direction)/this.direction.dot(this.direction);return this.point.plus(this.direction.times(t))},distanceToPoint:function(e){e=new n.Vector3D(e);var t=this.closestPointOnLine(e);return e.minus(t).length()},equals:function(e){return!!this.direction.equals(e.direction)&&!(this.distanceToPoint(e.point)>1e-8)}},n.OrthoNormalBasis=function(e,t){t=arguments.length<2?e.normal.randomNonParallelVector():new n.Vector3D(t),this.v=e.normal.cross(t).unit(),this.u=this.v.cross(e.normal),this.plane=e,this.planeorigin=e.normal.times(e.w)},n.OrthoNormalBasis.GetCartesian=function(e,t){var r,o,i=e+"/"+t;if("X/Y"==i)r=[0,0,1],o=[1,0,0];else if("Y/-X"==i)r=[0,0,1],o=[0,1,0];else if("-X/-Y"==i)r=[0,0,1],o=[-1,0,0];else if("-Y/X"==i)r=[0,0,1],o=[0,-1,0];else if("-X/Y"==i)r=[0,0,-1],o=[-1,0,0];else if("-Y/-X"==i)r=[0,0,-1],o=[0,-1,0];else if("X/-Y"==i)r=[0,0,-1],o=[1,0,0];else if("Y/X"==i)r=[0,0,-1],o=[0,1,0];else if("X/Z"==i)r=[0,-1,0],o=[1,0,0];else if("Z/-X"==i)r=[0,-1,0],o=[0,0,1];else if("-X/-Z"==i)r=[0,-1,0],o=[-1,0,0];else if("-Z/X"==i)r=[0,-1,0],o=[0,0,-1];else if("-X/Z"==i)r=[0,1,0],o=[-1,0,0];else if("-Z/-X"==i)r=[0,1,0],o=[0,0,-1];else if("X/-Z"==i)r=[0,1,0],o=[1,0,0];else if("Z/X"==i)r=[0,1,0],o=[0,0,1];else if("Y/Z"==i)r=[1,0,0],o=[0,1,0];else if("Z/-Y"==i)r=[1,0,0],o=[0,0,1];else if("-Y/-Z"==i)r=[1,0,0],o=[0,-1,0];else if("-Z/Y"==i)r=[1,0,0],o=[0,0,-1];else if("-Y/Z"==i)r=[-1,0,0],o=[0,-1,0];else if("-Z/-Y"==i)r=[-1,0,0],o=[0,0,-1];else if("Y/-Z"==i)r=[-1,0,0],o=[0,1,0];else{if("Z/Y"!=i)throw new Error("CSG.OrthoNormalBasis.GetCartesian: invalid combination of axis identifiers. Should pass two string arguments from [X,Y,Z,-X,-Y,-Z], being two different axes.");r=[-1,0,0],o=[0,0,1]}return new n.OrthoNormalBasis(new n.Plane(new n.Vector3D(r),0),new n.Vector3D(o))},n.OrthoNormalBasis.Z0Plane=function(){var e=new n.Plane(new n.Vector3D([0,0,1]),0);return new n.OrthoNormalBasis(e,new n.Vector3D([1,0,0]))},n.OrthoNormalBasis.prototype={getProjectionMatrix:function(){return new n.Matrix4x4([this.u.x,this.v.x,this.plane.normal.x,0,this.u.y,this.v.y,this.plane.normal.y,0,this.u.z,this.v.z,this.plane.normal.z,0,0,0,-this.plane.w,1])},getInverseProjectionMatrix:function(){var e=this.plane.normal.times(this.plane.w);return new n.Matrix4x4([this.u.x,this.u.y,this.u.z,0,this.v.x,this.v.y,this.v.z,0,this.plane.normal.x,this.plane.normal.y,this.plane.normal.z,0,e.x,e.y,e.z,1])},to2D:function(e){return new n.Vector2D(e.dot(this.u),e.dot(this.v))},to3D:function(e){return this.planeorigin.plus(this.u.times(e.x)).plus(this.v.times(e.y))},line3Dto2D:function(e){var t=e.point,r=e.direction.plus(t),o=this.to2D(t),i=this.to2D(r);return n.Line2D.fromPoints(o,i)},line2Dto3D:function(e){var t=e.origin(),r=e.direction().plus(t),o=this.to3D(t),i=this.to3D(r);return n.Line3D.fromPoints(o,i)},transform:function(e){var t=this.plane.transform(e),r=this.u.transform(e),o=new n.Vector3D(0,0,0).transform(e),i=r.minus(o);return new n.OrthoNormalBasis(t,i)}},n.interpolateBetween2DPointsForY=function(e,t,n){var r,o=n-e.y,i=t.y-e.y;return i<0&&(o=-o,i=-i),r=o<=0?0:o>=i?1:i<1e-10?.5:o/i,e.x+r*(t.x-e.x)},n.reTesselateCoplanarPolygons=function(e,o){var i=1e-5,s=e.length;if(s>0){for(var a=e[0].plane,l=e[0].shared,h=new n.OrthoNormalBasis(a),c=[],u=[],p={},f={},d={},g=1/i*10,m=0;m<s;m++){var v=e[m],x=[],y=-1;if((N=v.vertices.length)>0){for(var w,P,_=0;_<N;_++){var V,D=h.to2D(v.vertices[_].pos),b=Math.floor(D.y*g);b in d?V=d[b]:b+1 in d?V=d[b+1]:b-1 in d?V=d[b-1]:(V=D.y,d[b]=D.y),D=n.Vector2D.Create(D.x,V),x.push(D);var C=D.y;(0===_||C<w)&&(w=C,y=_),(0===_||C>P)&&(P=C,_),C in f||(f[C]={}),f[C][m]=!0}w>=P?(x=[],N=0,y=-1):(w in p||(p[w]=[]),p[w].push(m))}x.reverse(),y=N-y-1,c.push(x),u.push(y)}var S=[];for(var O in f)S.push(O);S.sort(t);for(var M=[],T=[],A=0;A<S.length;A++){for(var z,E=[],F=S[A],B=(O=Number(F),f[F]),I=0;I<M.length;++I){if(B[m=(H=M[I]).polygonindex]){for(var N=(x=c[m]).length,L=H.leftvertexindex,k=H.rightvertexindex;;){if((U=L+1)>=N&&(U=0),x[U].y!=O)break;L=U}if((q=k-1)<0&&(q=N-1),x[q].y==O&&(k=q),L!=H.leftvertexindex&&L==k)M.splice(I,1),--I;else H.leftvertexindex=L,H.rightvertexindex=k,H.topleft=x[L],H.topright=x[k],(U=L+1)>=N&&(U=0),H.bottomleft=x[U],(q=k-1)<0&&(q=N-1),H.bottomright=x[q]}}if(A>=S.length-1)M=[],z=null;else{var R=.5*(O+(z=Number(S[A+1]))),j=p[F];for(var G in j){N=(x=c[m=j[G]]).length;for(var Z=u[m],Y=Z;;){if((_=Y+1)>=N&&(_=0),x[_].y!=O)break;if(_==Z)break;Y=_}for(var X=Z;;){if((_=X-1)<0&&(_=N-1),x[_].y!=O)break;if(_==Y)break;X=_}var U,q;(U=Y+1)>=N&&(U=0),(q=X-1)<0&&(q=N-1),r(M,{polygonindex:m,leftvertexindex:Y,rightvertexindex:X,topleft:x[Y],topright:x[X],bottomleft:x[U],bottomright:x[q]},function(e,t){var r=n.interpolateBetween2DPointsForY(e.topleft,e.bottomleft,R),o=n.interpolateBetween2DPointsForY(t.topleft,t.bottomleft,R);return r>o?1:r<o?-1:0})}}for(var W in M){N=(x=c[m=(H=M[W]).polygonindex]).length;var H,$=n.interpolateBetween2DPointsForY(H.topleft,H.bottomleft,O),J=n.Vector2D.Create($,O);$=n.interpolateBetween2DPointsForY(H.topright,H.bottomright,O);var K=n.Vector2D.Create($,O);$=n.interpolateBetween2DPointsForY(H.topleft,H.bottomleft,z);var Q=n.Vector2D.Create($,z);$=n.interpolateBetween2DPointsForY(H.topright,H.bottomright,z);var ee=n.Vector2D.Create($,z),te={topleft:J,topright:K,bottomleft:Q,bottomright:ee,leftline:n.Line2D.fromPoints(J,Q),rightline:n.Line2D.fromPoints(ee,K)};if(E.length>0){var ne=E[E.length-1],re=te.topleft.distanceTo(ne.topright),oe=te.bottomleft.distanceTo(ne.bottomright);re<i&&oe<i&&(te.topleft=ne.topleft,te.leftline=ne.leftline,te.bottomleft=ne.bottomleft,E.splice(E.length-1,1))}E.push(te)}if(A>0){var ie={},se={};for(_=0;_<E.length;_++)for(var ae=E[_],le=0;le<T.length;le++){if(!se[le])if((ue=T[le]).bottomleft.distanceTo(ae.topleft)<i&&ue.bottomright.distanceTo(ae.topright)<i){se[le]=!0;re=ae.leftline.direction().x-ue.leftline.direction().x,oe=ae.rightline.direction().x-ue.rightline.direction().x;var he=Math.abs(re)<i,ce=Math.abs(oe)<i;(he||re>=0)&&(ce||oe>=0)&&(ae.outpolygon=ue.outpolygon,ae.leftlinecontinues=he,ae.rightlinecontinues=ce,ie[le]=!0);break}}for(le=0;le<T.length;le++)if(!ie[le]){var ue;(ue=T[le]).outpolygon.rightpoints.push(ue.bottomright),ue.bottomright.distanceTo(ue.bottomleft)>i&&ue.outpolygon.leftpoints.push(ue.bottomleft),ue.outpolygon.leftpoints.reverse();var pe=ue.outpolygon.rightpoints.concat(ue.outpolygon.leftpoints),fe=[];pe.map(function(e){var t=h.to3D(e),r=new n.Vertex(t);fe.push(r)});var de=new n.Polygon(fe,l,a);o.push(de)}}for(_=0;_<E.length;_++){(ae=E[_]).outpolygon?(ae.leftlinecontinues||ae.outpolygon.leftpoints.push(ae.topleft),ae.rightlinecontinues||ae.outpolygon.rightpoints.push(ae.topright)):(ae.outpolygon={leftpoints:[],rightpoints:[]},ae.outpolygon.leftpoints.push(ae.topleft),ae.topleft.distanceTo(ae.topright)>i&&ae.outpolygon.rightpoints.push(ae.topright))}T=E}}},n.fuzzyFactory=function(e,t){this.lookuptable={},this.multiplier=1/t},n.fuzzyFactory.prototype={lookupOrCreate:function(e,t){var n="",r=this.multiplier;if(e.forEach(function(e){var t=Math.round(e*r);n+=t+"/"}),n in this.lookuptable)return this.lookuptable[n];for(var o=t(e),i=e.map(function(e){var t=Math.floor(e*r);return[t+"/",t+1+"/"]}),s=1<<e.length,a=0;a<s;++a){var l=a;n="",i.forEach(function(e){n+=e[1&l],l>>=1}),this.lookuptable[n]=o}return o}},n.fuzzyCSGFactory=function(){this.vertexfactory=new n.fuzzyFactory(3,1e-5),this.planefactory=new n.fuzzyFactory(4,1e-5),this.polygonsharedfactory={}},n.fuzzyCSGFactory.prototype={getPolygonShared:function(e){var t=e.getHash();return t in this.polygonsharedfactory?this.polygonsharedfactory[t]:(this.polygonsharedfactory[t]=e,e)},getVertex:function(e){var t=[e.pos._x,e.pos._y,e.pos._z];return this.vertexfactory.lookupOrCreate(t,function(t){return e})},getPlane:function(e){var t=[e.normal._x,e.normal._y,e.normal._z,e.w];return this.planefactory.lookupOrCreate(t,function(t){return e})},getPolygon:function(e){var t=this.getPlane(e.plane),r=this.getPolygonShared(e.shared),o=this,i=e.vertices.map(function(e){return o.getVertex(e)}),s=[];if(i.length>0){var a=i[i.length-1].getTag();i.forEach(function(e){var t=e.getTag();t!=a&&s.push(e),a=t})}return s.length<3&&(s=[]),new n.Polygon(s,r,t)},getCSG:function(e){var t=this,r=[];return e.polygons.forEach(function(e){var n=t.getPolygon(e);n.vertices.length>=3&&r.push(n)}),n.fromPolygons(r)}},n.staticTag=1,n.getTag=function(){return n.staticTag++},n.Properties=function(){},n.Properties.prototype={_transform:function(e){var t=new n.Properties;return n.Properties.transformObj(this,t,e),t},_merge:function(e){var t=new n.Properties;return n.Properties.cloneObj(this,t),n.Properties.addFrom(t,e),t}},n.Properties.transformObj=function(e,t,r){for(var o in e)if("_transform"!=o&&"_merge"!=o){var i=e[o],s=i;"object"==typeof i&&("transform"in i&&"function"==typeof i.transform?s=i.transform(r):i instanceof Array?(s=[],n.Properties.transformObj(i,s,r)):i instanceof n.Properties&&(s=new n.Properties,n.Properties.transformObj(i,s,r))),t[o]=s}},n.Properties.cloneObj=function(e,t){for(var r in e)if("_transform"!=r&&"_merge"!=r){var o=e[r],i=o;if("object"==typeof o)if(o instanceof Array){i=[];for(var s=0;s<o.length;s++)i.push(o[s])}else o instanceof n.Properties&&(i=new n.Properties,n.Properties.cloneObj(o,i));t[r]=i}},n.Properties.addFrom=function(e,t){for(var r in t)"_transform"!=r&&"_merge"!=r&&(r in e&&"object"==typeof e[r]&&e[r]instanceof n.Properties&&"object"==typeof t[r]&&t[r]instanceof n.Properties?n.Properties.addFrom(e[r],t[r]):r in e||(e[r]=t[r]))},n.Connector=function(e,t,r){this.point=new n.Vector3D(e),this.axisvector=new n.Vector3D(t).unit(),this.normalvector=new n.Vector3D(r).unit()},n.Connector.prototype={normalized:function(){var e=this.axisvector.unit(),t=this.normalvector.cross(e).unit(),r=e.cross(t);return new n.Connector(this.point,e,r)},transform:function(e){var t=this.point.multiply4x4(e),r=this.point.plus(this.axisvector).multiply4x4(e).minus(t),o=this.point.plus(this.normalvector).multiply4x4(e).minus(t);return new n.Connector(t,r,o)},getTransformationTo:function(e,t,r){t=!!t,r=r?Number(r):0;var o=this.normalized();e=e.normalized();var i=n.Matrix4x4.translation(this.point.negated()),s=n.Plane.anyPlaneFromVector3Ds(new n.Vector3D(0,0,0),o.axisvector,e.axisvector),a=new n.OrthoNormalBasis(s),l=a.to2D(o.axisvector).angle(),h=a.to2D(e.axisvector).angle(),c=180*(h-l)/Math.PI;t&&(c+=180),i=(i=(i=i.multiply(a.getProjectionMatrix())).multiply(n.Matrix4x4.rotationZ(c))).multiply(a.getInverseProjectionMatrix());var u=o.transform(i),p=n.Plane.fromNormalAndPoint(e.axisvector,new n.Vector3D(0,0,0)),f=new n.OrthoNormalBasis(p);return l=f.to2D(u.normalvector).angle(),c=180*((h=f.to2D(e.normalvector).angle())-l)/Math.PI,c+=r,i=(i=(i=(i=i.multiply(f.getProjectionMatrix())).multiply(n.Matrix4x4.rotationZ(c))).multiply(f.getInverseProjectionMatrix())).multiply(n.Matrix4x4.translation(e.point))},axisLine:function(){return new n.Line3D(this.point,this.axisvector)},extend:function(e){var t=this.point.plus(this.axisvector.unit().times(e));return new n.Connector(t,this.axisvector,this.normalvector)}},n.ConnectorList=function(e){this.connectors_=e?e.slice():[]},n.ConnectorList.defaultNormal=[0,0,1],n.ConnectorList.fromPath2D=function(e,t,r){if(3===arguments.length)return n.ConnectorList._fromPath2DTangents(e,t,r);if(2==arguments.length)return n.ConnectorList._fromPath2DExplicit(e,t);throw"call with path2D and either 2 direction vectors, or a function returning direction vectors"},n.ConnectorList._fromPath2DTangents=function(e,t,r){var o,i=e.points.length,s=new n.ConnectorList([new n.Connector(e.points[0],t,n.ConnectorList.defaultNormal)]);return e.points.slice(1,i-1).forEach(function(t,r){o=e.points[r+2].minus(e.points[r]).toVector3D(0),s.appendConnector(new n.Connector(t.toVector3D(0),o,n.ConnectorList.defaultNormal))},this),s.appendConnector(new n.Connector(e.points[i-1],r,n.ConnectorList.defaultNormal)),s.closed=e.closed,s},n.ConnectorList._fromPath2DExplicit=function(e,t){var r=new n.ConnectorList(e.points.map(function(e,r){return new n.Connector(e.toVector3D(0),n.Vector3D.Create(1,0,0).rZ(function(e,t,n){return"function"==typeof e&&(e=e(t,n)),e}(t,e,r)),n.ConnectorList.defaultNormal)},this));return r.closed=e.closed,r},n.ConnectorList.prototype={setClosed:function(e){this.closed=!!closed},appendConnector:function(e){this.connectors_.push(e)},followWith:function(e){function t(e,t){return"function"==typeof e&&(e=e(t.point,t.axisvector,t.normalvector)),e}this.verify();var r,o=[],i=this.connectors_[this.connectors_.length-1],s=t(e,i);return this.connectors_.forEach(function(n,a){r=t(e,n),a||this.closed?o.push.apply(o,s._toWallPolygons({toConnector1:i,toConnector2:n,cag:r})):o.push.apply(o,r._toPlanePolygons({toConnector:n,flipped:!0})),a!=this.connectors_.length-1||this.closed||o.push.apply(o,r._toPlanePolygons({toConnector:n})),s=r,i=n},this),n.fromPolygons(o).reTesselated().canonicalized()},verify:function(){for(var e,t,n=0;n<this.connectors_.length-1;n++){if(e=this.connectors_[n],(t=this.connectors_[n+1]).point.minus(e.point).dot(e.axisvector)<=0)throw"Invalid ConnectorList. Each connectors position needs to be within a <90deg range of previous connectors axisvector";if(e.axisvector.dot(t.axisvector)<=0)throw"invalid ConnectorList. No neighboring connectors axisvectors may span a >=90deg angle"}}},n.Path2D=function(e,t){e=e||[];var r=null;(t=!!t)&&e.length>0&&(r=new n.Vector2D(e[e.length-1]));var o=[];e.map(function(e){e=new n.Vector2D(e);var t=!1;null!==r&&(t=e.distanceTo(r)<1e-5);t||o.push(e),r=e}),this.points=o,this.closed=t},n.Path2D.arc=function(e){for(var t=n.parseOptionAs2DVector(e,"center",0),r=n.parseOptionAsFloat(e,"radius",1),o=n.parseOptionAsFloat(e,"startangle",0),i=n.parseOptionAsFloat(e,"endangle",360),s=n.parseOptionAsInt(e,"resolution",n.defaultResolution2D),a=n.parseOptionAsBool(e,"maketangent",!1);i-o>=720;)i-=360;for(;i-o<=-720;)i+=360;var l,h=[],c=Math.abs(i-o);if(c<1e-5)l=n.Vector2D.fromAngle(o/180*Math.PI).times(r),h.push(l.plus(t));else{var u=Math.floor(s*c/360)+1,p=.5*u/c;p>.25&&(p=.25);for(var f=a?u+2:u,d=0;d<=f;d++){var g=d;a&&((g=(d-1)*(u-2*p)/u+p)<0&&(g=0),g>u&&(g=u));var m=o+g*(i-o)/u;l=n.Vector2D.fromAngle(m/180*Math.PI).times(r),h.push(l.plus(t))}}return new n.Path2D(h,!1)},n.Path2D.prototype={concat:function(e){if(this.closed||e.closed)throw new Error("Paths must not be closed");var t=this.points.concat(e.points);return new n.Path2D(t)},appendPoint:function(e){if(this.closed)throw new Error("Path must not be closed");e=new n.Vector2D(e);var t=this.points.concat([e]);return new n.Path2D(t)},appendPoints:function(e){if(this.closed)throw new Error("Path must not be closed");var t=this.points;return e.forEach(function(e){t.push(new n.Vector2D(e))}),new n.Path2D(t)},close:function(){return new n.Path2D(this.points,!0)},rectangularExtrude:function(e,t,n){return this.expandToCAG(e/2,n).extrude({offset:[0,0,t]})},expandToCAG:function(e,t){var n,r=[],i=this.points.length,s=0;this.closed&&i>2&&(s=-1);for(var a=s;a<i;a++){var l=a;l<0&&(l=i-1);var h=this.points[l],c=new o.Vertex(h);if(a>s){var u=new o.Side(n,c);r.push(u)}n=c}return o.fromSides(r).expandedShell(e,t)},innerToCAG:function(){if(!this.closed)throw new Error("The path should be closed!");return o.fromPoints(this.points)},transform:function(e){var t=this.points.map(function(t){return t.multiply4x4(e)});return new n.Path2D(t,this.closed)},appendBezier:function(e,t){if(arguments.length<2&&(t={}),this.closed)throw new Error("Path must not be closed");if(!(e instanceof Array))throw new Error("appendBezier: should pass an array of control points");if(e.length<1)throw new Error("appendBezier: need at least 1 control point");if(this.points.length<1)throw new Error("appendBezier: path must already contain a point (the endpoint of the path is used as the starting point for the bezier curve)");var r=n.parseOptionAsInt(t,"resolution",n.defaultResolution2D);r<4&&(r=4);var o=[],i=[];i.push(this.points[this.points.length-1]);for(var s=0;s<e.length;++s){var a=e[s];if(null===a){if(0!=s)throw new Error("appendBezier: null can only be passed as the first control point");if(e.length<2)throw new Error("appendBezier: null can only be passed if there is at least one more control point");var l;if("lastBezierControlPoint"in this)l=this.lastBezierControlPoint;else{if(this.points.length<2)throw new Error("appendBezier: null is passed as a control point but this requires a previous bezier curve or at least two points in the existing path");l=this.points[this.points.length-2]}a=this.points[this.points.length-1].times(2).minus(l)}else a=new n.Vector2D(a);i.push(a)}var h=i.length-1,c=1;for(s=0;s<=h;++s)s>0&&(c*=s),o.push(c);var u=[];for(s=0;s<=h;++s){var p=o[h]/(o[s]*o[h-s]);u.push(p)}var f=function(e){for(var t=1,r=Math.pow(1-e,h),o=1!=e?1/(1-e):1,s=new n.Vector2D(0,0),a=0;a<=h;++a){a==h&&(r=1);var l=u[a]*t*r;s=s.plus(i[a].times(l)),t*=e,r*=o}return s},d=[],g=[],m=h+1;for(s=0;s<m;++s){var v=s/(m-1),x=f(v);d.push(x),g.push(v)}for(var y=1,w=2*Math.PI/r,P=Math.sin(w);y<d.length-1;){var _=d[y].minus(d[y-1]).unit(),V=d[y+1].minus(d[y]).unit(),D=_.cross(V);if(Math.abs(D)>P){var b=g[y-1],C=g[y+1],S=b+1*(C-b)/3,O=b+2*(C-b)/3,M=f(S),T=f(O);d.splice(y,1,M,T),g.splice(y,1,S,O),--y<1&&(y=1)}else++y}d=this.points.concat(d.slice(1));var A=new n.Path2D(d);return A.lastBezierControlPoint=i[i.length-2],A},appendArc:function(e,t){var r=1e5;if(arguments.length<2&&(t={}),this.closed)throw new Error("Path must not be closed");if(this.points.length<1)throw new Error("appendArc: path must already contain a point (the endpoint of the path is used as the starting point for the arc)");var o,i,s=n.parseOptionAsInt(t,"resolution",n.defaultResolution2D);if(s<4&&(s=4),"xradius"in t||"yradius"in t){if("radius"in t)throw new Error("Should either give an xradius and yradius parameter, or a radius parameter");o=n.parseOptionAsFloat(t,"xradius",0),i=n.parseOptionAsFloat(t,"yradius",0)}else i=o=n.parseOptionAsFloat(t,"radius",0);var a=n.parseOptionAsFloat(t,"xaxisrotation",0),l=n.parseOptionAsBool(t,"clockwise",!1),h=n.parseOptionAsBool(t,"large",!1),c=this.points[this.points.length-1];e=new n.Vector2D(e),o=Math.round(o*r)/r,i=Math.round(i*r)/r,e=new n.Vector2D(Math.round(e.x*r)/r,Math.round(e.y*r)/r);var u=!l,p=[];if(0==o||0==i)p.push(e);else{o=Math.abs(o),i=Math.abs(i);var f=a*Math.PI/180,d=Math.cos(f),g=Math.sin(f),m=c.minus(e).times(.5),v=Math.round((d*m.x+g*m.y)*r)/r,x=Math.round((-g*m.x+d*m.y)*r)/r,y=new n.Vector2D(v,x),w=y.x*y.x/(o*o)+y.y*y.y/(i*i);if(w>1){var P=Math.sqrt(w);o*=P,i*=P,o=Math.round(o*r)/r,i=Math.round(i*r)/r}var _=Math.sqrt((o*o*i*i-o*o*y.y*y.y-i*i*y.x*y.x)/(o*o*y.y*y.y+i*i*y.x*y.x));u==h&&(_=-_);var V=new n.Vector2D(o*y.y/i,-i*y.x/o).times(_),D=new n.Vector2D(d*V.x-g*V.y,g*V.x+d*V.y).plus(c.plus(e).times(.5)),b=new n.Vector2D((y.x-V.x)/o,(y.y-V.y)/i),C=new n.Vector2D((-y.x-V.x)/o,(-y.y-V.y)/i),S=b.angleRadians(),O=C.angleRadians()-S;O%=2*Math.PI,!u&&O>0?O-=2*Math.PI:u&&O<0&&(O+=2*Math.PI);var M=Math.ceil(Math.abs(O)/(2*Math.PI)*s)+1;M<1&&(M=1);for(var T=1;T<=M;T++){var A=S+T/M*O,z=Math.cos(A),E=Math.sin(A),F=new n.Vector2D(d*o*z-g*i*E,g*o*z+d*i*E).plus(D);p.push(F)}}return p=this.points.concat(p),new n.Path2D(p)}},n.addTransformationMethodsToPrototype=function(e){e.mirrored=function(e){return this.transform(n.Matrix4x4.mirroring(e))},e.mirroredX=function(){var e=new n.Plane(n.Vector3D.Create(1,0,0),0);return this.mirrored(e)},e.mirroredY=function(){var e=new n.Plane(n.Vector3D.Create(0,1,0),0);return this.mirrored(e)},e.mirroredZ=function(){var e=new n.Plane(n.Vector3D.Create(0,0,1),0);return this.mirrored(e)},e.tr=function(e){return this.transform(n.Matrix4x4.translation(e))},e.scale=function(e){return this.transform(n.Matrix4x4.scaling(e))},e.rX=function(e){return this.transform(n.Matrix4x4.rotationX(e))},e.rY=function(e){return this.transform(n.Matrix4x4.rotationY(e))},e.rZ=function(e){return this.transform(n.Matrix4x4.rotationZ(e))},e.rotate=function(e,t,r){return this.transform(n.Matrix4x4.rotation(e,t,r))},e.rotateEulerAngles=function(e,t,r,o){o=o||[0,0,0];var i=n.Matrix4x4.rotationZ(e),s=n.Matrix4x4.rotationX(t),a=n.Matrix4x4.rotationZ(r),l=n.Matrix4x4.translation(new n.Vector3D(o));return this.transform(a.multiply(s).multiply(i).multiply(l))}},n.addCenteringToPrototype=function(e,t){e.center=function(e){(e=Array.prototype.map.call(arguments,function(e){return e})).length||(e=t.slice());var n=this.getBounds();return this.tr(t.map(function(t){return e.indexOf(t)>-1?-(n[0][t]+n[1][t])/2:0}))}};var o=function(){this.sides=[],this.isCanonicalized=!1};function i(e,t){return e.index-t.index}o.fromObject=function(e){var t=e.sides.map(function(e){return o.Side.fromObject(e)});return o.fromSides(t)},o.fromSides=function(e){var t=new o;return t.sides=e,t},o.fromPoints=function(e){var t=e.length;if(t<3)throw new Error("CAG shape needs at least 3 points");var r=[],i=new n.Vector2D(e[t-1]),s=new o.Vertex(i);e.map(function(e){var t=new n.Vector2D(e),i=new o.Vertex(t),a=new o.Side(s,i);r.push(a),s=i});var a=o.fromSides(r);if(a.isSelfIntersecting())throw new Error("Polygon is self intersecting!");var l=a.area();if(Math.abs(l)<1e-5)throw new Error("Degenerate polygon!");return l<0&&(a=a.flipped()),a=a.canonicalized()},o.fromPointsNoCheck=function(e){var t=[],r=new n.Vector2D(e[e.length-1]),i=new o.Vertex(r);return e.map(function(e){var r=new n.Vector2D(e),s=new o.Vertex(r),a=new o.Side(i,s);t.push(a),i=s}),o.fromSides(t)},o.fromFakeCSG=function(e){var t=e.polygons.map(function(e){return o.Side._fromFakePolygon(e)}).filter(function(e){return null!==e});return o.fromSides(t)},o.linesIntersect=function(e,t,r,o){if(t.equals(r)||o.equals(e)){if(o.minus(r).unit().plus(t.minus(e).unit()).length()<1e-5)return!0}else{var i=t.minus(e),s=o.minus(r);if(Math.abs(i.cross(s))<1e-9)return!1;var a=n.solve2Linear(-i.x,s.x,-i.y,s.y,e.x-r.x,e.y-r.y);if(a[0]>1e-6&&a[0]<.999999&&a[1]>1e-5&&a[1]<.999999)return!0}return!1},o.circle=function(e){e=e||{};var t,r=n.parseOptionAs2DVector(e,"center",[0,0]),i=n.parseOptionAsFloat(e,"radius",1),s=n.parseOptionAsInt(e,"resolution",n.defaultResolution2D),a=[];if(i<0)throw new Error("Radius should be positive.");if(i<5e-4)return new o;for(var l=0;l<=s;l++){var h=2*Math.PI*l/s,c=n.Vector2D.fromAngleRadians(h).times(i).plus(r),u=new o.Vertex(c);l>0&&a.push(new o.Side(t,u)),t=u}return o.fromSides(a)},o.ellipse=function(e){e=e||{};var t=n.parseOptionAs2DVector(e,"center",[0,0]),r=n.parseOptionAs2DVector(e,"radius",[1,1]);r=r.abs();var o=n.parseOptionAsInt(e,"resolution",n.defaultResolution2D),i=new n.Path2D([[t.x,t.y+r.y]]);return(i=(i=(i=i.appendArc([t.x,t.y-r.y],{xradius:r.x,yradius:r.y,xaxisrotation:0,resolution:o,clockwise:!0,large:!1})).appendArc([t.x,t.y+r.y],{xradius:r.x,yradius:r.y,xaxisrotation:0,resolution:o,clockwise:!0,large:!1})).close()).innerToCAG()},o.rectangle=function(e){var t,r;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("rectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs2DVector(e,"corner1",[0,0]),corner2=n.parseOptionAs2DVector(e,"corner2",[1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs2DVector(e,"center",[0,0]),r=n.parseOptionAs2DVector(e,"radius",[1,1]);if(r.x<0||r.y<0)throw new Error("Dimension should be positive.");if(r.x<5e-4||r.y<5e-4)return console.log("Throwing out a zero-length rectangle."),new o;var i=new n.Vector2D(r.x,-r.y),s=[t.plus(r),t.plus(i),t.minus(r),t.minus(i)];return o.fromPoints(s)},o.roundedRectangle=function(e){var t,r;if("corner1"in(e=e||{})||"corner2"in e){if("center"in e||"radius"in e)throw new Error("roundedRectangle: should either give a radius and center parameter, or a corner1 and corner2 parameter");corner1=n.parseOptionAs2DVector(e,"corner1",[0,0]),corner2=n.parseOptionAs2DVector(e,"corner2",[1,1]),t=corner1.plus(corner2).times(.5),r=corner2.minus(corner1).times(.5)}else t=n.parseOptionAs2DVector(e,"center",[0,0]),r=n.parseOptionAs2DVector(e,"radius",[1,1]);r=r.abs();var i=n.parseOptionAsFloat(e,"roundradius",.2),s=n.parseOptionAsInt(e,"resolution",n.defaultResolution2D),a=Math.min(r.x,r.y);a-=.1,i=Math.min(i,a),i=Math.max(0,i),r=new n.Vector2D(r.x-i,r.y-i);var l=o.rectangle({center:t,radius:r});return i>0&&(l=l.expand(i,s)),l},o.fromCompactBinary=function(e){if("CAG"!=e.class)throw new Error("Not a CAG");for(var t=[],r=e.vertexData,i=r.length/2,s=0,a=0;a<i;a++){var l=r[s++],h=r[s++],c=new n.Vector2D(l,h),u=new o.Vertex(c);t.push(u)}var p=[],f=e.sideVertexIndices.length/2;s=0;for(var d=0;d<f;d++){var g=e.sideVertexIndices[s++],m=e.sideVertexIndices[s++],v=new o.Side(t[g],t[m]);p.push(v)}var x=o.fromSides(p);return x.isCanonicalized=!0,x},o.prototype={toString:function(){var e="CAG ("+this.sides.length+" sides):\n";return this.sides.map(function(t){e+="  "+t.toString()+"\n"}),e},_toCSGWall:function(e,t){var r=this.sides.map(function(n){return n.toPolygon3D(e,t)});return n.fromPolygons(r)},_toVector3DPairs:function(e){var t=this.sides.map(function(e){var t=e.vertex0.pos,r=e.vertex1.pos;return[n.Vector3D.Create(t.x,t.y,0),n.Vector3D.Create(r.x,r.y,0)]});return void 0!==e&&(t=t.map(function(t){return t.map(function(t){return t.transform(e)})})),t},_toPlanePolygons:function(e){var t=e.flipped||!1,r=[0,0,0],o=[0,0,1],i=[0,1,0],s=new n.Connector(r,o,i),a=e.translation||r,l=e.axisVector||o,h=e.normalVector||i,c=e.toConnector||new n.Connector(a,l,h),u=s.getTransformationTo(c,!1,0),p=this.getBounds();p[0]=p[0].minus(new n.Vector2D(1,1)),p[1]=p[1].plus(new n.Vector2D(1,1));var f=this._toCSGWall(-1,1),d=n.fromPolygons([new n.Polygon([new n.Vertex(new n.Vector3D(p[0].x,p[0].y,0)),new n.Vertex(new n.Vector3D(p[1].x,p[0].y,0)),new n.Vertex(new n.Vector3D(p[1].x,p[1].y,0)),new n.Vertex(new n.Vector3D(p[0].x,p[1].y,0))])]);return t&&(d=d.invert()),(d=d.intersectSub(f)).polygons.filter(function(e){return Math.abs(e.plane.normal.z)>.99}).map(function(e){return e.transform(u)})},_toWallPolygons:function(e){var t=new n.Connector([0,0,0],[0,0,1],[0,1,0]),r=e.toConnector1,o=e.toConnector2;if(!(r instanceof n.Connector&&o instanceof n.Connector))throw"could not parse CSG.Connector arguments toConnector1 or toConnector2";if(e.cag&&e.cag.sides.length!=this.sides.length)throw"target cag needs same sides count as start cag";var i=e.cag||this,s=t.getTransformationTo(r,!1,0),a=t.getTransformationTo(o,!1,0),l=this._toVector3DPairs(s),h=i._toVector3DPairs(a),c=[];return l.forEach(function(e,t){c.push(new n.Polygon([new n.Vertex(h[t][1]),new n.Vertex(h[t][0]),new n.Vertex(e[0])])),c.push(new n.Polygon([new n.Vertex(h[t][1]),new n.Vertex(e[0]),new n.Vertex(e[1])]))}),c},union:function(e){var t;t=e instanceof Array?e:[e];var n=(n=this._toCSGWall(-1,1)).union(t.map(function(e){return e._toCSGWall(-1,1).reTesselated()}),!1,!1);return o.fromFakeCSG(n).canonicalized()},subtract:function(e){var t;t=e instanceof Array?e:[e];var n=this._toCSGWall(-1,1);return t.map(function(e){n=n.subtractSub(e._toCSGWall(-1,1),!1,!1)}),n=(n=n.reTesselated()).canonicalized(),n=(n=o.fromFakeCSG(n)).canonicalized()},intersect:function(e){var t;t=e instanceof Array?e:[e];var n=this._toCSGWall(-1,1);return t.map(function(e){n=n.intersectSub(e._toCSGWall(-1,1),!1,!1)}),n=(n=n.reTesselated()).canonicalized(),n=(n=o.fromFakeCSG(n)).canonicalized()},transform:function(e){var t=e.isMirroring(),n=this.sides.map(function(t){return t.transform(e)}),r=o.fromSides(n);return t&&(r=r.flipped()),r},taper:function(e,t){t<=0&&(t=1e-4);var r=this.getBounds(),i=0,s=0;e[0]?(i=r[1].x-r[0].x,s=r[0].x):(i=r[1].y-r[0].y,s=r[0].y);for(var a=[],l=[],h=0;h<this.sides.length;h++){var c=this.sides[h];e[0]&&(l[0]=[c.vertex0.pos.x,c.vertex0.pos.y*(1+(t-1)*(c.vertex0.pos.x-s)/i)],l[1]=[c.vertex1.pos.x,c.vertex1.pos.y*(1+(t-1)*(c.vertex1.pos.x-s)/i)]),e[1]&&(l[0]=[c.vertex0.pos.x*(1+(t-1)*(c.vertex0.pos.y-s)/i),c.vertex0.pos.y],l[1]=[c.vertex1.pos.x*(1+(t-1)*(c.vertex1.pos.y-s)/i),c.vertex1.pos.y]);var u=new o.Side(new o.Vertex(new n.Vector2D(l[0])),new o.Vertex(new n.Vector2D(l[1])));a.push(u)}return o.fromSides(a)},area:function(){var e=0;return this.sides.map(function(t){e+=t.vertex0.pos.cross(t.vertex1.pos)}),e*=.5},flipped:function(){var e=this.sides.map(function(e){return e.flipped()});return e.reverse(),o.fromSides(e)},getBounds:function(){var e,t=e=0===this.sides.length?new n.Vector2D(0,0):this.sides[0].vertex0.pos;return this.sides.map(function(n){e=(e=e.min(n.vertex0.pos)).min(n.vertex1.pos),t=(t=t.max(n.vertex0.pos)).max(n.vertex1.pos)}),[e,t]},isSelfIntersecting:function(e){for(var t=this.sides.length,n=0;n<t;n++)for(var r=this.sides[n],i=n+1;i<t;i++){var s=this.sides[i];if(o.linesIntersect(r.vertex0.pos,r.vertex1.pos,s.vertex0.pos,s.vertex1.pos))return e&&(OpenJsCad.log(r),OpenJsCad.log(s)),!0}return!1},expandedShell:function(e,t){(t=t||8)<4&&(t=4);var r=[],i={},s=this.canonicalized();for(var a in s.sides.map(function(t){var n=t.vertex1.pos.minus(t.vertex0.pos),s=n.length();if(s>1e-5){var a=(n=n.times(1/s)).normal().times(e),l=[t.vertex1.pos.plus(a),t.vertex1.pos.minus(a),t.vertex0.pos.minus(a),t.vertex0.pos.plus(a)],h=o.fromPoints(l);r.push(h);for(var c=0;c<2;c++){var u=0===c?t.vertex0.pos:t.vertex1.pos,p=0===c?t.vertex1.pos:t.vertex0.pos,f=u.x+" "+u.y;f in i||(i[f]=[]),i[f].push({p1:u,p2:p})}}}),i){var l,h,c=i[a],u=c[0].p1;if(2==c.length){var p=c[0].p2,f=c[1].p2;if(l=p.minus(u).angleDegrees(),(h=f.minus(u).angleDegrees())<l&&(h+=360),h>=l+360&&(h-=360),h<l+180){var d=h;h=l+360,l=d}l+=90,h-=90}else l=0,h=360;var g=h>l+359.999;if(g&&(l=0,h=360),h>l+1e-5){var m=[];g||m.push(u);var v=Math.round(t*(h-l)/360);v<1&&(v=1);for(var x=0;x<=v;x++){var y=l+x/v*(h-l);x==v&&(y=h);var w=u.plus(n.Vector2D.fromAngleDegrees(y).times(e));(!g||x>0)&&m.push(w)}var P=o.fromPointsNoCheck(m);r.push(P)}}var _=new o;return _=_.union(r)},expand:function(e,t){return this.union(this.expandedShell(e,t))},contract:function(e,t){return this.subtract(this.expandedShell(e,t))},extrudeInOrthonormalBasis:function(e,t){if(!(e instanceof n.OrthoNormalBasis))throw new Error("extrudeInPlane: the first parameter should be a CSG.OrthoNormalBasis");var r=this.extrude({offset:[0,0,t]}),o=e.getInverseProjectionMatrix();return r=r.transform(o)},extrudeInPlane:function(e,t,r){return this.extrudeInOrthonormalBasis(n.OrthoNormalBasis.GetCartesian(e,t),r)},extrude:function(e){if(0==this.sides.length)return new n;var t=n.parseOptionAs3DVector(e,"offset",[0,0,1]),r=n.parseOptionAsFloat(e,"twistangle",0),o=n.parseOptionAsInt(e,"twiststeps",n.defaultResolution3D),i=n.parseOptionAs2DVector(e,"scale",[1,1]),s=i.x,a=i.y;if(s<1e-4&&(s=1e-4),a<1e-4&&(a=1e-4),0==t.z)throw"offset cannot be orthogonal to Z axis";(0==r||o<1)&&(o=1);var l=n.Vector3D.Create(0,1,0),h=[];h=(h=h.concat(this._toPlanePolygons({translation:[0,0,0],normalVector:l,flipped:!(t.z<0)}))).concat(this._toPlanePolygons({translation:t,normalVector:l.rZ(r),flipped:t.z<0}));for(var c=0;c<o;c++){var u=new n.Connector(t.times(c/o),[0,0,t.z],l.rZ(c*r/o)),p=new n.Connector(t.times((c+1)/o),[0,0,t.z],l.rZ((c+1)*r/o));h=h.concat(this._toWallPolygons({toConnector1:u,toConnector2:p}))}var f=[],d=[];for(c=0;c<h.length;c++){d=[];for(var g=0;g<h[c].vertices.length;g++){var m=h[c].vertices[g].pos.z,v=h[c].vertices[g].pos._x*(1+(s-1)*m/t.z),x=h[c].vertices[g].pos._y*(1+(a-1)*m/t.z);d[g]=[v,x,m]}f[c]=new n.Polygon.createFromPoints(d),f[c].shared=h[c].shared}return n.fromPolygons(f)},rotateExtrude:function(e){var t=n.parseOptionAsFloat(e,"angle",360),r=n.parseOptionAsInt(e,"resolution",n.defaultResolution3D);t=t>360?t%360:t;var o=[0,0,0],i=n.Vector3D.Create(0,1,0),s=[0,0,1],a=[],l=new n.Connector(o,i,s);if(t>0&&t<360){var h=new n.Connector(o,i.rZ(-t),s);a=(a=a.concat(this._toPlanePolygons({toConnector:l,flipped:!0}))).concat(this._toPlanePolygons({toConnector:h}))}for(var c,u=l,p=t/r,f=p;f<=t+1e-5;f+=p)c=new n.Connector(o,i.rZ(-f),s),a=a.concat(this._toWallPolygons({toConnector1:u,toConnector2:c})),u=c;return n.fromPolygons(a).reTesselated()},rotate_extrude:function(e){if(0==this.sides.length)return new n;var t=n.parseOptionAsInt(e,"faces",10),r=n.parseOptionAsInt(e,"twist",0),i=Math.abs(n.parseOptionAsInt(e,"radius",0)),s=n.parseOptionAsInt(e,"tsteps",0);t<3&&(t=3);var a=Math.ceil(s/t);a<1&&(a=1);var l=o.fromPoints([[-.001,1e5],[2e5,1e5],[2e5,-1e5],[-.001,-1e5]]),h=o.fromPoints([[.001,1e5],[-2e5,1e5],[-2e5,-1e5],[.001,-1e5]]),c=this.tr([i,0,0]),u=c.subtract(l),p=c.subtract(h);if(0!=u.sides.length)var f=u.mirroredX().union(p);else f=p;f=f.tr([-i,0,0]);for(var d=[],g=0;g<t+2;g++)y=new n.Matrix4x4.rotationZ(r/360*g/t*360),d[g]=f.transform(y),d[g]=d[g].tr([i,0,0]),d[g]=d[g].canonicalized();f=f.tr([i,0,0]);var m=[];for(g=0;g<t;g++)for(var v=0;v<f.sides.length;v++){var x,y,w=[],P=[];x=new n.Matrix4x4.rotationZ(g/t*360),y=new n.Matrix4x4.rotationZ((g+1)/t*360),w[0]=new n.Vector3D(d[g].sides[v].vertex0.pos.x,0,d[g].sides[v].vertex0.pos.y),w[1]=new n.Vector3D(d[g].sides[v].vertex1.pos.x,0,d[g].sides[v].vertex1.pos.y),w[2]=new n.Vector3D(d[g+1].sides[v].vertex1.pos.x,0,d[g+1].sides[v].vertex1.pos.y),w[3]=new n.Vector3D(d[g+1].sides[v].vertex0.pos.x,0,d[g+1].sides[v].vertex0.pos.y),w[0]=x.rightMultiply1x3Vector(w[0]),w[1]=x.rightMultiply1x3Vector(w[1]),w[2]=y.rightMultiply1x3Vector(w[2]),w[3]=y.rightMultiply1x3Vector(w[3]);for(var _=(w[3]._x-w[0]._x)/a,V=(w[3]._y-w[0]._y)/a,D=(w[3]._z-w[0]._z)/a,b=(w[2]._x-w[1]._x)/a,C=(w[2]._y-w[1]._y)/a,S=(w[2]._z-w[1]._z)/a,O=0;O<a;O++){P[0]=new n.Vector3D(w[0]._x+O*_,w[0]._y+O*V,w[0]._z+O*D),P[1]=new n.Vector3D(w[1]._x+O*b,w[1]._y+O*C,w[1]._z+O*S),P[2]=new n.Vector3D(w[1]._x+(O+1)*b,w[1]._y+(O+1)*C,w[1]._z+(O+1)*S),P[3]=new n.Vector3D(w[0]._x+(O+1)*_,w[0]._y+(O+1)*V,w[0]._z+(O+1)*D);var M=new n.Polygon([new n.Vertex(P[0]),new n.Vertex(P[1]),new n.Vertex(P[2])]),T=new n.Polygon([new n.Vertex(P[0]),new n.Vertex(P[2]),new n.Vertex(P[3])]);m.push(M),m.push(T)}}var A=n.fromPolygons(m);return A=(A=A.reTesselated()).canonicalized()},hull:function(e){o.ConvexHullPoint=function(e,t,n){this.index=e,this.angle=t,this.distance=n,this.compare=function(e){return this.angle<e.angle?-1:this.angle>e.angle?1:this.distance<e.distance?-1:this.distance>e.distance?1:0}},o.ConvexHull=function(){this.points=null,this.indices=null,this.getIndices=function(){return this.indices},this.clear=function(){this.indices=null,this.points=null},this.ccw=function(e,t,n){var r=(this.points[t].x-this.points[e].x)*(this.points[n].y-this.points[e].y)-(this.points[t].y-this.points[e].y)*(this.points[n].x-this.points[e].x);return r<1e-5?0:r},this.angle=function(e,t){return Math.atan2(this.points[t].y-this.points[e].y,this.points[t].x-this.points[e].x)},this.distance=function(e,t){return(this.points[t].x-this.points[e].x)*(this.points[t].x-this.points[e].x)+(this.points[t].y-this.points[e].y)*(this.points[t].y-this.points[e].y)},this.compute=function(e){if(this.indices=null,!(e.length<3)){this.points=e;for(var t=0,n=1;n<this.points.length;n++)this.points[n].y==this.points[t].y?this.points[n].x<this.points[t].x&&(t=n):this.points[n].y<this.points[t].y&&(t=n);var r=new Array,i=0,s=0;for(n=0;n<this.points.length;n++)n!=t&&((i=this.angle(t,n))<0&&(i+=Math.PI),s=this.distance(t,n),r.push(new o.ConvexHullPoint(n,i,s)));r.sort(function(e,t){return e.compare(t)});var a,l=new Array(this.points.length+1),h=2;for(n=0;n<this.points.length;n++)n!=t&&(l[h]=r[h-2].index,h++);l[0]=l[this.points.length],l[1]=t;var c=2;for(n=3;n<=this.points.length;n++){for(;this.ccw(l[c-1],l[c],l[n])<=0;)c--;c++,a=l[n],l[n]=l[c],l[c]=a}for(this.indices=new Array(c),n=0;n<c;n++)this.indices[n]=l[n+1]}}};var t=e,n=[];n.push(this);for(var r=0;r<t.length;r++)n.push(t[r]);var i=[],s=[];for(r=0;r<n.length;r++){if(!((e=n[r])instanceof o))throw"ERROR: don't mix 2D and 3D shapes in hull";for(var a=0;a<e.sides.length;a++){var l=e.sides[a].vertex0.pos.x,h=e.sides[a].vertex0.pos.y;s[l+","+h]||(i.push({x:l,y:h}),s[l+","+h]++)}}var c=new o.ConvexHull;c.compute(i);var u=c.getIndices();if(u&&u.length>0){var p=[];for(r=0;r<u.length;r++)p.push(i[u[r]]);return o.fromPoints(p)}},check:function(){var e=1e-5,t=[];this.isSelfIntersecting(!0)&&t.push("Self intersects");var n={};for(var r in this.sides.map(function(e){function t(e){var t=e.x+" "+e.y;t in n||(n[t]=0),n[t]++}t(e.vertex0.pos),t(e.vertex1.pos)}),n){var o=n[r];1&o&&t.push("Uneven number of sides ("+o+") for point "+r)}var i=this.area();if(i<e*e&&t.push("Area is "+i),t.length>0){var s="";throw t.map(function(e){s+=e+"\n"}),new Error(s)}},canonicalized:function(){if(this.isCanonicalized)return this;var e=(new o.fuzzyCAGFactory).getCAG(this);return e.isCanonicalized=!0,e},toCompactBinary:function(){var e=this.canonicalized(),t=e.sides.length,n={},r=[],o=0,i=new Uint32Array(2*t),s=0;e.sides.map(function(e){[e.vertex0,e.vertex1].map(function(e){var t,a=e.getTag();a in n?t=n[a]:(t=o++,n[a]=t,r.push(e)),i[s++]=t})});var a=new Float64Array(2*o),l=0;return r.map(function(e){var t=e.pos;a[l++]=t._x,a[l++]=t._y}),{class:"CAG",sideVertexIndices:i,vertexData:a}},getOutlinePaths:function(){var e=this.canonicalized(),t={},r={};e.sides.map(function(e){var n=e.getTag();t[n]=e;var o=e.vertex0.getTag();o in r||(r[o]=[]),r[o].push(n)});for(var o=[];;){var i=null;for(var s in r){var a=r[s];i=a[0],a.splice(0,1),0===a.length&&delete r[s];break}if(null===i)break;for(var l=[],h=t[i],c=h.vertex0.getTag();;){l.push(h.vertex0.pos);var u=h.vertex1.getTag();if(u==c)break;if(!(u in r))throw new Error("Area is not closed!");var p=r[u],f=-1;if(1==p.length)f=0;else for(var d=null,g=h.direction().angleDegrees(),m=0;m<p.length;m++){var v=p[m],x=t[v].direction().angleDegrees()-g;x<-180&&(x+=360),x>=180&&(x-=360),(f<0||x>d)&&(f=m,d=x)}var y=p[f];p.splice(f,1),0===p.length&&delete r[u],h=t[y]}var w=new n.Path2D(l,!0);o.push(w)}return o},overCutInsideCorners:function(e){var t=this.canonicalized(),r={};t.sides.map(function(e){e.vertex0.getTag()in r||(r[e.vertex0.getTag()]={pos:e.vertex0.pos,from:[],to:[]}),r[e.vertex0.getTag()].to.push(e.vertex1.pos),e.vertex1.getTag()in r||(r[e.vertex1.getTag()]={pos:e.vertex1.pos,from:[],to:[]}),r[e.vertex1.getTag()].from.push(e.vertex0.pos)});var i=[];for(var s in r){var a=r[s];if(1==a.from.length&&1==a.to.length){var l=a.from[0],h=a.pos,c=a.to[0],u=h.minus(l).unit(),p=c.minus(h).unit();if(u.cross(p)<.001){var f=p.angleRadians()-u.angleRadians()+Math.PI;f<0?f+=2*Math.PI:f>=2*Math.PI&&(f-=2*Math.PI);for(var d=p.minus(u).unit(),g=30/180*Math.PI,m=e/Math.cos(g/2),v=h.plus(d.times(m)),x=f+d.angleRadians(),y=2*(Math.PI-f),w=2*Math.ceil(y/g/2),P=[v],_=0;_<=w;_++){var V=x+_/w*y,D=n.Vector2D.fromAngleRadians(V).times(m).plus(v);P.push(D)}i.push(o.fromPoints(P))}}}return t.subtract(i)}},o.Vertex=function(e){this.pos=e},o.Vertex.fromObject=function(e){return new o.Vertex(new n.Vector2D(e.pos._x,e.pos._y))},o.Vertex.prototype={toString:function(){return"("+this.pos.x.toFixed(2)+","+this.pos.y.toFixed(2)+")"},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e}},o.Side=function(e,t){if(!(e instanceof o.Vertex))throw new Error("Assertion failed");if(!(t instanceof o.Vertex))throw new Error("Assertion failed");this.vertex0=e,this.vertex1=t},o.Side.fromObject=function(e){var t=o.Vertex.fromObject(e.vertex0),n=o.Vertex.fromObject(e.vertex1);return new o.Side(t,n)},o.Side._fromFakePolygon=function(e){if(e.vertices.forEach(function(e){if(!(e.pos.z>=-1.001&&e.pos.z<-.999||e.pos.z>=.999&&e.pos.z<1.001))throw"Assertion failed: _fromFakePolygon expects abs z values of 1"}),e.vertices.length<4)return null;var t=[],r=e.vertices.filter(function(e,n){if(e.pos.z>0)return t.push(n),!0}).map(function(e){return new n.Vector2D(e.pos.x,e.pos.y)});if(2!=r.length)throw"Assertion failed: _fromFakePolygon: not enough points found";var i=t[1]-t[0];if(1!=i&&3!=i)throw"Assertion failed: _fromFakePolygon: unknown index ordering";return 1==i&&r.reverse(),new o.Side(new o.Vertex(r[0]),new o.Vertex(r[1]))},o.Side.prototype={toString:function(){return this.vertex0+" -> "+this.vertex1},toPolygon3D:function(e,t){var r=[new n.Vertex(this.vertex0.pos.toVector3D(e)),new n.Vertex(this.vertex1.pos.toVector3D(e)),new n.Vertex(this.vertex1.pos.toVector3D(t)),new n.Vertex(this.vertex0.pos.toVector3D(t))];return new n.Polygon(r)},transform:function(e){var t=this.vertex0.pos.transform(e),n=this.vertex1.pos.transform(e);return new o.Side(new o.Vertex(t),new o.Vertex(n))},flipped:function(){return new o.Side(this.vertex1,this.vertex0)},direction:function(){return this.vertex1.pos.minus(this.vertex0.pos)},getTag:function(){var e=this.tag;return e||(e=n.getTag(),this.tag=e),e},lengthSquared:function(){var e=this.vertex1.pos.x-this.vertex0.pos.x,t=this.vertex1.pos.y-this.vertex0.pos.y;return e*e+t*t},length:function(){return Math.sqrt(this.lengthSquared())}},o.fuzzyCAGFactory=function(){this.vertexfactory=new n.fuzzyFactory(2,1e-5)},o.fuzzyCAGFactory.prototype={getVertex:function(e){var t=[e.pos._x,e.pos._y];return this.vertexfactory.lookupOrCreate(t,function(t){return e})},getSide:function(e){var t=this.getVertex(e.vertex0),n=this.getVertex(e.vertex1);return new o.Side(t,n)},getCAG:function(e){var t=this,n=e.sides.map(function(e){return t.getSide(e)}).filter(function(e){return e.length()>1e-5});return o.fromSides(n)}},n.addTransformationMethodsToPrototype(n.prototype),n.addTransformationMethodsToPrototype(n.Vector2D.prototype),n.addTransformationMethodsToPrototype(n.Vector3D.prototype),n.addTransformationMethodsToPrototype(n.Vertex.prototype),n.addTransformationMethodsToPrototype(n.Plane.prototype),n.addTransformationMethodsToPrototype(n.Polygon.prototype),n.addTransformationMethodsToPrototype(n.Line3D.prototype),n.addTransformationMethodsToPrototype(n.Connector.prototype),n.addTransformationMethodsToPrototype(n.Path2D.prototype),n.addTransformationMethodsToPrototype(n.Line2D.prototype),n.addTransformationMethodsToPrototype(o.prototype),n.addTransformationMethodsToPrototype(o.Side.prototype),n.addTransformationMethodsToPrototype(n.OrthoNormalBasis.prototype),n.addCenteringToPrototype(n.prototype,["x","y","z"]),n.addCenteringToPrototype(o.prototype,["x","y"]),n.Polygon2D=function(e){var t=o.fromPoints(e);this.sides=t.sides},n.Polygon2D.prototype=o.prototype,e.CSG=n,e.CAG=o}(this),"undefined"!=typeof module&&(CSG=require(lib+"csg.js").CSG,CAG=require(lib+"csg.js").CAG,Blob=require(lib+"Blob.js").Blob),function(e){CSG.prototype.toX3D=function(){var e={},t=[],n={};this.polygons.map(function(r){var o=0,i=0,s=1;r.shared&&r.shared.color&&(o=r.shared.color[0],i=r.shared.color[1],s=r.shared.color[2]);for(var a,l=[],h=r.vertices.length,c=0;c<h;c++)(a=r.vertices[c]).getTag()in n||(t.push(a.pos._x.toString()+" "+a.pos._y.toString()+" "+a.pos._z.toString()),n[a.getTag()]=t.length-1),l.push(n[a.getTag()]);var u=l.join(" "),p=o.toString()+" "+i.toString()+" "+s.toString();p in e||(e[p]=[]),e[p].push(u)});var r=document.implementation.createDocumentType("X3D","ISO//Web3D//DTD X3D 3.1//EN","http://www.web3d.org/specifications/x3d-3.1.dtd"),o=document.implementation.createDocument(null,"X3D",r);o.insertBefore(o.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"'),o.doctype);var i=o.getElementsByTagName("X3D")[0];i.setAttribute("profile","Interchange"),i.setAttribute("version","3.1"),i.setAttribute("xsd:noNamespaceSchemaLocation","http://www.web3d.org/specifications/x3d-3.1.xsd"),i.setAttribute("xmlns:xsd","http://www.w3.org/2001/XMLSchema-instance");var s=o.createElement("Scene");i.appendChild(s);var a=!1;for(var l in e){var h=e[l],c=o.createElement("Shape");s.appendChild(c);var u=o.createElement("Appearance");c.appendChild(u);var p=o.createElement("Material");u.appendChild(p),p.setAttribute("diffuseColor",l),p.setAttribute("ambientIntensity","1.0");var f=o.createElement("IndexedFaceSet");c.appendChild(f),f.setAttribute("solid","true"),f.setAttribute("coordIndex",h.join(" -1 ")+" -1");var d=o.createElement("Coordinate");f.appendChild(d),a?d.setAttribute("USE","coords_mesh"):(d.setAttribute("DEF","coords_mesh"),d.setAttribute("point",t.join(" ")),a=!0)}var g=(new XMLSerializer).serializeToString(o);return new Blob([g],{type:"model/x3d+xml"})},CSG.prototype.toStlBinary=function(){var e=new ArrayBuffer(4),t=new Int32Array(e,0,1),n=new Int8Array(e,0,4);if(t[0]=287454020,68!=n[0])throw new Error("Binary STL output is currently only supported on little-endian (Intel) processors");var r=0;this.polygons.map(function(e){var t=e.vertices.length;r+=t>=3?t-2:0});for(var o=new Uint8Array(80),i=0;i<80;i++)o[i]=65;var s=new Uint32Array(1);s[0]=r;var a=new ArrayBuffer(50*r),l=new Int8Array(a),h=new ArrayBuffer(50),c=new Int8Array(h),u=new Float32Array(h,0,12),p=new Uint16Array(h,48,1),f=0;return this.polygons.map(function(e){for(var t=e.vertices.length,n=0;n<t-2;n++){var r=e.plane.normal;u[0]=r._x,u[1]=r._y,u[2]=r._z;for(var o=3,i=0;i<3;i++){var s=i+(i>0?n:0),a=e.vertices[s].pos;u[o++]=a._x,u[o++]=a._y,u[o++]=a._z}p[0]=0,l.set(c,f),f+=50}}),new Blob([o.buffer,s.buffer,a],{type:"application/sla"})},CSG.prototype.toStlString=function(){var e="solid csg.js\n";return this.polygons.map(function(t){e+=t.toStlString()}),e+="endsolid csg.js\n",new Blob([e],{type:"application/sla"})},CSG.Vector3D.prototype.toStlString=function(){return this._x+" "+this._y+" "+this._z},CSG.Vertex.prototype.toStlString=function(){return"vertex "+this.pos.toStlString()+"\n"},CSG.Polygon.prototype.toStlString=function(){var e="";if(this.vertices.length>=3)for(var t=this.vertices[0].toStlString(),n=0;n<this.vertices.length-2;n++)e+="facet normal "+this.plane.normal.toStlString()+"\nouter loop\n",e+=t,e+=this.vertices[n+1].toStlString(),e+=this.vertices[n+2].toStlString(),e+="endloop\nendfacet\n";return e},CSG.prototype.toObj=function(){for(var e="# OBJ file\n",t={},n="",r={},o=1,i=0,s=0,a=0,l=1,h=null,c="",u="",p=0;p<this.polygons.length;p++){(h=this.polygons[p]).shared&&h.shared.color?(i=255*h.shared.color[0],s=255*h.shared.color[1],a=255*h.shared.color[2],h.shared.color[3]&&(l=h.shared.color[3])):(i=0,s=0,a=0,l=0),r[u=i.toFixed(0)+"-"+s.toFixed(0)+"-"+a.toFixed(0)+"-"+l.toFixed(0)]||(r[u]=""),r[u]+="f ";for(var f=0;f<this.polygons[p].vertices.length;f++){var d=h.vertices[f];t[c="v "+d.pos._x+" "+d.pos._y+" "+d.pos._z+"\n"]?r[u]+=t[c]+" ":(t[c]=o.toString(),n+=c,r[u]+=o.toString()+" ",o++)}r[u]+="\n"}for(p in e+=n,r)e+="g "+p+"\n",e+=r[p];return e},CAG.PathsToDxf=function(e){var t="999\nDXF generated by OpenJsCad\n";return t+="  0\nSECTION\n  2\nHEADER\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nTABLES\n",t+="  0\nTABLE\n  2\nLTYPE\n  70\n1\n",t+="  0\nLTYPE\n  2\nCONTINUOUS\n  3\nSolid Line\n  72\n65\n  73\n0\n  40\n0.0\n",t+="  0\nENDTAB\n",t+="  0\nTABLE\n  2\nLAYER\n  70\n1\n",t+="  0\nLAYER\n  2\nOpenJsCad\n  62\n7\n  6\ncontinuous\n",t+="  0\nENDTAB\n",t+="  0\nTABLE\n  2\nSTYLE\n  70\n0\n  0\nENDTAB\n",t+="  0\nTABLE\n  2\nVIEW\n  70\n0\n  0\nENDTAB\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nBLOCKS\n",t+="  0\nENDSEC\n",t+="  0\nSECTION\n  2\nENTITIES\n",e.map(function(e){var n=e.points.length+(e.closed?1:0);t+="  0\nLWPOLYLINE\n  8\nOpenJsCad\n  90\n"+n+"\n  70\n"+(e.closed?1:0)+"\n";for(var r=0;r<n;r++){var o=r;o>=e.points.length&&(o-=e.points.length);var i=e.points[o];t+=" 10\n"+i.x+"\n 20\n"+i.y+"\n 30\n0.0\n"}}),t+="  0\nENDSEC\n  0\nEOF\n",new Blob([t],{type:"application/dxf"})},CAG.prototype.toDxf=function(){var e=this.getOutlinePaths();return CAG.PathsToDxf(e)},CSG.prototype.toAMFString=function(e){var t='<?xml version="1.0" encoding="UTF-8"?>\n<amf'+(e&&e.unit?' unit="+m.unit"':"")+">\n";for(var n in e)t+='<metadata type="'+n+'">'+e[n]+"</metadata>\n";t+='<object id="0">\n<mesh>\n<vertices>\n',this.polygons.map(function(e){for(var n=0;n<e.vertices.length;n++)t+=e.vertices[n].toAMFString()}),t+="</vertices>\n";var r=0;return this.polygons.map(function(e){if(t+="<volume>\n",!(e.vertices.length<3)){var n=1,o=.4,i=1,s=1;e.shared&&e.shared.color?(n=e.shared.color[0],o=e.shared.color[1],i=e.shared.color[2],s=e.shared.color[3],!0):e.color&&(n=e.color[0],o=e.color[1],i=e.color[2],e.color.length()>3&&(s=e.color[3]),!0),t+="<color><r>"+n+"</r><g>"+o+"</g><b>"+i+"</b>"+(void 0!==s?"<a>"+s+"</a>":"")+"</color>";for(var a=0;a<e.vertices.length-2;a++)t+="<triangle>",t+="<v1>"+r+"</v1>",t+="<v2>"+(r+a+1)+"</v2>",t+="<v3>"+(r+a+2)+"</v3>",t+="</triangle>\n";r+=e.vertices.length,t+="</volume>\n"}}),t+="</mesh>\n</object>\n",t+="</amf>\n",new Blob([t],{type:"application/amf+xml"})},CSG.Vector3D.prototype.toAMFString=function(){return"<x>"+this._x+"</x><y>"+this._y+"</y><z>"+this._z+"</z>"},CSG.Vertex.prototype.toAMFString=function(){return"<vertex><coordinates>"+this.pos.toAMFString()+"</coordinates></vertex>\n"},e.CSG=CSG,e.CAG=CAG}(this);